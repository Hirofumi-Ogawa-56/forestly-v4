app/mailers/application_mailer.rb
--- START OF FILE ---
class ApplicationMailer < ActionMailer::Base
  default from: "from@example.com"
  layout "mailer"
end
-e \n--- END OF FILE ---\n
app/models/room_message.rb
--- START OF FILE ---
# app/models/room_message.rb
class RoomMessage < ApplicationRecord
  # Activityとの紐付け（実体側）
  has_one :activity, as: :actable, dependent: :destroy

  # バリデーション
  validates :content, presence: true
end
-e \n--- END OF FILE ---\n
app/models/note.rb
--- START OF FILE ---
# app/models/note.rb
class Note < ApplicationRecord
  has_one :work, as: :actable, dependent: :destroy
  has_one :activity, through: :work

  # Googleドキュメント風のリッチテキストを扱う（画像添付も可能）
  has_rich_text :content
end
-e \n--- END OF FILE ---\n
app/models/social_repost.rb
--- START OF FILE ---
# app/models/social_repost.rb
class SocialRepost < SocialPost
  # 元の投稿へのリレーション
  belongs_to :source_post, class_name: "SocialPost", foreign_key: "source_post_id"

  # リポストなので、元ネタ（source_post_id）は必須
  validates :source_post_id, presence: true
end
-e \n--- END OF FILE ---\n
app/models/task_assignee.rb
--- START OF FILE ---
class TaskAssignee < ApplicationRecord
  belongs_to :task
  belongs_to :profile
end
-e \n--- END OF FILE ---\n
app/models/schedule.rb
--- START OF FILE ---
# app/models/schedule.rb
class Schedule < ApplicationRecord
  # Activityとのポリモーフィック関連
  has_one :activity, as: :actable, dependent: :destroy
  accepts_nested_attributes_for :activity

  # 招待ユーザー（複数）との紐付け
  has_many :schedule_invitations, dependent: :destroy
  has_many :invitees, through: :schedule_invitations, source: :profile

  # ステータスの定義（設計通り）
  enum :schedule_status, {
    confirmed: "confirmed",
    suggestion: "suggestion",
    canceled: "canceled"
  }, default: :confirmed, prefix: true
end
-e \n--- END OF FILE ---\n
app/models/work.rb
--- START OF FILE ---
# app/models/work.rb
class Work < ApplicationRecord
  # Note, Table, Book などがここに紐付く
  belongs_to :actable, polymorphic: true, dependent: :destroy

  # Activity 側からの入り口
  has_one :activity, as: :actable, dependent: :destroy
  accepts_nested_attributes_for :activity
end
-e \n--- END OF FILE ---\n
app/models/team_membership_request.rb
--- START OF FILE ---
class TeamMembershipRequest < ApplicationRecord
  belongs_to :team
  belongs_to :profile

  enum :status, { pending: 0, accepted: 1, rejected: 2, canceled: 3 }
  enum :role, { member: 0, admin: 1 }
end
-e \n--- END OF FILE ---\n
app/models/schedule_invitation.rb
--- START OF FILE ---
# app/models/schedule_invitation.rb
class ScheduleInvitation < ApplicationRecord
  belongs_to :schedule
  belongs_to :profile

  # 招待の状態 (主催者側)
  enum :invitation_status, {
    pending: "pending",
    suggestion: "suggestion",
    confirmed: "confirmed",
    canceled: "canceled"
  }, default: :pending, prefix: true

  # 参加の回答 (招待された側)
  enum :join_status, {
    pending: "pending",
    approved: "approved",
    rejected: "rejected"
  }, default: :pending, prefix: true
end
-e \n--- END OF FILE ---\n
app/models/like.rb
--- START OF FILE ---
# app/models/like.rb
class Like < ApplicationRecord
  has_one :activity, as: :actable, dependent: :destroy
end
-e \n--- END OF FILE ---\n
app/models/activity.rb
--- START OF FILE ---
# app/models/activity.rb
class Activity < ApplicationRecord
  belongs_to :owner_profile, class_name: "Profile"
  belongs_to :team, optional: true
  belongs_to :actable, polymorphic: true, dependent: :destroy
  belongs_to :chat_room, optional: true
  belongs_to :task, foreign_key: :actable_id, optional: true
  belongs_to :schedule, foreign_key: :actable_id, optional: true
  belongs_to :parent_activity, class_name: "Activity", optional: true

  has_one :task_relation, -> { where(activities: { actable_type: "Task" }) },
          foreign_key: :id, primary_key: :actable_id, class_name: "Task"
  has_one :schedule_relation, -> { where(activities: { actable_type: "Schedule" }) },
          foreign_key: :id, primary_key: :actable_id, class_name: "Schedule"
  has_many :child_activities, class_name: "Activity", foreign_key: :parent_activity_id, dependent: :destroy

  # コメントといいねを簡単に取得するためのスコープ
  has_many :comment_activities, -> { where(actable_type: "Comment") },
           class_name: "Activity", foreign_key: :parent_activity_id
  has_many :like_activities, -> { where(actable_type: "Like") },
           class_name: "Activity", foreign_key: :parent_activity_id

  enum :status, { draft: 0, active: 1, archived: 2 }
  enum :visibility_range, { is_private: 0, is_team: 1, is_chat_room: 2, is_public: 3 }
  enum :permission_type, { read_only: 0, edit_only: 1 }

  validates :title, presence: true, unless: -> { actable_type.in?([ "Comment", "Like" ]) }

  scope :room_messages, -> { where(actable_type: "RoomMessage") }

  # 権限スコープ: 閲覧可能なレコードのみを絞り込む
  scope :visible_to, ->(profile) {
    return none unless profile

    # 自分が作成した、または公開されている、または所属チームに公開されている
    where(owner_profile: profile)
      .or(where(visibility_range: :is_public))
      .or(where(visibility_range: :is_team, team_id: profile.team_id).where.not(team_id: nil))
      .or(where(visibility_range: :is_chat_room, chat_room_id: profile.chat_rooms.select(:id)))
  }

  def editable_by?(profile)
    # 1. オーナーなら無条件でOK
    return true if owner_profile == profile

    # 2. 権限設定が「閲覧のみ(read_only)」ならNG
    return false if permission_type == "read_only"

    # 3. 公開範囲（visibility_range）のチェック
    case visibility_range
    when "is_team"
      owner_profile.team_id == profile.team_id
    when "is_chat_room"
      chat_room&.profiles&.include?(profile)
    else
      false
    end
  end

  # 単一のプロフィールに対して表示可能かを判定
  def visible_to?(profile)
    return false unless profile

    owner_profile == profile ||
    visibility_range == "is_public" ||
    (visibility_range == "is_team" && team_id == profile.team_id && team_id.present?) ||
    (visibility_range == "is_chat_room" && chat_room&.profiles&.include?(profile))
  end

  def comments_count
    comment_activities.count
  end

  def likes_count
    like_activities.count
  end
end
-e \n--- END OF FILE ---\n
app/models/team.rb
--- START OF FILE ---
class Team < ApplicationRecord
  has_many :profiles
  has_many :team_membership_requests, dependent: :destroy
  has_one_attached :avatar

  enum :status, { active: 0, archived: 1 }

  validates :display_name, presence: true

  # ステータスが archived に更新されたら所属メンバーを解放する
  after_update :release_members, if: :saved_change_to_archived?

  private

  def saved_change_to_archived?
    saved_change_to_status? && archived?
  end

  def release_members
    # 所属している全プロフィールの team_id と role をリセット
    profiles.update_all(team_id: nil, team_role: nil)
  end
end
-e \n--- END OF FILE ---\n
app/models/social_post.rb
--- START OF FILE ---
# app/models/social_post.rb
class SocialPost < ApplicationRecord
  has_one :activity, as: :actable, dependent: :destroy
  has_many :reposts, class_name: "SocialRepost", foreign_key: "source_post_id"
  validates :content, presence: true, unless: -> { type == "SocialRepost" }

  delegate :status, :visibility_range, :owner_profile, :created_at, to: :activity, allow_nil: true
end
-e \n--- END OF FILE ---\n
app/models/profile.rb
--- START OF FILE ---
# app/models/profile.rb
class Profile < ApplicationRecord
  belongs_to :user
  belongs_to :team, optional: true # 所属しないプロフィールもあるため
  has_many :team_membership_requests, dependent: :destroy
  has_many :room_memberships, class_name: "RoomMembership", dependent: :destroy
  has_many :chat_rooms, through: :room_memberships, source: :chat_room
  has_one_attached :avatar

  # 概要に基づいたステータスとロール
  enum :status, { active: 0, archived: 1 }
  enum :team_role, { member: 0, admin: 1 }

  validates :label, :name, presence: true
  validates :profile_id, uniqueness: { allow_nil: true }

  before_validation :generate_profile_id

  # 招待を受け取っているリクエスト
  def pending_requests
    team_membership_requests.where(status: :pending)
  end

  private

  def generate_profile_id
    return if profile_id.present?
    # ランダムな英数字8桁（重複があれば再生成）
    self.profile_id ||= loop do
      random_id = SecureRandom.alphanumeric(8).downcase
      break random_id unless Profile.exists?(profile_id: random_id)
    end
  end
end
-e \n--- END OF FILE ---\n
app/models/comment.rb
--- START OF FILE ---
# app/models/comment.rb
class Comment < ApplicationRecord
  # Activityとのポリモーフィック関連
  has_one :activity, as: :actable, dependent: :destroy

  # 自己参照: スレッド機能（2層まで）
  belongs_to :parent, class_name: "Comment", optional: true
  has_many :replies, class_name: "Comment", foreign_key: :parent_id, dependent: :destroy

  validates :content, presence: true
  validate :thread_depth_limit

  private

  # 3層目を作らせないバリデーション
  def thread_depth_limit
    if parent.present? && parent.parent.present?
      errors.add(:base, "スレッドは2階層までです")
    end
  end
end
-e \n--- END OF FILE ---\n
app/models/room_membership.rb
--- START OF FILE ---
# app/models/room_mrmbership.rb
class RoomMembership < ApplicationRecord
  belongs_to :profile
  belongs_to :chat_room
  enum :role, { member: 0, admin: 1 }
end
-e \n--- END OF FILE ---\n
app/models/application_record.rb
--- START OF FILE ---
# app/models/application_record.rb
class ApplicationRecord < ActiveRecord::Base
  primary_abstract_class
end
-e \n--- END OF FILE ---\n
app/models/user.rb
--- START OF FILE ---
# app/models/user.rb
class User < ApplicationRecord
  devise :database_authenticatable, :registerable,
         :recoverable, :rememberable, :validatable

  has_many :profiles, dependent: :destroy
  # User作成時にProfileも一緒に作れるようにする設定
  accepts_nested_attributes_for :profiles
end
-e \n--- END OF FILE ---\n
app/models/chat_room.rb
--- START OF FILE ---
# app/models/chat_room.rb
class ChatRoom < ApplicationRecord
  has_many :room_memberships, dependent: :destroy
  has_many :profiles, through: :room_memberships
  has_many :activities, foreign_key: :chat_room_id
  has_one_attached :avatar

  enum :status, { active: 0, archived: 1 }

  attr_accessor :creator_profile_id
  after_create_commit :add_creator_as_admin

  def display_name
    super.presence || "無題のルーム"
  end

  private

  def add_creator_as_admin
    return if creator_profile_id.blank?

    room_memberships.create!(
      profile_id: creator_profile_id,
      role: :admin
    )
  end
end
-e \n--- END OF FILE ---\n
app/models/task.rb
--- START OF FILE ---
# app/models/task.rb
class Task < ApplicationRecord
  has_one :activity, as: :actable, dependent: :destroy
  accepts_nested_attributes_for :activity

  # 担当者（複数）の紐付け
  has_many :task_assignees, dependent: :destroy
  has_many :assignees, through: :task_assignees, source: :profile

  # エラー回避のため命名をDBカラムに合わせて統一
  enum :task_status, { todo: 0, in_progress: 1, done: 2, backlog: 3 }
end
-e \n--- END OF FILE ---\n
app/jobs/application_job.rb
--- START OF FILE ---
class ApplicationJob < ActiveJob::Base
  # Automatically retry jobs that encountered a deadlock
  # retry_on ActiveRecord::Deadlocked

  # Most jobs are safe to ignore if the underlying records are no longer available
  # discard_on ActiveJob::DeserializationError
end
-e \n--- END OF FILE ---\n
app/controllers/schedule_invitations_controller.rb
--- START OF FILE ---
# app/controllers/schedule_invitations_controller.rb
class ScheduleInvitationsController < ApplicationController
  before_action :authenticate_user!

  def update
    @invitation = ScheduleInvitation.find(params[:id])

    # 自分の招待のみ更新可能
    if @invitation.profile == current_profile
      if @invitation.update(invitation_params)
        redirect_to tasks_path, notice: "回答を更新しました"
      else
        redirect_to tasks_path, alert: "更新に失敗しました"
      end
    end
  end

  private

  def invitation_params
    params.require(:schedule_invitation).permit(:join_status)
  end
end
-e \n--- END OF FILE ---\n
app/controllers/application_controller.rb
--- START OF FILE ---
# app/controllers/application_controller.rb
class ApplicationController < ActionController::Base
  before_action :configure_permitted_parameters, if: :devise_controller?
  helper_method :current_profile

  def current_profile
    return @current_profile if @current_profile

    # 1. セッションに保存されたIDがあるか確認
    # 2. なければ最新のプロフィールを使用
    # 3. それもなければ nil
    if session[:current_profile_id]
      @current_profile = current_user.profiles.find_by(id: session[:current_profile_id])
    end

    @current_profile ||= current_user.profiles.first
  end

  protected

  # ログイン後に遷移するパスを指定
  def after_sign_in_path_for(resource)
    tasks_path
  end

  def configure_permitted_parameters
    # サインアップ時にprofiles_attributesを許可する
    devise_parameter_sanitizer.permit(:sign_up, keys: [ profiles_attributes: [ :label, :name, :avatar ] ])
  end
end
-e \n--- END OF FILE ---\n
app/controllers/chat_rooms_controller.rb
--- START OF FILE ---
# app/controllers/chat_rooms_controller.rb
class ChatRoomsController < ApplicationController
  before_action :authenticate_user!

  def index
    # メインコンテンツは空（またはルーム選択を促すメッセージ）
  end

  def new
    @chat_room = ChatRoom.new
  end

  def create
    @chat_room = ChatRoom.new(chat_room_params)
    # ログイン中のプロフィールIDを作成者として渡す
    @chat_room.creator_profile_id = current_profile.id

    if @chat_room.save
      redirect_to chat_rooms_path, notice: "チャットルームを作成しました"
    else
      render :new, status: :unprocessable_entity
    end
  end

  def edit
    @chat_room = ChatRoom.find(params[:id])
  end

  def update
    @chat_room = ChatRoom.find(params[:id])
    if @chat_room.update(chat_room_params)
      # 保存後に edit ページへリダイレクト（＝リロード）
      # notice に入れた文言がアラートとして表示される
      redirect_to edit_chat_room_path(@chat_room), notice: "ルーム設定を更新しました"
    else
      render :edit, status: :unprocessable_entity
    end
  end

  def show
    # 1. 「現在選択中のプロフィール」が参加しているルームの中から探す
    # RecordNotFound を防ぐため、find ではなく find_by を使います
    @chat_room = current_profile.chat_rooms.find_by(id: params[:id])

    # 2. もし見つからなかったら（参加していないルームなら）
    if @chat_room.nil?
      redirect_to chat_rooms_path, notice: "そのチャットルームには参加していないか、存在しません。"
    end

    # 見つかった場合はそのまま show.html.erb がレンダリングされます
  end


  def chat_room_params
    params.require(:chat_room).permit(:display_name, :avatar)
  end
end
-e \n--- END OF FILE ---\n
app/controllers/teams_controller.rb
--- START OF FILE ---
# app/controllers/teams_controller.rb
class TeamsController < ApplicationController
  before_action :authenticate_user!
  before_action :set_team
  before_action :ensure_admin, only: [ :edit, :update ]

  def members
    if @team
      @members = @team.profiles
      # 履歴用にすべての招待リクエストを、新しい順で取得（N+1防止のためプロフィールをincludes）
      @invitation_history = @team.team_membership_requests.includes(:profile).order(created_at: :desc)
    else
      @members = []
      @invitation_history = []
    end
  end

  def new
    @team_new = Team.new unless @team
  end

  def create
    @team_new = Team.new(team_params)

    if current_profile.team.present?
      redirect_to members_team_path, alert: "既にチームに所属しているため、作成できません。"
      return
    end

    # トランザクションで「全部成功」か「全部失敗（ロールバック）」を保証
    ActiveRecord::Base.transaction do
      # 1. チームを保存
      @team_new.save!

      # 2. 【重要】古い中途半端なリクエスト（ゴミデータ）があればこのタイミングで削除
      # これにより "Profile has already been taken" エラーを未然に防ぎます
      current_profile.team_membership_requests.destroy_all

      # 3. プロフィールをadminとして紐付け
      current_profile.update!(
        team: @team_new,
        team_role: :admin
      )

      # 全て成功した場合のみ確定してリダイレクト
      redirect_to members_team_path, notice: "チーム「#{@team_new.display_name}」を作成しました。"
    end

  rescue ActiveRecord::RecordInvalid => e
    Rails.logger.error "Validation failed for #{e.record.class}: #{e.record.errors.inspect}"
    # バリデーション失敗時：具体的になぜ失敗したかをメッセージに表示
    # 失敗時はtransactionのおかげで、作成されたチームはDBから消去（ロールバック）されます
    flash.now[:alert] = "作成に失敗しました: #{e.record.class.name} - #{e.record.errors.full_messages.join(', ')}"
    render :new, status: :unprocessable_entity
  rescue => e
    flash.now[:alert] = "予期せぬエラーが発生しました: #{e.message}"
    render :new, status: :unprocessable_entity
  end

  def edit
    # 未所属でもページ自体は見せるが、編集対象がない状態
  end

  def update
    if @team.update(team_params)
        redirect_to members_team_path, notice: "チーム情報を更新しました。"
    else
        render :edit, status: :unprocessable_entity
    end
   end

  private

  def set_team
    @team = current_profile.team
  end

  def team_params
    params.require(:team).permit(:display_name, :avatar)
  end

  def ensure_admin
    unless current_profile.admin?
        redirect_to members_team_path, alert: "管理者権限が必要です。"
    end
  end
end
-e \n--- END OF FILE ---\n
app/controllers/room_memberships_controller.rb
--- START OF FILE ---
# app/controllers/room_memberships_controller.rb
class RoomMembershipsController < ApplicationController
  before_action :authenticate_user!

  def create
    @chat_room = ChatRoom.find(params[:chat_room_id])
    # チーム機能と同様、文字列のprofile_idで検索
    @profile = Profile.find_by(profile_id: params[:profile_id].to_s.downcase)

    if @profile
      # すでにメンバーかチェック
      if @chat_room.profiles.include?(@profile)
        redirect_to edit_chat_room_path(@chat_room), alert: "既にメンバーです"
      else
        @chat_room.room_memberships.create!(profile: @profile, role: params[:role] || :member)
        redirect_to edit_chat_room_path(@chat_room), notice: "#{@profile.name}さんを追加しました"
      end
    else
      redirect_to edit_chat_room_path(@chat_room), alert: "指定されたプロフィールIDが見つかりません"
    end
  end

  def destroy
    @membership = RoomMembership.find(params[:id])
    @chat_room = @membership.chat_room
    @membership.destroy
    redirect_to edit_chat_room_path(@chat_room), notice: "メンバーを解除しました"
  end
end
-e \n--- END OF FILE ---\n
app/controllers/room_messages_controller.rb
--- START OF FILE ---
# app/controllers/room_messages_controller.rb
class RoomMessagesController < ApplicationController
  def create
    @chat_room = ChatRoom.find(params[:chat_room_id])
    @current_profile = current_profile
    target_status = params[:commit_type] == "draft" ? :draft : :active

    # --- 1. スレッドへの返信 (Comment作成) ---
    if params[:parent_activity_id].present? && target_status == :active
      @parent_activity = Activity.find(params[:parent_activity_id])
      @comment = Comment.new(content: params[:room_message][:content])

      if @comment.save
        # ChatのスレッドとしてActivityを作成
        Activity.create!(
          actable: @comment,
          owner_profile: @current_profile,
          parent_activity_id: @parent_activity.id, # ここで親メッセージと紐付け
          team_id: @parent_activity.team_id,
          status: "active",
          visibility_range: @parent_activity.visibility_range,
          title: @comment.content.truncate(20)
        )
      end
      return redirect_to chat_room_path(@chat_room, thread_id: params[:parent_activity_id])
    end

    # --- 2. 既存メッセージの編集・下書き更新 ---
    if params[:message_id].present?
      @message = RoomMessage.find(params[:message_id])
      @activity = Activity.find_by(actable: @message)

      if @activity && @activity.owner_profile == @current_profile
        update_params = { content: params[:room_message][:content] }
        update_params[:edited_at] = Time.current if target_status == :active && @activity.active?

        if @message.update(update_params)
          @activity.update(
            status: target_status,
            title: params[:room_message][:content].truncate(20)
          )
        end
      end

    # --- 3. 新規メッセージ作成 ---
    else
      @message = RoomMessage.new(content: params[:room_message][:content])
      if @message.save
        @chat_room.activities.create!(
          actable: @message,
          owner_profile: @current_profile,
          status: target_status,
          title: @message.content.truncate(20)
        )
      end
    end

    redirect_to chat_room_path(@chat_room)
  end

  def destroy
    @chat_room = ChatRoom.find(params[:chat_room_id])
    @message = RoomMessage.find(params[:id])

    # 自身のプロフィールに紐づく Activity を探す
    activity = Activity.find_by(actable: @message, owner_profile: current_profile)

    if activity
        # ActivityとRoomMessageの両方を削除
        # (Activity.rbに has_one :room_message, dependent: :destroy があれば activity.destroy だけでもOK)
        activity.destroy
        @message.destroy
        flash[:notice] = "下書きを削除しました"
    else
        flash[:alert] = "削除権限がありません"
    end

    redirect_to chat_room_path(@chat_room)
  end

  def thread
    @chat_room = ChatRoom.find(params[:chat_room_id])
    @parent_message = RoomMessage.find(params[:id])
    @parent_activity = Activity.find_by(actable: @parent_message)
    @comments = @parent_activity.comment_activities.includes(:owner_profile, :actable).order(created_at: :asc)

    # レイアウトを適用せず、パーシャル（または特定部分）だけを返す
    render partial: "thread"
  end

  private

  def room_message_params
    params.require(:room_message).permit(:content)
  end
end
-e \n--- END OF FILE ---\n
app/controllers/tasks_controller.rb
--- START OF FILE ---
# app/controllers/tasks_controller.rb
class TasksController < ApplicationController
  before_action :authenticate_user!

  def index
    @current_profile = current_profile

    # 1. 招待者・担当者を含めて一括取得（N+1対策）
    query = Activity.where(actable_type: [ "Task", "Schedule" ])
                    .visible_to(@current_profile)
                    .includes(
                      :owner_profile,
                      actable: [
                        :assignees,
                        { schedule_invitations: :profile }
                      ]
                    )
                    .order(created_at: :desc)

    # フィルタリングロジック（変更なし）
    case params[:filter]
    when "today"
      today = Time.current.all_day
      query = query.left_joins(:task_relation, :schedule_relation)
                .where(tasks: { deadline: today })
                .or(query.left_joins(:task_relation, :schedule_relation).where(schedules: { start_at: today }))
    when "week"
      this_week = Time.current.beginning_of_day..7.days.from_now.end_of_day
      query = query.left_joins(:task_relation, :schedule_relation)
                  .where(tasks: { deadline: this_week })
                  # ↓ ここを schedule_at から start_at に修正
                  .or(query.left_joins(:task_relation, :schedule_relation).where(schedules: { start_at: this_week }))
    when "todo"
      query = query.joins(:task_relation).where(tasks: { task_status: :todo })
    end

    @activities = query.order(created_at: :desc)

    # --- フォーム用オブジェクトの初期化 ---
    # Task: 23:30 デフォルト
    default_task_time = Time.current.change(hour: 23, min: 30)
    @task = Task.new(deadline: default_task_time).tap { |t|
      t.build_activity(owner_profile: @current_profile, visibility_range: :is_private, status: :active)
    }

    # Schedule: 1時間後の正時をデフォルトに（例: 今が10:15なら11:00）
    default_schedule_time = Time.current.since(1.hour).change(min: 0)
    base_time = Time.current.since(1.hour).change(min: 0)
    @schedule = Schedule.new(start_at: base_time, end_at: base_time.since(1.hour)).tap { |s|
      s.build_activity(owner_profile: @current_profile, visibility_range: :is_private, status: :active)
    }
  end

  def new
    @current_profile = current_profile
    default_time = Time.current.change(hour: 23, min: 30)

    @task = Task.new(deadline: default_time)
    @task.build_activity(owner_profile: @current_profile, visibility_range: :is_private, status: :active)
  end

  def create
    if params[:task].present?
      @obj = Task.new(task_params)
    elsif params[:schedule].present?
      @obj = Schedule.new(schedule_params)
      @obj.invitee_ids = (@obj.invitee_ids << current_profile.id).uniq
    end

    @obj.activity.owner_profile = current_profile
    @obj.activity.team = current_profile.team

    if @obj.save
      if @obj.is_a?(Schedule)
        @obj.schedule_invitations.find_by(profile: current_profile)&.join_status_approved!
      end

      redirect_to tasks_path, notice: "#{ @obj.is_a?(Task) ? 'タスク' : '予定' }を作成しました"
    else
      index
      render :index, status: :unprocessable_entity
    end
  end

  def update
    @task = Task.find(params[:id])
    if @task.update(task_params)
      redirect_to tasks_path, notice: "ステータスを更新しました"
    else
      redirect_to tasks_path, alert: "更新に失敗しました"
    end
  end

  def edit
    @task = Task.find(params[:id])
    redirect_to tasks_path unless @task.activity.owner_profile == current_profile
  end

  private

  def task_params
    params.require(:task).permit(
      :task_status, :deadline, :describe,
      assignee_ids: [],
      activity_attributes: [
        :id,
        :title, :visibility_range, :chat_room_id,
        :permission_type, :allow_comment, :allow_reaction, :status
      ]
    )
  end

  def schedule_params
    params.require(:schedule).permit(
      :start_at,
      :end_at,
      :describe,
      :schedule_status,
      invitee_ids: [],
      activity_attributes: [
        :id, :title, :visibility_range, :chat_room_id,
        :permission_type, :allow_comment, :allow_reaction, :status
      ]
    )
  end
end
-e \n--- END OF FILE ---\n
app/controllers/comments_controller.rb
--- START OF FILE ---
# app/controllers/comments_controller.rb
class CommentsController < ApplicationController
  before_action :set_activity

  def create
    # contentの取得元をフォームの構造に合わせて調整（もし social_post[content] で送っているならそのままでOK）
    content = params.dig(:social_post, :content) || params.dig(:comment, :content)

    @comment = Comment.new(
        content: content,
        parent_id: params.dig(:comment, :parent_id).presence
    )

    if @comment.save
        Activity.create!(
        actable: @comment,
        owner_profile: current_profile,
        parent_activity_id: @activity.id,
        visibility_range: @activity.visibility_range,
        team_id: @activity.team_id,
        status: "active",
        title: @comment.content.truncate(20)
        )

        # 遷移元が SocialPostの一覧か ChatRoom かを判別して thread_id を付与
        if request.referer&.include?("chat_rooms")
        redirect_to chat_room_path(@activity.chat_room, thread_id: @activity.id), notice: "返信しました"
        else
        # SocialPostの場合は filter も維持しつつ thread_id を渡す
        redirect_to social_posts_path(filter: params[:filter], thread_id: @activity.id), notice: "コメントを投稿しました"
        end
    else
        redirect_back fallback_location: root_path, alert: "失敗しました"
    end
    end

  def destroy
    # Activityを探して削除（紐づくCommentも一緒に消える設計ならActivityを消す）
    # もしCommentを消したいなら、Activityのactableを消す
    @comment_activity = Activity.find_by(id: params[:id], actable_type: "Comment")

    if @comment_activity&.owner_profile == current_profile
      @comment_activity.actable.destroy # 実体のCommentを削除
      @comment_activity.destroy         # 器のActivityを削除
      redirect_back fallback_location: root_path, notice: "削除しました"
    else
      redirect_back fallback_location: root_path, alert: "権限がありません"
    end
  end

  private

  def set_activity
    @activity = Activity.find(params[:activity_id])
  end
end
-e \n--- END OF FILE ---\n
app/controllers/works_controller.rb
--- START OF FILE ---
# app/controllers/works_controller.rb
class WorksController < ApplicationController
  before_action :authenticate_user!
  before_action :set_work, only: [ :show, :edit, :update, :destroy ]

  def index
    @current_profile = current_profile
    # ActivityからWork型のものを取得し、権限で絞り込む
    query = Activity.where(actable_type: "Work").visible_to(@current_profile)

    # フィルタリング
    case params[:filter]
    when "mine"
      query = query.where(owner_profile: @current_profile)
    when "shared"
      query = query.where.not(owner_profile: @current_profile)
    end

    @activities = query.includes(:owner_profile, actable: :actable).order(updated_at: :desc)
  end

  def new
    @work = Work.new
    @work.build_activity(owner_profile: current_profile, visibility_range: :is_private)
    @note = Note.new
  end

  def create
    @work = Work.new(work_params)
    @note = Note.new(note_params) # note_paramsを使用

    @work.actable = @note
    @work.activity.owner_profile = current_profile
    @work.activity.team = current_profile.team

    if @work.save
      redirect_to works_path, notice: "ドキュメントを作成しました"
    else
      # エラー時はnewの状態に戻す
      render :new, status: :unprocessable_entity
    end
  end

  def edit
    @activity = @work.activity
    @note = @work.actable
    unless @activity.editable_by?(current_profile)
      redirect_to works_path, alert: "編集権限がありません"
    end
  end

  def update
    @note = @work.actable
    # Work(Activity含む)とNoteの両方を更新
    if @work.update(work_params) && @note.update(note_params)
      redirect_to works_path, notice: "ドキュメントを更新しました"
    else
      render :edit, status: :unprocessable_entity
    end
  end

  def show
    @activity = @work.activity
    @note = @work.actable

    # 閲覧権限チェック
    redirect_to works_path, alert: "アクセス権限がありません" unless @activity.visible_to?(current_profile)
  end

  def destroy
    # オーナーのみ削除可能
    if @work.activity.owner_profile == current_profile
      @work.destroy
      redirect_to works_path, notice: "ドキュメントを削除しました"
    else
      redirect_to works_path, alert: "削除権限がありません"
    end
  end

  private

  def set_work
    @work = Work.find(params[:id])
  end

  def work_params
    params.require(:work).permit(
      activity_attributes: [ :id, :title, :visibility_range, :chat_room_id, :permission_type, :allow_comment, :allow_reaction ]
    )
  end

  def note_params
    params.require(:note).permit(:content)
  end
end
-e \n--- END OF FILE ---\n
app/controllers/profiles_controller.rb
--- START OF FILE ---
# app/controllers/profiles_controller.rb
class ProfilesController < ApplicationController
  before_action :authenticate_user!
  before_action :set_profile, only: [ :edit, :update, :destroy, :switch ]

  def switch
    # 1. セッションを切り替える
    session[:current_profile_id] = @profile.id

    # 2. 現在のURLを解析して、IDが含まれるパスなら置換してリダイレクト
    begin
      return redirect_to authenticated_root_path, status: :see_other if request.referer.nil?

      uri = URI.parse(request.referer)
      # Railsのルーターを使って現在のパスからパラメーターを抽出
      path_params = Rails.application.routes.recognize_path(uri.path)

      if path_params[:id].present?
        # URLにIDが含まれる場合(editなど)、新しいプロフィールのIDに差し替えてジャンプ
        path_params[:id] = @profile.id
        redirect_to url_for(path_params), notice: "#{@profile.name} に切り替えました"
      else
        # IDが含まれないページ（indexなど）ならそのまま戻る
        redirect_back(fallback_location: authenticated_root_path, notice: "#{@profile.name} に切り替えました", status: :see_other)
      end
    rescue => e
      # 解析不能なパスの場合は安全にルートへ
      redirect_to authenticated_root_path, notice: "#{@profile.name} に切り替えました", status: :see_other
    end
  end

  def index
    @profiles = current_user.profiles
  end

  def new
    @profile = current_user.profiles.build
  end

  def create
    @profile = current_user.profiles.build(profile_params)
    if @profile.save
      redirect_to profiles_path, notice: "プロフィールを作成しました"
    else
      render :new, status: :unprocessable_entity
    end
  end

  def edit
  end

  def update
    if @profile.update(profile_params)
      # 更新後、自身の編集画面へ戻る（整合性維持のため @profile を使用）
      redirect_to edit_profile_path(@profile), notice: "プロフィールを更新しました"
    else
      render :edit, status: :unprocessable_entity
    end
  end

  def destroy
    if current_user.profiles.count <= 1
      redirect_to edit_profile_path(@profile), alert: "最後のプロフィールは削除できません。"
      return
    end

    @profile.destroy

    # 削除したのが現在選択中のプロフィールなら、残った最初のプロフィールに切り替え
    if session[:current_profile_id].to_i == @profile.id
      session[:current_profile_id] = current_user.profiles.first.id
    end

    redirect_to authenticated_root_path, notice: "プロフィールを削除しました。"
  end

  private

  def set_profile
    # current_user.profiles を経由することで他人のプロフィールアクセスを防止
    @profile = current_user.profiles.find(params[:id])

    # 【重要】編集・更新アクション時、URLのIDが「選択中のID」と違う場合は強制リダイレクト
    if [ "edit", "update" ].include?(action_name)
      if @profile.id != current_profile.id
        # redirect_to の後に return がないと、この後のアクション処理も走ってしまいエラーになります
        redirect_to edit_profile_path(current_profile)
      end
    end
  rescue ActiveRecord::RecordNotFound
    redirect_to authenticated_root_path, alert: "プロフィールが見つかりません。"
  end

  def profile_params
    params.require(:profile).permit(:name, :label, :avatar)
  end
end
-e \n--- END OF FILE ---\n
app/controllers/likes_controller.rb
--- START OF FILE ---
# app/controllers/likes_controller.rb
class LikesController < ApplicationController
  before_action :set_activity

  def create
    # すでにいいねしているか確認
    existing_like_activity = @activity.like_activities.find_by(owner_profile: current_profile)

    if existing_like_activity
      # すでに存在すれば削除（トグル）
      existing_like_activity.destroy
      msg = "いいねを取り消しました"
    else
      # なければ作成
      like = Like.new
      @activity.child_activities.create!(
        actable: like,
        owner_profile: current_profile,
        visibility_range: @activity.visibility_range,
        team_id: @activity.team_id,
        chat_room_id: @activity.chat_room_id,
        status: :active
      )
      msg = "いいねしました"
    end

    redirect_back fallback_location: root_path, notice: msg
  end

  private

  def set_activity
    @activity = Activity.find(params[:activity_id])
  end
end
-e \n--- END OF FILE ---\n
app/controllers/users/sessions_controller.rb
--- START OF FILE ---
# app/controllers/users/sessions_controller.rb
class Users::SessionsController < Devise::SessionsController
  def guest_sign_in
    user = User.find_or_create_by!(email: 'guest@example.com') do |u|
      u.password = SecureRandom.urlsafe_base64
    end

    unless user.profiles.exists?
      # 1. 仕事用 (Work)
      # profile_id は index が unique なので、ゲストごとに被らない工夫が必要
      user.profiles.create!(
        label: "Work (本業)",
        name: "Sato | Director",
        profile_id: "sato_work_#{SecureRandom.hex(3)}",
        status: 0
      )

      # 2. プライベート用 (Private)
      user.profiles.create!(
        label: "Private (個人用)",
        name: "Satomi",
        profile_id: "satomi_private_#{SecureRandom.hex(3)}",
        status: 0
      )

      # 3. 外部活動用 (School)
      user.profiles.create!(
        label: "School (料理教室)",
        name: "Satomi @ Cooking",
        profile_id: "satomi_cook_#{SecureRandom.hex(3)}",
        status: 0
      )
    end

    # 最初に表示するプロフィールを「Work」に設定
    guest_profile = user.profiles.find_by(label: "Work (本業)")
    session[:current_profile_id] = guest_profile.id

    sign_in user
    redirect_to root_path, notice: 'guest_mode'
  end
end-e \n--- END OF FILE ---\n
app/controllers/users/registrations_controller.rb
--- START OF FILE ---
# app/controllers/users/registrations_controller.rb
class Users::RegistrationsController < Devise::RegistrationsController
  # GET /resource/sign_up
  def new
    build_resource({})
    # ここでProfileを1つビルドしておくことで、ビューのfields_forが反応する
    resource.profiles.build
    respond_with resource
  end

  # POST /resource
  def create
    super
    # 必要に応じて保存後の追加ロジックをここに書けます
  end
end
-e \n--- END OF FILE ---\n
app/controllers/activities_controller.rb
--- START OF FILE ---
# app/controllers/activities_controller.rb
class ActivitiesController < ApplicationController
  before_action :authenticate_user!

  def destroy
    @activity = Activity.find(params[:id])

    # セキュリティ：作成者本人のみ削除可能
    if @activity.owner_profile == current_profile
      # activityを消せば、関連する task や schedule も dependent: :destroy で消えます
      @activity.destroy
      redirect_to tasks_path, notice: "削除しました", status: :see_other
    else
      redirect_to tasks_path, alert: "削除する権限がありません", status: :forbidden
    end
  end
end
-e \n--- END OF FILE ---\n
app/controllers/schedules_controller.rb
--- START OF FILE ---
# app/controllers/schedules_controller.rb
class SchedulesController < ApplicationController
  before_action :authenticate_user!
  before_action :set_schedule, only: [ :edit, :update ]

  def create
    @schedule = Schedule.new(schedule_params)
    # 自分のIDを招待者に含める
    @schedule.invitee_ids = (@schedule.invitee_ids << current_profile.id).uniq

    @schedule.build_activity if @schedule.activity.nil?
    @schedule.activity.owner_profile = current_profile
    @schedule.activity.team = current_profile.team

    if @schedule.save
        @schedule.schedule_invitations.find_by(profile: current_profile)&.join_status_approved!
        redirect_to tasks_path, notice: "予定を作成しました"
    else
        # indexに戻るための準備（TasksControllerのindex相当の処理が必要な場合があります）
        redirect_to tasks_path, alert: "作成に失敗しました"
    end
  end

  def edit
    @current_profile = current_profile
    # 判定ロジックをモデルに任せる
    unless @schedule.activity.editable_by?(current_profile)
      redirect_to tasks_path, alert: "編集権限がありません。"
    end
  end

  def update
    if @schedule.update(schedule_params)
      # Turbo Frameにより、indexの該当行だけが更新されます
      redirect_to tasks_path, notice: "予定を更新しました"
    else
      render :edit, status: :unprocessable_entity
    end
  end

  private

  def set_schedule
    @schedule = Schedule.find(params[:id])
  end

  def schedule_params
    params.require(:schedule).permit(
        :start_at,
        :end_at,
        :describe,
        :schedule_status,
        invitee_ids: [],
        activity_attributes: [
        :id,             # 編集には必須
        :title,          # タイトル更新に必要
        :visibility_range,
        :chat_room_id,
        :permission_type,
        :allow_comment,
        :allow_reaction
        ]
    )
    end
end
-e \n--- END OF FILE ---\n
app/controllers/team_invitations_controller.rb
--- START OF FILE ---
# app/contollers/team_invitations_controller.rb
class TeamInvitationsController < ApplicationController
  before_action :authenticate_user!
  before_action :ensure_team_admin, only: [ :create, :cancel ]

  def search
    @target_profile = Profile.find_by(profile_id: params[:profile_id])

    # 既存の create にあるバリデーション（チーム所属済みか等）を
    # ここでも行い、エラーならリダイレクトするロジックを共通化すると良いです
    if @target_profile.nil?
      redirect_to members_team_path, alert: "指定されたプロフィールIDが見つかりません。"
    end
  end

  def create
    @target_profile = Profile.find_by(profile_id: params[:profile_id]&.downcase)

    # 1. プロフィールが存在するか
    if @target_profile.nil?
        return redirect_to members_team_path, alert: "指定されたプロフィールIDが見つかりません。入力内容を確認してください。"
    end

    # 2. 自分自身ではないか
    if @target_profile == current_profile
        return redirect_to members_team_path, alert: "自分自身を招待することはできません。"
    end

    # 3. 既にチームに所属していないか
    if @target_profile.team.present?
        return redirect_to members_team_path, alert: "#{@target_profile.name} さんは既にチームに所属しています。"
    end

    # 4. 既に招待送信済み（承認待ち）ではないか
    existing_request = TeamMembershipRequest.find_by(
        team: current_profile.team,
        profile: @target_profile,
        status: :pending
    )
    if existing_request
        return redirect_to members_team_path, alert: "#{@target_profile.name} さんには既に招待を送信済みです。"
    end

    # 招待の作成
    request = TeamMembershipRequest.new(
        team: current_profile.team,
        profile: @target_profile,
        status: :pending,
        role: params[:role]
    )

    if request.save
        redirect_to members_team_path, notice: "#{@target_profile.name} さんに招待（#{request.role_i18n}権限）を送信しました。"
    else
        redirect_to members_team_path, alert: "招待の送信に失敗しました。"
    end
  end

  def cancel
    # 自分のチームが送った招待であることを保証して取得
    @invitation = current_profile.team.team_membership_requests.find(params[:id])

    if @invitation.pending?
      @invitation.canceled!
      redirect_to members_team_path, notice: "#{@invitation.profile.name} さんへの招待を取り消しました。"
    else
      redirect_to members_team_path, alert: "この招待は既に取り消されているか、承認済みのため変更できません。"
    end
  rescue ActiveRecord::RecordNotFound
    redirect_to members_team_path, alert: "招待データが見つかりませんでした。"
  end

  def accept
    @invitation = TeamMembershipRequest.find(params[:id])

    # 自分宛てかつ保留中であることを確認
    if @invitation.profile == current_profile && @invitation.pending?
      if current_profile.team.present?
        return redirect_to edit_profile_path(current_profile), alert: "既にチームに所属しているため、新しく参加することはできません。"
      end

      # トランザクションでステータス更新とプロフィール更新を同時に行う
      ActiveRecord::Base.transaction do
        @invitation.accepted!
        current_profile.update!(
          team: @invitation.team,
          team_role: @invitation.role # 招待時のrole(admin/member)を反映
        )
      end
      redirect_to members_team_path, notice: "チーム「#{@invitation.team.display_name}」に参加しました！"
    else
      redirect_to edit_profile_path(current_profile), alert: "不正なリクエストです。"
    end
  end

  def reject
    @invitation = TeamMembershipRequest.find(params[:id])
    if @invitation.profile == current_profile && @invitation.pending?
      @invitation.rejected!
      redirect_to edit_profile_path(current_profile), notice: "招待を辞退しました。"
    else
      redirect_to edit_profile_path(current_profile), alert: "不正なリクエストです。"
    end
  end

  private

  def ensure_team_admin
    unless current_profile.admin?
      redirect_to members_team_path, alert: "管理者権限が必要です。"
    end
  end
end
-e \n--- END OF FILE ---\n
app/controllers/social_posts_controller.rb
--- START OF FILE ---
# app/controllers/social_posts_controller.rb
class SocialPostsController < ApplicationController
  def index
    @current_profile = current_profile
    @base_query = Activity.where(actable_type: "SocialPost")
                       .includes(:owner_profile, actable: :source_post)

    @no_team_scoped = params[:filter] == "team" && @current_profile.team_id.blank?

    @activities = case params[:filter]
    when "team"
                    if @current_profile.team_id.present?
                       @base_query.where(visibility_range: :is_team, team_id: @current_profile.team_id).active
                    else
                        Activity.none
                    end
    when "mine"
                    @base_query.where(owner_profile: @current_profile).active
    when "draft"
                    @base_query.where(owner_profile: @current_profile).draft
    else
                    @base_query.visible_to(@current_profile).active
    end.order(created_at: :asc)
  end

  def create
    @current_profile = current_profile
    target_status = params[:commit_type] == "draft" ? :draft : :active
    v_range = params[:visibility_range] || "is_public"

    if params[:post_id].present?
      # 【編集時】
      @post = SocialPost.find(params[:post_id])
      @activity = @post.activity
      if @activity.owner_profile == @current_profile
        # social_post_params を使用
        @post.update(social_post_params)
        @activity.update(status: target_status, visibility_range: v_range, title: @post.content.truncate(20))
      end
    else
      # 【新規作成時】
      @post = SocialPost.new(social_post_params)
      if @post.save
        @post.create_activity!(
          owner_profile: @current_profile,
          team_id: @current_profile.team_id,
          status: target_status,
          visibility_range: v_range,
          title: @post.content.truncate(20)
        )
      end
    end
    # 元のフィルターを維持してリダイレクト
    redirect_to social_posts_path(filter: params[:filter])
  end

  def destroy
    @post = SocialPost.find(params[:id])
    @activity = @post.activity
    if @activity.owner_profile == current_profile
      @activity.destroy
      @post.destroy
    end
    redirect_back(fallback_location: social_posts_path)
  end

  def repost
    source_post = SocialPost.find(params[:id])

    # 1. SocialRepostレコードを作成
    # 属性名は schema に合わせて source_post_id でも source_post でもOKですが
    # content の取得階層を修正します
    repost = SocialRepost.new(
        source_post: source_post,
        content: params.dig(:social_post, :content) # 階層を安全に取得
    )

    if repost.save
        # 2. Activityレコードを作成
        # title も保存しておかないと一覧で困ることがあります
        source_activity = source_post.activity

        repost.create_activity!(
          owner_profile: current_profile,
          status: :active,
          visibility_range: params[:visibility_range] || source_post.visibility_range,
          team_id: (params[:visibility_range] == "is_team" ? current_profile.team_id : nil),
          title: "Repost: #{source_post.content.truncate(10)}"
        )
        redirect_to social_posts_path, notice: "リポストしました"
    else
        # ここで失敗している場合、Railsのログ (log/development.log) にエラーが出ます
        logger.error repost.errors.full_messages
        redirect_to social_posts_path, alert: "リポストの保存に失敗しました: #{repost.errors.full_messages.join(', ')}"
    end
  end

  def thread
    @parent_post = SocialPost.find(params[:id])
    @parent_activity = Activity.find_by(actable: @parent_post)
    @comments = @parent_activity.comment_activities.includes(:owner_profile, :actable).order(created_at: :asc)

    render partial: "social_posts/thread"
  end

  private

  def social_post_params
    params.require(:social_post).permit(:content)
  end
end
-e \n--- END OF FILE ---\n
app/views/devise/unlocks/new.html.erb
--- START OF FILE ---
<h2>Resend unlock instructions</h2>

<%= form_for(resource, as: resource_name, url: unlock_path(resource_name), html: { method: :post }) do |f| %>
  <%= render "devise/shared/error_messages", resource: resource %>

  <div class="field">
    <%= f.label :email %><br />
    <%= f.email_field :email, autofocus: true, autocomplete: "email" %>
  </div>

  <div class="actions">
    <%= f.submit "Resend unlock instructions" %>
  </div>
<% end %>

<%= render "devise/shared/links" %>
-e \n--- END OF FILE ---\n
app/views/devise/passwords/edit.html.erb
--- START OF FILE ---
<h2>Change your password</h2>

<%= form_for(resource, as: resource_name, url: password_path(resource_name), html: { method: :put }) do |f| %>
  <%= render "devise/shared/error_messages", resource: resource %>
  <%= f.hidden_field :reset_password_token %>

  <div class="field">
    <%= f.label :password, "New password" %><br />
    <% if @minimum_password_length %>
      <em>(<%= @minimum_password_length %> characters minimum)</em><br />
    <% end %>
    <%= f.password_field :password, autofocus: true, autocomplete: "new-password" %>
  </div>

  <div class="field">
    <%= f.label :password_confirmation, "Confirm new password" %><br />
    <%= f.password_field :password_confirmation, autocomplete: "new-password" %>
  </div>

  <div class="actions">
    <%= f.submit "Change my password" %>
  </div>
<% end %>

<%= render "devise/shared/links" %>
-e \n--- END OF FILE ---\n
app/views/devise/passwords/new.html.erb
--- START OF FILE ---
<h2>Forgot your password?</h2>

<%= form_for(resource, as: resource_name, url: password_path(resource_name), html: { method: :post }) do |f| %>
  <%= render "devise/shared/error_messages", resource: resource %>

  <div class="field">
    <%= f.label :email %><br />
    <%= f.email_field :email, autofocus: true, autocomplete: "email" %>
  </div>

  <div class="actions">
    <%= f.submit "Send me reset password instructions" %>
  </div>
<% end %>

<%= render "devise/shared/links" %>
-e \n--- END OF FILE ---\n
app/views/devise/mailer/confirmation_instructions.html.erb
--- START OF FILE ---
<p>Welcome <%= @email %>!</p>

<p>You can confirm your account email through the link below:</p>

<p><%= link_to 'Confirm my account', confirmation_url(@resource, confirmation_token: @token) %></p>
-e \n--- END OF FILE ---\n
app/views/devise/mailer/reset_password_instructions.html.erb
--- START OF FILE ---
<p>Hello <%= @resource.email %>!</p>

<p>Someone has requested a link to change your password. You can do this through the link below.</p>

<p><%= link_to 'Change my password', edit_password_url(@resource, reset_password_token: @token) %></p>

<p>If you didn't request this, please ignore this email.</p>
<p>Your password won't change until you access the link above and create a new one.</p>
-e \n--- END OF FILE ---\n
app/views/devise/mailer/password_change.html.erb
--- START OF FILE ---
<p>Hello <%= @resource.email %>!</p>

<p>We're contacting you to notify you that your password has been changed.</p>
-e \n--- END OF FILE ---\n
app/views/devise/mailer/email_changed.html.erb
--- START OF FILE ---
<p>Hello <%= @email %>!</p>

<% if @resource.try(:unconfirmed_email?) %>
  <p>We're contacting you to notify you that your email is being changed to <%= @resource.unconfirmed_email %>.</p>
<% else %>
  <p>We're contacting you to notify you that your email has been changed to <%= @resource.email %>.</p>
<% end %>
-e \n--- END OF FILE ---\n
app/views/devise/mailer/unlock_instructions.html.erb
--- START OF FILE ---
<p>Hello <%= @resource.email %>!</p>

<p>Your account has been locked due to an excessive number of unsuccessful sign in attempts.</p>

<p>Click the link below to unlock your account:</p>

<p><%= link_to 'Unlock my account', unlock_url(@resource, unlock_token: @token) %></p>
-e \n--- END OF FILE ---\n
app/views/devise/shared/_error_messages.html.erb
--- START OF FILE ---
<% if resource.errors.any? %>
  <div id="error_explanation" data-turbo-cache="false">
    <h2>
      <%= I18n.t("errors.messages.not_saved",
                 count: resource.errors.count,
                 resource: resource.class.model_name.human.downcase)
       %>
    </h2>
    <ul>
      <% resource.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
    </ul>
  </div>
<% end %>
-e \n--- END OF FILE ---\n
app/views/devise/shared/_links.html.erb
--- START OF FILE ---
<%- if controller_name != 'sessions' %>
  <%= link_to "Log in", new_session_path(resource_name) %><br />
<% end %>

<%- if devise_mapping.registerable? && controller_name != 'registrations' %>
  <%= link_to "Sign up", new_registration_path(resource_name) %><br />
<% end %>

<%- if devise_mapping.recoverable? && controller_name != 'passwords' && controller_name != 'registrations' %>
  <%= link_to "Forgot your password?", new_password_path(resource_name) %><br />
<% end %>

<%- if devise_mapping.confirmable? && controller_name != 'confirmations' %>
  <%= link_to "Didn't receive confirmation instructions?", new_confirmation_path(resource_name) %><br />
<% end %>

<%- if devise_mapping.lockable? && resource_class.unlock_strategy_enabled?(:email) && controller_name != 'unlocks' %>
  <%= link_to "Didn't receive unlock instructions?", new_unlock_path(resource_name) %><br />
<% end %>

<%- if devise_mapping.omniauthable? %>
  <%- resource_class.omniauth_providers.each do |provider| %>
    <%= button_to "Sign in with #{OmniAuth::Utils.camelize(provider)}", omniauth_authorize_path(resource_name, provider), data: { turbo: false } %><br />
  <% end %>
<% end %>
-e \n--- END OF FILE ---\n
app/views/devise/sessions/new.html.erb
--- START OF FILE ---
<!-- app/views/devise/sessions/new.html.erb -->
<div class="min-h-screen flex flex-col justify-center py-12 sm:px-6 lg:px-8 bg-gray-50">
  <%# アプリロゴとバージョン表記を追加 %>
  <div class="sm:mx-auto sm:w-full sm:max-w-md text-center">
    <h1 class="text-5xl font-extrabold text-[#00a968] tracking-tight">Forestly</h1>
    <p class="mt-2 text-sm text-gray-500 font-medium">β版 Version.4</p>
    <h2 class="mt-6 text-2xl font-bold text-gray-900">Login</h2>

    <!-- ゲストログイン用 -->
    <%= button_to 'Forestlyとは？', guest_sign_in_path, method: :post, class: 'btn-guest-intro' %>

    <style>
    /* ポートフォリオ用に少し目立たせるスタイル例 */
    .btn-guest-intro {
      display: inline-block;
      padding: 10px 20px;
      background-color: #28a745; /* 清潔感のある緑 */
      color: white;
      border-radius: 5px;
      text-decoration: none;
      font-weight: bold;
      margin-bottom: 20px;
    }
    </style>
  </div>

  <div class="mt-8 sm:mx-auto sm:w-full sm:max-w-md">
    <%# エラーメッセージ表示エリア %>
    <% if flash[:alert] || alert %>
      <div class="mb-4 bg-red-50 border-l-4 border-red-400 p-4">
        <div class="flex">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
            </svg>
          </div>
          <div class="ml-3">
            <p class="text-sm font-bold text-red-700">ログインに失敗しました</p>
            <p class="text-xs text-red-600">
              <%= flash[:alert] || alert || "メールアドレスまたはパスワードが正しくありません。" %>
            </p>
          </div>
        </div>
      </div>
    <% end %>

    <div class="bg-white py-8 px-4 shadow sm:rounded-lg sm:px-10 border-t-4 border-[#00a968]">
      <%= form_for(resource, as: resource_name, url: session_path(resource_name), html: { class: "space-y-6", data: { turbo: false } }) do |f| %>
        <div>
          <%= f.label :email, class: "block text-sm font-medium text-gray-700" %>
          <%= f.email_field :email, autofocus: true, autocomplete: "email", class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-[#00a968] focus:border-[#00a968]" %>
        </div>

        <div>
          <%= f.label :password, class: "block text-sm font-medium text-gray-700" %>
          <%= f.password_field :password, autocomplete: "current-password", class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-[#00a968] focus:border-[#00a968]" %>
        </div>

        <% if devise_mapping.rememberable? %>
          <div class="flex items-center">
            <%= f.check_box :remember_me, class: "h-4 w-4 text-[#00a968] focus:ring-[#00a968] border-gray-300 rounded" %>
            <%= f.label :remember_me, class: "ml-2 block text-sm text-gray-900" %>
          </div>
        <% end %>

        <div>
          <%= f.submit "Login", class: "w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-[#00a968] hover:bg-[#008f58] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#00a968]" %>
        </div>
      <% end %>

      <div class="mt-6 text-center">
        <%= render "devise/shared/links" %>
      </div>
    </div>
  </div>
</div>-e \n--- END OF FILE ---\n
app/views/devise/confirmations/new.html.erb
--- START OF FILE ---
<!-- app/views/devise/confirmations/new.html.erb -->
<h2>Resend confirmation instructions</h2>

<%= form_for(resource, as: resource_name, url: confirmation_path(resource_name), html: { method: :post }) do |f| %>
  <%= render "devise/shared/error_messages", resource: resource %>

  <div class="field">
    <%= f.label :email %><br />
    <%= f.email_field :email, autofocus: true, autocomplete: "email", value: (resource.pending_reconfirmation? ? resource.unconfirmed_email : resource.email) %>
  </div>

  <div class="actions">
    <%= f.submit "Resend confirmation instructions" %>
  </div>
<% end %>

<%= render "devise/shared/links" %>
-e \n--- END OF FILE ---\n
app/views/devise/registrations/edit.html.erb
--- START OF FILE ---
<h2>Edit <%= resource_name.to_s.humanize %></h2>

<%= form_for(resource, as: resource_name, url: registration_path(resource_name), html: { method: :put }) do |f| %>
  <%= render "devise/shared/error_messages", resource: resource %>

  <div class="field">
    <%= f.label :email %><br />
    <%= f.email_field :email, autofocus: true, autocomplete: "email" %>
  </div>

  <% if devise_mapping.confirmable? && resource.pending_reconfirmation? %>
    <div>Currently waiting confirmation for: <%= resource.unconfirmed_email %></div>
  <% end %>

  <div class="field">
    <%= f.label :password %> <i>(leave blank if you don't want to change it)</i><br />
    <%= f.password_field :password, autocomplete: "new-password" %>
    <% if @minimum_password_length %>
      <br />
      <em><%= @minimum_password_length %> characters minimum</em>
    <% end %>
  </div>

  <div class="field">
    <%= f.label :password_confirmation %><br />
    <%= f.password_field :password_confirmation, autocomplete: "new-password" %>
  </div>

  <div class="field">
    <%= f.label :current_password %> <i>(we need your current password to confirm your changes)</i><br />
    <%= f.password_field :current_password, autocomplete: "current-password" %>
  </div>

  <div class="actions">
    <%= f.submit "Update" %>
  </div>
<% end %>

<h3>Cancel my account</h3>

<div>Unhappy? <%= button_to "Cancel my account", registration_path(resource_name), data: { confirm: "Are you sure?", turbo_confirm: "Are you sure?" }, method: :delete %></div>

<%= link_to "Back", :back %>
-e \n--- END OF FILE ---\n
app/views/devise/registrations/new.html.erb
--- START OF FILE ---
<!-- app/views/devise/registrations/new.html.erb -->
<div class="min-h-screen flex flex-col justify-center py-12 sm:px-6 lg:px-8 bg-gray-50">
  <%# アプリロゴとバージョン表記を追加 %>
  <div class="sm:mx-auto sm:w-full sm:max-w-md text-center">
    <h1 class="text-5xl font-extrabold text-[#00a968] tracking-tight">Forestly</h1>
    <p class="mt-2 text-sm text-gray-500 font-medium">β版 Version.4</p>
    <h2 class="mt-6 text-2xl font-bold text-gray-900">アカウント作成</h2>
  </div>

  <div class="mt-8 sm:mx-auto sm:w-full sm:max-w-md">
    <div class="bg-white py-8 px-4 shadow sm:rounded-lg sm:px-10 border-t-4 border-[#00a968]">
      <%= form_for(resource, as: resource_name, url: registration_path(resource_name), html: { class: "space-y-6" }) do |f| %>
        <%= render "devise/shared/error_messages", resource: resource %>

        <div>
          <%= f.label :email, class: "block text-sm font-medium text-gray-700" %>
          <%= f.email_field :email, autofocus: true, autocomplete: "email", class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-[#00a968] focus:border-[#00a968]" %>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <%= f.label :password, class: "block text-sm font-medium text-gray-700" %>
            <%= f.password_field :password, autocomplete: "new-password", class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-[#00a968] focus:border-[#00a968]" %>
          </div>
          <div>
            <%= f.label :password_confirmation, "確認用", class: "block text-sm font-medium text-gray-700" %>
            <%= f.password_field :password_confirmation, autocomplete: "new-password", class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-[#00a968] focus:border-[#00a968]" %>
          </div>
        </div>

        <%= f.fields_for :profiles do |p| %>
          <div class="flex flex-col items-center py-4">
            <div id="avatar-preview-container" 
                 onclick="document.getElementById('profile-avatar-input').click();" 
                 class="relative cursor-pointer group">
              <div id="avatar-initial-display" class="group-hover:opacity-75 transition-opacity">
                <%= profile_avatar_tag(p.object, size: 100) %>
              </div>
              <img id="image-preview" src="#" alt="Preview" 
                   style="display: none; width: 100px; height: 100px; border-radius: 0.75rem; object-fit: cover;"
                   class="group-hover:opacity-75 transition-opacity">
              <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                <span class="text-xs text-white bg-black bg-opacity-50 px-2 py-1 rounded">変更</span>
              </div>
            </div>
            <%= p.file_field :avatar, id: "profile-avatar-input", accept: 'image/*', onchange: "previewImage(this);", class: "hidden" %>
            <p class="text-xs text-gray-500 mt-2">アイコンをクリックして画像を選択</p>
          </div>

          <div>
            <%= p.label :name, "表示名", class: "block text-sm font-medium text-gray-700" %>
            <%= p.text_field :name, oninput: "updateInitial(this);", class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-[#00a968] focus:border-[#00a968]" %>
          </div>

          <div>
            <%= p.label :label, "管理名 (例: 仕事用、プライベート)", class: "block text-sm font-medium text-gray-700" %>
            <%= p.text_field :label, class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-[#00a968] focus:border-[#00a968]" %>
          </div>
        <% end %>

        <div>
          <%= f.submit "登録する", class: "w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-[#00a968] hover:bg-[#008f58] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#00a968]" %>
        </div>
      <% end %>
      
      <div class="mt-6 text-center">
        <%= render "devise/shared/links" %>
      </div>
    </div>
  </div>
</div>

<script>
  function previewImage(input) {
    const preview = document.getElementById('image-preview');
    const initialDisplay = document.getElementById('avatar-initial-display');
    
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = 'block';      
        initialDisplay.style.display = 'none'; 
      }
      reader.readAsDataURL(input.files[0]);
    }
  }

  function updateInitial(input) {
    // ヘルパーが生成するdiv内のテキストを更新 
    const initialDiv = document.querySelector('#avatar-initial-display div');
    if (initialDiv && !document.getElementById('image-preview').offsetParent) {
      initialDiv.textContent = input.value.charAt(0).toUpperCase() || "?";
    }
  }
</script>-e \n--- END OF FILE ---\n
app/views/tasks/index.html.erb
--- START OF FILE ---
<!-- app/views/tasks/index.html.erb -->
<% content_for :sidebar do %>
  <%= render 'sidebar' %>
<% end %>

<div class="flex flex-col h-full bg-white" x-data="{ open_form: null }">
  <%# --- Header: 左右の余白を適切に維持 --- %>
  <header class="bg-white border-b border-gray-100 px-8 py-4 flex justify-between items-center shrink-0">
    <h2 class="text-xl font-bold text-gray-900">
      <%= case params[:filter]
          when 'today' then '今日の予定'
          when 'week'  then '今週の予定'
          when 'todo'  then '未完了タスク'
          else '全てのタスク & スケジュール'
          end %>
    </h2>

    <div class="flex gap-2">
      <button type="button" @click="open_form = (open_form === 'task' ? null : 'task')" 
              :class="open_form === 'task' ? 'bg-emerald-100 text-emerald-700' : 'bg-emerald-600 text-white'"
              class="px-4 py-2 rounded-lg text-sm font-bold transition-all">新規タスク</button>
      <button type="button" @click="open_form = (open_form === 'schedule' ? null : 'schedule')" 
              :class="open_form === 'schedule' ? 'bg-blue-100 text-blue-700' : 'bg-blue-600 text-white'"
              class="px-4 py-2 rounded-lg text-sm font-bold transition-all">新規スケジュール</button>
    </div>
  </header>

  <div class="flex-1 overflow-y-auto">
    <%# --- Form Area: フォーム時のみ内側に少し余白 --- %>
    <div class="w-full">
      <div x-show="open_form === 'task'" x-cloak x-transition class="border-b-2 border-emerald-500 bg-emerald-50/30 p-8">
        <div class="max-w-4xl mx-auto">
          <h3 class="text-sm font-bold text-emerald-600 mb-4 uppercase tracking-widest">Create New Task</h3>
          <%= render 'components/task_form', task: @task %>
        </div>
      </div>

      <div x-show="open_form === 'schedule'" x-cloak x-transition class="border-b-2 border-blue-500 bg-blue-50/30 p-8">
        <div class="max-w-4xl mx-auto">
          <h3 class="text-sm font-bold text-blue-600 mb-4 uppercase tracking-widest">Create New Schedule</h3>
          <%= render 'components/schedule_form', schedule: @schedule %>
        </div>
      </div>

      <%# --- List Area: 枠を排除し、横幅いっぱいに展開 --- %>
      <div class="w-full">
        <%# --- Table Header --- %>
        <div class="grid grid-cols-12 gap-0 px-8 py-3 bg-gray-50 border-b border-gray-100 text-[10px] font-bold text-gray-400 uppercase tracking-widest">
          <div class="col-span-1 flex justify-center">Type</div>
          <div class="col-span-3">Title</div>
          <div class="col-span-1 text-center">Status</div>
          <div class="col-span-2 text-center">Date & Time</div>
          <div class="col-span-2 text-center">Assignnes / Invitees</div>
          <div class="col-span-2 text-center">Owner</div>
          <div class="col-span-1 flex justify-center text-rose-300">Del</div>
        </div>

        <%# --- Table Body --- %>
        <div class="divide-y divide-gray-100">
          <% if @activities.any? %>
            <% @activities.each do |activity| %>
              <% item = activity.actable %>
              <turbo-frame id="<%= dom_id(activity) %>">
                <div class="grid grid-cols-12 gap-0 px-8 py-4 items-center hover:bg-gray-50 transition-colors group text-sm">
                
                <%# 1. Type %>
                <div class="col-span-1 flex justify-center">
                  <% if item.is_a?(Task) %>
                    <span class="text-[9px] font-black px-1.5 py-0.5 rounded border border-emerald-200 bg-emerald-50 text-emerald-600 tracking-tighter">Task</span>
                  <% else %>
                    <span class="text-[9px] font-black px-1.5 py-0.5 rounded border border-blue-200 bg-blue-50 text-blue-600 tracking-tighter">Sched</span>
                  <% end %>
                </div>

                <%# 2. Title %>
                <div class="col-span-3 pr-4">
                  <% if activity.editable_by?(@current_profile) %>
                    <%# edit_task_path または edit_schedule_path へのリンク %>
                    <%= link_to edit_polymorphic_path(item), data: { turbo_frame: dom_id(activity) } do %>
                      <p class="font-bold text-gray-900 truncate hover:text-blue-600"><%= activity.title %></p>
                    <% end %>
                  <% else %>
                    <p class="font-bold text-gray-900 truncate"><%= activity.title %></p>
                  <% end %>
                  <p class="text-[11px] text-gray-400 truncate mt-0.5"><%= item.describe %></p>
                </div>

                <%# 3. Status (col-span-1) %>
                <div class="col-span-1 flex justify-center text-center">
                  <% if item.is_a?(Task) %>
                    <%# --- Task ステータス --- %>
                    <%= form_with model: item, local: true do |f| %>
                      <%= f.select :task_status, 
                                  Task.task_statuses.keys.map { |s| [Task.task_statuses_i18n[s], s] }, 
                                  {}, 
                                  { onchange: "this.form.requestSubmit()", 
                                    class: "text-[10px] font-bold border-0 bg-transparent focus:ring-0 cursor-pointer p-0 #{status_color_class(item.task_status)}" } %>
                    <% end %>
                  <% else %>
                    <%# --- Schedule 招待状況 --- %>
                    <% my_invitation = item.schedule_invitations.find { |inv| inv.profile_id == @current_profile.id } %>
                    <% if my_invitation %>
                      <%= form_with model: my_invitation, local: true do |f| %>
                        <div class="flex flex-col items-center leading-tight">
                          <span class="text-[9px] font-black text-blue-600 uppercase mb-0.5">
                            <%= Schedule.schedule_statuses_i18n[item.schedule_status] %>
                          </span>
                          <%= f.select :join_status, 
                                      ScheduleInvitation.join_statuses.keys.map { |s| [ScheduleInvitation.join_statuses_i18n[s], s] }, 
                                      {}, 
                                      { onchange: "this.form.requestSubmit()", 
                                        class: "text-[10px] font-bold border-0 bg-transparent focus:ring-0 cursor-pointer p-0 #{my_invitation.join_status_approved? ? 'text-emerald-500' : 'text-amber-500'}" } %>
                        </div>
                      <% end %>
                    <% end %>
                  <% end %>
                </div>

                <%# 4. Date & Time (col-span-2) %>
                <div class="col-span-2 text-center">
                  <% if item.is_a?(Task) %>
                    <span class="text-[12px] font-medium text-gray-600"><%= item.deadline&.strftime("%m/%d %H:%M") %></span>
                  <% else %>
                    <span class="text-[12px] font-bold text-blue-600"><%= item.start_at&.strftime("%m/%d %H:%M") %></span>
                  <% end %>
                </div>

                <%# 5. Members (col-span-2) %>
                <div class="col-span-2 flex justify-center -space-x-1.5 overflow-hidden">
                  <% (item.is_a?(Task) ? item.assignees : item.invitees).first(4).each do |profile| %>
                    <%= profile_avatar_tag(profile, size: 24, class: "ring-2 ring-white") %>
                  <% end %>
                </div>

                <%# 6. Owner (col-span-2) %>
                <div class="col-span-2 flex justify-center">
                  <div class="flex items-center gap-2 max-w-full">
                    <%= profile_avatar_tag(activity.owner_profile, size: 20) %>
                    <span class="text-[11px] text-gray-500 truncate"><%= activity.owner_profile.name %></span>
                  </div>
                </div>

                <%# 7. Action (col-span-1) %>
                <div class="col-span-1 flex justify-center">
                  <% if activity.owner_profile == @current_profile %>
                    <%= button_to activity_path(activity), 
                                  method: :delete, 
                                  data: { turbo_confirm: '本当に削除しますか？' }, 
                                  class: "text-[10px] font-bold text-gray-400 hover:text-rose-600 transition-colors py-1 px-2 rounded-md hover:bg-rose-50" do %>
                      削除
                    <% end %>
                  <% end %>
                </div>

              </div>
            <% end %>
          <% else %>
            <div class="py-20 text-center text-gray-300 font-medium">データはありません</div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>-e \n--- END OF FILE ---\n
app/views/tasks/_sidebar.html.erb
--- START OF FILE ---
<!-- app/views/tasks/_sidebar.html.erb -->
<nav class="space-y-1">
  <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider px-3 mb-2">Tasks & Schedules</p>

  <%# 今日のタスク %>
  <%= link_to tasks_path(filter: 'today'), 
      class: "flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors #{params[:filter] == 'today' ? 'bg-emerald-100 text-emerald-900' : 'text-gray-700 hover:bg-gray-100'}" do %>
    <svg xmlns="http://www.w3.org/2000/svg" class="mr-3 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
    </svg>
    今日のタスクとイベント
  <% end %>

  <%# 今週のタスク %>
  <%= link_to tasks_path(filter: 'week'), 
      class: "flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors #{params[:filter] == 'week' ? 'bg-emerald-100 text-emerald-900' : 'text-gray-700 hover:bg-gray-100'}" do %>
    <svg xmlns="http://www.w3.org/2000/svg" class="mr-3 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
    </svg>
    今週のタスクとイベント
  <% end %>

  <%# 全てのタスク %>
  <%= link_to tasks_path, 
      class: "flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors #{params[:filter].blank? ? 'bg-emerald-100 text-emerald-900' : 'text-gray-700 hover:bg-gray-100'}" do %>
    <svg xmlns="http://www.w3.org/2000/svg" class="mr-3 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
    </svg>
    全てのタスクとイベント
  <% end %>

  <%# 未完了のタスク %>
  <%= link_to tasks_path(filter: 'todo'), 
      class: "flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors #{params[:filter] == 'todo' ? 'bg-emerald-100 text-emerald-900' : 'text-gray-700 hover:bg-gray-100'}" do %>
    <svg xmlns="http://www.w3.org/2000/svg" class="mr-3 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    未完了のタスク
  <% end %>
</nav>-e \n--- END OF FILE ---\n
app/views/tasks/edit.html.erb
--- START OF FILE ---
<%# app/views/tasks/edit.html.erb %>
<%= turbo_frame_tag dom_id(@task.activity) do %>
  <div class="bg-emerald-50/50 p-8 border-b-2 border-emerald-500 my-2 shadow-inner rounded-xl">
    <div class="max-w-4xl mx-auto">
      <h3 class="text-sm font-bold text-emerald-600 mb-4 uppercase tracking-widest">Edit Task</h3>
      <%# 新規作成で使っているコンポーネントをそのまま呼び出し %>
      <%= render 'components/task_form', task: @task %>
    </div>
  </div>
<% end %>-e \n--- END OF FILE ---\n
app/views/tasks/new.html.erb
--- START OF FILE ---
<!-- app/views/tasks/new.html.erb -->
<% content_for :sidebar do %>
  <%= render 'sidebar' %>
<% end %>

<div class="max-w-2xl mx-auto px-4 py-8">
  <div class="mb-8">
    <h2 class="text-2xl font-bold text-gray-900">新規タスク作成</h2>
    <p class="mt-1 text-sm text-gray-500">共通の公開設定とタスクの詳細を入力してください。</p>
  </div>

  <%= form_with(model: @task, class: "space-y-8") do |f| %>
    
    <%# --- Activity (共通項目) セクション --- %>
    <div class="bg-gray-50 p-6 rounded-2xl border border-gray-200 space-y-6">
      <h3 class="text-sm font-bold text-gray-700 uppercase tracking-wider">共通設定</h3>
      
      <%= f.fields_for :activity do |af| %>
        <div>
          <%= af.label :title, "タイトル", class: "block text-sm font-medium text-gray-700" %>
          <%= af.text_field :title, placeholder: "何をしますか？", class: "mt-1 block w-full border-gray-300 rounded-xl shadow-sm focus:ring-[#00a968] focus:border-[#00a968] sm:text-sm" %>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <%= af.label :visibility_range, "公開範囲", class: "block text-sm font-medium text-gray-700" %>
            <%= af.select :visibility_range, 
                Activity.visibility_ranges_i18n.invert, 
                {}, 
                class: "mt-1 block w-full border-gray-300 rounded-xl shadow-sm focus:ring-[#00a968] focus:border-[#00a968] sm:text-sm" %>
          </div>

          <div>
            <%= af.label :status, "公開ステータス", class: "block text-sm font-medium text-gray-700" %>
            <%= af.select :status, 
                Activity.statuses_i18n.invert, 
                {}, 
                class: "mt-1 block w-full border-gray-300 rounded-xl shadow-sm focus:ring-[#00a968] focus:border-[#00a968] sm:text-sm" %>
          </div>
        </div>
      <% end %>
    </div>

    <%# --- Task (固有項目) セクション --- %>
    <div class="space-y-6 px-2">
      <h3 class="text-sm font-bold text-gray-700 uppercase tracking-wider">タスク詳細</h3>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <%= f.label :status, "進捗状況", class: "block text-sm font-medium text-gray-700" %>
          <%= f.select :status, 
              Task.statuses_i18n.invert, 
              {}, 
              class: "mt-1 block w-full border-gray-300 rounded-xl shadow-sm focus:ring-[#00a968] focus:border-[#00a968] sm:text-sm" %>
        </div>

        <div>
          <%= f.label :deadline, "期限", class: "block text-sm font-medium text-gray-700" %>
          <%= f.datetime_field :deadline, class: "mt-1 block w-full border-gray-300 rounded-xl shadow-sm focus:ring-[#00a968] focus:border-[#00a968] sm:text-sm" %>
        </div>
      </div>

      <div>
        <%= f.label :content, "説明・メモ", class: "block text-sm font-medium text-gray-700" %>
        <%= f.text_area :content, rows: 4, placeholder: "詳細な内容を入力してください", class: "mt-1 block w-full border-gray-300 rounded-xl shadow-sm focus:ring-[#00a968] focus:border-[#00a968] sm:text-sm" %>
      </div>
    </div>

    <div class="pt-5 border-t border-gray-200 flex justify-end gap-3">
      <%= link_to "キャンセル", tasks_path, class: "px-6 py-2 border border-gray-300 rounded-xl text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors" %>
      <%= f.submit "タスクを作成", class: "px-6 py-2 bg-[#00a968] text-white rounded-xl text-sm font-bold hover:bg-[#008f58] transition-colors cursor-pointer shadow-md" %>
    </div>
  <% end %>
</div>-e \n--- END OF FILE ---\n
app/views/room_messages/_thread.html.erb
--- START OF FILE ---
<%# app/views/room_messages/_thread.html.erb %>
<div class="space-y-6">
  <%# 親メッセージのコピー %>
  <div class="flex items-start gap-3 pb-6 border-b border-gray-100">
    <%= profile_avatar_tag(@parent_activity.owner_profile, size: 36, class: "rounded shadow-sm") %>
    <div class="flex-1 min-w-0">
      <div class="flex items-baseline gap-2 mb-1">
        <span class="font-black text-gray-900 text-[15px]"><%= @parent_activity.owner_profile.name %></span>
        <span class="text-[11px] text-gray-400"><%= @parent_activity.created_at.strftime("%H:%M") %></span>
      </div>
      <div class="text-gray-800 text-[14px] leading-relaxed">
        <%= simple_format(@parent_message.content) %>
      </div>
    </div>
  </div>

  <%# 返信一覧 %>
  <div class="space-y-5">
    <div class="flex items-center gap-2">
      <span class="text-[11px] font-bold text-gray-400 uppercase tracking-wider">返信 <%= @comments.count %> 件</span>
      <div class="h-[1px] flex-1 bg-gray-50"></div>
    </div>
    
    <% if @comments.any? %>
      <% @comments.each do |c_act| %>
        <div class="flex items-start gap-3 group/comment">
          <%= profile_avatar_tag(c_act.owner_profile, size: 28, class: "rounded") %>
          <div class="flex-1 min-w-0">
            <div class="flex items-baseline gap-2 mb-0.5">
              <span class="font-bold text-gray-900 text-[13px]"><%= c_act.owner_profile.name %></span>
              <span class="text-[10px] text-gray-400"><%= c_act.created_at.strftime("%H:%M") %></span>
            </div>
            <div class="text-gray-700 text-[13px] leading-snug">
              <%= simple_format(c_act.actable.content) %>
            </div>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="py-8 text-center">
        <p class="text-[12px] text-gray-400">まだ返信はありません</p>
      </div>
    <% end %>
  </div>
</div>-e \n--- END OF FILE ---\n
app/views/schedules/edit.html.erb
--- START OF FILE ---
<!-- app/views/schedules/edit.html.erb -->
<%= turbo_frame_tag dom_id(@schedule.activity) do %>
  <div class="bg-blue-50/50 p-8 border-b-2 border-blue-500 my-2 shadow-inner rounded-xl">
    <div class="max-w-4xl mx-auto">
      <h3 class="text-sm font-bold text-blue-600 mb-4 uppercase tracking-widest">Edit Schedule</h3>
      <%= render 'components/schedule_form', schedule: @schedule %>
    </div>
  </div>
<% end %>-e \n--- END OF FILE ---\n
app/views/active_storage/blobs/_blob.html.erb
--- START OF FILE ---
<figure class="attachment attachment--<%= blob.representable? ? "preview" : "file" %> attachment--<%= blob.filename.extension %>">
  <% if blob.representable? %>
    <%= image_tag blob.representation(resize_to_limit: local_assigns[:in_gallery] ? [ 800, 600 ] : [ 1024, 768 ]) %>
  <% end %>

  <figcaption class="attachment__caption">
    <% if caption = blob.try(:caption) %>
      <%= caption %>
    <% else %>
      <span class="attachment__name"><%= blob.filename %></span>
      <span class="attachment__size"><%= number_to_human_size blob.byte_size %></span>
    <% end %>
  </figcaption>
</figure>
-e \n--- END OF FILE ---\n
app/views/components/_schedule_form.html.erb
--- START OF FILE ---
<%# app/views/components/_schedule_form.html.erb %>
<div x-data="{ 
  scope: '<%= schedule.activity&.visibility_range || 'is_private' %>', 
  roomId: '<%= schedule.activity&.chat_room_id %>' 
}" class="space-y-6 text-left">

  <%= form_with(model: schedule, url: schedule.persisted? ? schedule_path(schedule) : schedules_path, class: "space-y-4") do |f| %>
    <%= f.fields_for :activity do |af| %>
      <%= af.hidden_field :id %>

      <%# --- タイトル --- %>
      <%= af.text_field :title, placeholder: "予定のタイトル...", class: "w-full border-none focus:ring-0 text-xl font-bold placeholder-gray-300 p-0 bg-transparent" %>

      <div class="py-4 border-y border-gray-100 space-y-4">
        <%# --- 日時設定 --- %>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">開始日時</label>
            <%= f.datetime_field :start_at, class: "w-full border-gray-200 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500" %>
          </div>
          <div>
            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">終了日時</label>
            <%= f.datetime_field :end_at, class: "w-full border-gray-200 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500" %>
          </div>
        </div>

        <%# --- 権限範囲 --- %>
        <div>
          <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">公開範囲</label>
          <% 
            options = { "is_private" => "プライベート" }
            options["is_team"] = "チームメンバー" if @current_profile.team.present?
            options["is_chat_room"] = "ルームメンバー"
          %>
          <%= af.select :visibility_range, 
              options.invert, 
              {}, 
              { "x-model": "scope", class: "w-full border-gray-200 rounded-lg text-sm" } 
          %>
        </div>
      </div>

      <%# --- ルーム選択 (アバター表示追加) --- %>
      <template x-if="scope === 'is_chat_room'">
        <div class="bg-blue-50 p-4 rounded-xl space-y-3 mb-4 shadow-inner">
          <label class="block text-xs font-bold text-blue-700">対象のルームを選択</label>
          <div class="relative">
            <%= af.collection_select :chat_room_id, @current_profile.chat_rooms, :id, :display_name, 
                { prompt: "ルームを選択してください" }, 
                { "x-model": "roomId", class: "w-full border-blue-200 rounded-lg text-sm pl-3 pr-10 appearance-none bg-white h-11" } %>
            
            <%# ルームアバターの動的表示 %>
            <div class="absolute right-10 top-1/2 -translate-y-1/2 pointer-events-none">
              <% @current_profile.chat_rooms.each do |room| %>
                <div x-show="roomId == '<%= room.id %>'">
                  <%= profile_avatar_tag(room, class: "h-6 w-6 rounded shadow-sm object-cover", size: 24) %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </template>

      <%# --- 権限詳細 --- %>
      <div class="flex gap-4 items-center bg-gray-50 p-3 rounded-lg">
        <div class="flex-1">
          <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">許可する操作</label>
          <div class="flex gap-6">
            <label class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
              <%= af.radio_button :permission_type, :read_only, class: "text-blue-600 focus:ring-blue-500" %> 閲覧のみ
            </label>
            <label class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
              <%= af.radio_button :permission_type, :edit_only, class: "text-blue-600 focus:ring-blue-500" %> 閲覧・編集
            </label>
          </div>
        </div>
      </div>
    <% end %>

    <%# --- 招待者設定 (アバター表示追加) --- %>
    <div class="space-y-3 pt-2">
      <label class="block text-[10px] font-bold text-gray-400 uppercase">参加者の招待</label>
      <div class="space-y-3">
        <%# 自分 %>
        <div class="flex items-center gap-3 p-2 border border-blue-100 bg-blue-50 rounded-lg w-fit pr-4">
          <%= profile_avatar_tag(@current_profile, class: "h-6 w-6 rounded-full shadow-sm", size: 24) %>
          <span class="text-xs font-bold text-blue-700"><%= @current_profile.name %> (自分)</span>
          <%= f.hidden_field :invitee_ids, name: "schedule[invitee_ids][]", value: @current_profile.id %>
        </div>

        <%# チームメンバー候補 %>
        <div x-show="scope === 'is_team'" x-cloak class="p-3 bg-gray-50 rounded-lg border border-gray-100">
          <div class="grid grid-cols-2 gap-2">
            <% if @current_profile.team.present? %>
              <% @current_profile.team.profiles.where.not(id: @current_profile.id).each do |profile| %>
                <label class="flex items-center gap-3 text-xs text-gray-700 bg-white p-2 rounded border border-gray-100 cursor-pointer hover:bg-gray-50 transition-colors">
                  <%= f.check_box :invitee_ids, { name: "schedule[invitee_ids][]", class: "rounded text-blue-600 focus:ring-blue-500" }, profile.id, nil %>
                  <%= profile_avatar_tag(profile, class: "h-6 w-6 rounded-full shadow-sm", size: 24) %>
                  <span class="truncate"><%= profile.name %></span>
                </label>
              <% end %>
            <% end %>
          </div>
        </div>

        <%# ルームメンバー候補 %>
        <div x-show="scope === 'is_chat_room' && roomId" x-cloak class="p-3 bg-blue-50 rounded-lg border border-blue-100">
          <% @current_profile.chat_rooms.each do |room| %>
            <template x-if="roomId == '<%= room.id %>'">
              <div class="grid grid-cols-2 gap-2">
                <% room.profiles.where.not(id: @current_profile.id).each do |profile| %>
                  <label class="flex items-center gap-3 text-xs text-gray-700 bg-white p-2 rounded border border-blue-100 cursor-pointer hover:bg-blue-50 transition-colors">
                    <%= f.check_box :invitee_ids, { name: "schedule[invitee_ids][]", class: "rounded text-blue-600 focus:ring-blue-500" }, profile.id, nil %>
                    <%= profile_avatar_tag(profile, class: "h-6 w-6 rounded-full shadow-sm", size: 24) %>
                    <span class="truncate"><%= profile.name %></span>
                  </label>
                <% end %>
              </div>
            </template>
          <% end %>
        </div>
      </div>
    </div>

    <%= f.text_area :describe, placeholder: "詳細（場所やメモなど）", class: "w-full border-gray-200 rounded-lg text-sm mt-4 focus:ring-blue-500 focus:border-blue-500", rows: 3 %>

    <div class="flex justify-end gap-2 pt-4">
      <% if schedule.persisted? %>
        <%= link_to 'キャンセル', schedules_path, class: "text-sm text-gray-500 px-4 font-bold flex items-center" %>
      <% else %>
        <button type="button" @click="open_form = null" class="text-sm text-gray-500 px-4 font-bold">キャンセル</button>
      <% end %>
      <%= f.submit schedule.persisted? ? "予定を更新" : "予定を保存", class: "bg-blue-600 text-white px-8 py-2.5 rounded-xl text-sm font-bold shadow-md shadow-blue-100 cursor-pointer hover:bg-blue-700 transition-colors" %>
    </div>
  <% end %>
</div>-e \n--- END OF FILE ---\n
app/views/components/_activity_fields.html.erb
--- START OF FILE ---
<!-- app/views/components/_activity_fields.html.erb -->
<%# Activityのメタデータ設定用共通パーツ %>
<div x-data="{ 
  scope: '<%= f.object.visibility_range || 'is_private' %>', 
  roomId: '<%= f.object.chat_room_id %>' 
}" class="space-y-4">
  
  <div class="grid grid-cols-2 gap-6 py-4 border-y border-gray-100">
    <%# --- 権限範囲 --- %>
    <div>
      <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">公開範囲</label>
      <% 
        options = { "is_private" => "プライベート" }
        options["is_team"] = "チームメンバー" if @current_profile.team.present?
        options["is_chat_room"] = "ルームメンバー"
        options["is_public"] = "パブリック（全体）" # Works向けに追加
      %>
      <%= f.select :visibility_range, options.invert, {}, { "x-model": "scope", class: "w-full border-gray-200 rounded-lg text-sm" } %>
    </div>

    <%# --- ルーム選択 --- %>
    <div x-show="scope === 'is_chat_room'" x-cloak>
      <label class="block text-[10px] font-bold text-emerald-700 uppercase mb-1">対象ルーム</label>
      <%= f.collection_select :chat_room_id, @current_profile.chat_rooms, :id, :display_name, 
          { prompt: "選択してください" }, 
          { "x-model": "roomId", class: "w-full border-emerald-200 rounded-lg text-sm" } %>
    </div>
  </div>

  <%# --- 権限詳細 --- %>
  <div class="flex gap-4 items-center bg-gray-50 p-3 rounded-lg">
    <div class="flex-1">
      <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">許可する操作</label>
      <div class="flex gap-4">
        <label class="flex items-center gap-2 text-sm text-gray-600">
          <%= f.radio_button :permission_type, :read_only %> 閲覧のみ
        </label>
        <label class="flex items-center gap-2 text-sm text-gray-600">
          <%= f.radio_button :permission_type, :edit_only %> 閲覧・編集
        </label>
      </div>
    </div>
    <div class="flex gap-3 border-l border-gray-200 pl-4">
      <label class="flex items-center gap-1.5 text-[11px] text-gray-500">
        <%= f.check_box :allow_comment %> コメント可
      </label>
      <label class="flex items-center gap-1.5 text-[11px] text-gray-500">
        <%= f.check_box :allow_reaction %> 反応可
      </label>
    </div>
  </div>
</div>-e \n--- END OF FILE ---\n
app/views/components/_task_form.html.erb
--- START OF FILE ---
<!-- app/views/components/_task_form.html.erb -->
<div x-data="{ 
  scope: '<%= task.activity.visibility_range %>', 
  roomId: '<%= task.activity.chat_room_id %>' 
}" class="space-y-6">

  <%= form_with(model: task, class: "space-y-4") do |f| %>
    <%= f.fields_for :activity do |af| %>
      <%= af.hidden_field :id %>

      <%# --- タイトル --- %>
      <%= af.text_field :title, placeholder: "タスク名を入力...", class: "w-full border-none focus:ring-0 text-xl font-bold placeholder-gray-300 p-0" %>

      <div class="grid grid-cols-2 gap-6 py-4 border-y border-gray-100">
        <%# --- 締切 --- %>
        <div>
          <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">締切</label>
          <%= f.datetime_field :deadline, class: "w-full border-gray-200 rounded-lg text-sm" %>
        </div>

        <%# --- 権限範囲 --- %>
        <div>
          <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">閲覧・編集の範囲</label>
          <% 
            options = { "is_private" => "プライベート" }
            options["is_team"] = "チームメンバー" if @current_profile.team.present?
            options["is_chat_room"] = "ルームメンバー"
          %>
          <%= af.select :visibility_range, 
              options.invert, 
              {}, 
              { "x-model": "scope", class: "w-full border-gray-200 rounded-lg text-sm" } 
          %>
        </div>
      </div>

      <%# --- ルーム選択 (アバター付き) --- %>
      <template x-if="scope === 'is_chat_room'">
        <div class="bg-emerald-50 p-4 rounded-xl space-y-3 mb-4 shadow-inner">
          <label class="block text-xs font-bold text-emerald-700 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
            対象のルームを選択
          </label>
          
          <div class="relative">
            <%= af.collection_select :chat_room_id, @current_profile.chat_rooms, :id, :display_name, 
                { prompt: "ルームを選択してください" }, 
                { "x-model": "roomId", class: "w-full border-emerald-200 rounded-lg text-sm pl-3 pr-10 appearance-none bg-white h-11" } %>
            
            <%# 選択中のルームアバターを表示 %>
            <div class="absolute right-10 top-1/2 -translate-y-1/2 pointer-events-none">
              <% @current_profile.chat_rooms.each do |room| %>
                <div x-show="roomId == '<%= room.id %>'">
                  <%= profile_avatar_tag(room, class: "h-6 w-6 rounded shadow-sm object-cover", size: 24) %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </template>

      <%# --- 権限種別 --- %>
      <div class="flex gap-4 items-center bg-gray-50 p-3 rounded-lg">
        <div class="flex-1">
          <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">許可する操作</label>
          <div class="flex gap-6">
            <label class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
              <%= af.radio_button :permission_type, :read_only, class: "text-emerald-600 focus:ring-emerald-500" %> 閲覧のみ
            </label>
            <label class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
              <%= af.radio_button :permission_type, :edit_only, class: "text-emerald-600 focus:ring-emerald-500" %> 閲覧・編集
            </label>
          </div>
        </div>
      </div>
    <% end %>

    <%# --- 担当者設定 (アバター付き) --- %>
    <div class="space-y-3 pt-2">
      <label class="block text-[10px] font-bold text-gray-400 uppercase">担当者設定</label>
      <div class="p-3 bg-gray-50 rounded-lg border border-gray-100">
        <div class="grid grid-cols-2 gap-2">
          <%# 自分 %>
          <label class="flex items-center gap-3 text-xs font-bold text-emerald-700 bg-emerald-50 p-2 rounded border border-emerald-100 cursor-pointer">
            <%= f.check_box :assignee_ids, { name: "task[assignee_ids][]", class: "rounded text-emerald-600" }, @current_profile.id, nil %>
            <%= profile_avatar_tag(@current_profile, class: "h-6 w-6 rounded-full shadow-sm", size: 24) %>
            <span class="truncate"><%= @current_profile.name %> (自分)</span>
          </label>

          <%# チームメンバー %>
          <template x-if="scope === 'is_team'">
            <% if @current_profile.team.present? %>
              <div class="contents">
                <% @current_profile.team.profiles.where.not(id: @current_profile.id).each do |profile| %>
                  <label class="flex items-center gap-3 text-xs text-gray-700 bg-white p-2 rounded border border-gray-100 cursor-pointer hover:bg-gray-50 transition-colors">
                    <%= f.check_box :assignee_ids, { name: "task[assignee_ids][]", class: "rounded text-emerald-600" }, profile.id, nil %>
                    <%= profile_avatar_tag(profile, class: "h-6 w-6 rounded-full shadow-sm", size: 24) %>
                    <span class="truncate"><%= profile.name %></span>
                  </label>
                <% end %>
              </div>
            <% end %>
          </template>

          <%# ルームメンバー %>
          <template x-if="scope === 'is_chat_room' && roomId">
            <% @current_profile.chat_rooms.each do |room| %>
              <div x-show="roomId == '<%= room.id %>'" class="contents">
                <% room.profiles.where.not(id: @current_profile.id).each do |profile| %>
                  <label class="flex items-center gap-3 text-xs text-gray-700 bg-white p-2 rounded border border-emerald-100 cursor-pointer hover:bg-emerald-50 transition-colors">
                    <%= f.check_box :assignee_ids, { name: "task[assignee_ids][]", class: "rounded text-emerald-600" }, profile.id, nil %>
                    <%= profile_avatar_tag(profile, class: "h-6 w-6 rounded-full shadow-sm", size: 24) %>
                    <span class="truncate"><%= profile.name %></span>
                  </label>
                <% end %>
              </div>
            <% end %>
          </template>
        </div>
      </div>
    </div>

    <%= f.text_area :describe, placeholder: "詳細（任意）", class: "w-full border-gray-200 rounded-lg text-sm mt-4 focus:ring-emerald-500 focus:border-emerald-500", rows: 3 %>

    <div class="flex justify-end gap-2 pt-4">
      <% if task.persisted? %>
        <%= link_to 'キャンセル', tasks_path, class: "text-sm text-gray-500 px-4 font-bold flex items-center" %>
      <% else %>
        <button type="button" @click="open_form = null" class="text-sm text-gray-500 px-4 font-bold">キャンセル</button>
      <% end %>
      <%= f.submit task.persisted? ? "更新する" : "タスクを保存", class: "bg-emerald-600 text-white px-8 py-2.5 rounded-xl text-sm font-bold shadow-md shadow-emerald-100 cursor-pointer hover:bg-emerald-700 transition-colors" %>
    </div>
  <% end %>
</div>-e \n--- END OF FILE ---\n
app/views/social_posts/index.html.erb
--- START OF FILE ---
<!-- app/views/posts/index.html.erb -->
<% content_for :sidebar do %>
  <%= render 'social_posts/sidebar' %>
<% end %>

<% my_current_profile = current_profile %>

<style>
  main { overflow: hidden !important; height: 100% !important; }
  main > div { padding: 0 !important; max-width: none !important; height: 100% !important; }
  
  .slack-scrollbar::-webkit-scrollbar { width: 8px; }
  .slack-scrollbar::-webkit-scrollbar-track { background: transparent; }
  .slack-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 4px; }

  .chat-layout-container { display: flex; width: 100%; height: 100%; overflow: hidden; }
  .main-chat-area { flex: 1; display: flex; flex-direction: column; min-width: 0; transition: all 0.2s ease-in-out; }
  #thread_panel { width: 0; background: white; display: none; flex-direction: column; border-left: 1px solid #e5e7eb; transition: width 0.2s ease-in-out; }
  #thread_panel.show { width: 450px; display: flex; }
  .chat-input-container { overflow: visible !important; }
  .draft-dropdown { z-index: 100; }
</style>

<div class="chat-layout-container" id="social_container" data-open-thread-id="<%= params[:thread_id] %>">
  
  <div class="main-chat-area">
    <header class="flex-shrink-0 h-16 px-6 border-b border-gray-200 flex justify-between items-center bg-white z-10 shadow-sm">
      <div class="flex items-center gap-3">
        <div class="h-8 w-8 bg-emerald-100 rounded-lg flex items-center justify-center text-emerald-600 font-bold">S</div>
        <h2 class="font-black text-gray-900 text-lg">
          <%= case params[:filter]
              when 'team' then 'チームのタイムライン'
              when 'mine' then '自分の投稿'
              when 'draft' then '下書き一覧'
              else '全ての投稿'
              end %>
        </h2>
      </div>
    </header>

    <div class="flex-1 overflow-y-auto bg-white slack-scrollbar" id="messages_area">
      <div class="py-6">
        <% if @no_team_scoped %>
          <div class="flex flex-col items-center justify-center py-20 px-6 text-center">
            <h3 class="text-lg font-bold text-gray-900 mb-2">チームに所属していません</h3>
            <%= link_to "チームを作成する", new_team_path, class: "px-4 py-2 bg-[#00a968] text-white rounded-md text-sm font-bold" %>
          </div>
        <% else %>
          <% @activities.each do |activity| %>
            <div class="flex items-start px-6 py-2 hover:bg-gray-50 transition-colors group relative border-b border-gray-50 last:border-0">
              <div class="flex-shrink-0 mr-4 mt-1">
                <%= profile_avatar_tag(activity.owner_profile, class: "h-10 w-10 rounded shadow-sm", size: 40) %>
              </div>
              <div class="flex-1 min-w-0">
                <div class="flex items-baseline gap-2 mb-0.5">
                  <span class="font-black text-gray-900 text-[15px]"><%= activity.owner_profile.name %></span>
                  <span class="text-[11px] text-gray-400"><%= activity.created_at.strftime("%H:%M") %></span>
                </div>
                <div class="text-gray-800 text-[15px] leading-relaxed break-words">
                  <%# リポスト表示ロジック %>
                  <% if activity.actable.is_a?(SocialRepost) %>
                    <% if activity.actable.content.present? %>
                      <div class="mb-2"><%= simple_format(activity.actable.content, {}, wrapper_tag: "span") %></div>
                    <% end %>
                    <div class="border border-gray-200 rounded-lg p-3 bg-gray-50 mt-1 mb-1">
                      <% if activity.actable.source_post.present? %>
                        <span class="font-bold text-xs text-gray-700"><%= activity.actable.source_post.owner_profile.name %></span>
                        <div class="text-sm text-gray-600"><%= simple_format(activity.actable.source_post.content, {}, wrapper_tag: "span") %></div>
                      <% else %>
                        <span class="text-xs italic text-gray-400">削除された投稿</span>
                      <% end %>
                    </div>
                  <% else %>
                    <%= simple_format(activity.actable.content, {}, wrapper_tag: "span") %>
                  <% end %>
                </div>

                <div class="mt-2 flex items-center gap-3">
                <%# Likeボタン %>
                <% user_liked = activity.like_activities.exists?(owner_profile: my_current_profile) %>
                <%= button_to activity_likes_path(activity), method: :post, 
                    class: "flex items-center gap-1.5 px-2 py-0.5 rounded-full border transition-all #{user_liked ? 'bg-pink-50 border-pink-200 text-pink-500' : 'bg-gray-50 border-gray-100 text-gray-400 hover:border-gray-300'}" do %>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 <%= 'fill-current' if user_liked %>" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
                    </svg>
                    <% if activity.likes_count > 0 %>
                    <span class="text-[11px] font-bold"><%= activity.likes_count %></span>
                    <% end %>
                <% end %>

                <%# 返信（スレッド）ボタン %>
                <button type="button" onclick="openSocialThread('<%= activity.id %>', '<%= activity.actable_id %>')" class="flex items-center gap-1 group/reply text-gray-400 hover:text-blue-500 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                    </svg>
                    <span class="text-[11px] font-bold">
                    <%= activity.comments_count > 0 ? "#{activity.comments_count} 件の返信を表示" : "返信" %>
                    </span>
                </button>
                </div>
              </div>

              <%# ホバーアクション（リポスト・編集） %>
              <div class="absolute right-6 top-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
                <button type="button" onclick="setRepostMode('<%= activity.actable.id %>', '<%= j (activity.actable.is_a?(SocialRepost) ? activity.actable.source_post.content : activity.actable.content).truncate(30) %>', '<%= activity.owner_profile.name %>')" class="p-1.5 bg-white border border-gray-200 rounded shadow-sm text-gray-500">♻️</button>
                <% if activity.owner_profile == my_current_profile %>
                  <button type="button" onclick="setEditMode('<%= activity.actable.id %>', '<%= j activity.actable.content %>', '<%= activity.visibility_range %>')" class="p-1.5 bg-white border border-gray-200 rounded shadow-sm text-gray-500">✏️</button>
                <% end %>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>

    <%# --- 復活：下書き対応・高機能フッター --- %>
    <footer class="flex-shrink-0 px-6 py-4 border-t border-gray-100 bg-white">
      <%= form_with(model: SocialPost.new, url: social_posts_path(filter: params[:filter]), id: "chat_form", class: "relative") do |f| %>
        <input type="hidden" name="post_id" id="editing_message_id" value="">
        <input type="hidden" name="source_post_id" id="repost_source_id" value="">
        <input type="hidden" name="commit_type" id="commit_type" value="publish">
        
        <div id="edit_label" class="hidden text-[11px] font-bold text-[#00a968] mb-1">編集/下書き再開中 (Escで解除)</div>
        <div id="reply_preview" class="hidden flex items-center justify-between mb-2 p-2 bg-blue-50 border border-blue-100 rounded text-[11px] text-blue-700">
          <span class="font-bold truncate">💬 <span id="reply_user_name"></span> さんに返信中</span>
          <button type="button" onclick="clearReplyMode()" class="text-blue-500 font-black">×</button>
        </div>
        <div id="repost_preview" class="hidden flex items-center justify-between mb-2 p-2 bg-emerald-50 border border-emerald-100 rounded text-[11px] text-emerald-700">
          <span class="font-bold truncate">♻️ <span id="repost_user_name"></span> さんのポストをリポスト中</span>
          <button type="button" onclick="clearRepostMode()" class="text-emerald-500 font-black">×</button>
        </div>

        <div class="border-2 border-gray-200 rounded-lg focus-within:border-[#00a968] bg-white chat-input-container">
          <%= f.text_area :content, placeholder: "今の気持ちをシェアしましょう", rows: 1, class: "block w-full border-none focus:ring-0 py-3 px-4 text-[15px] resize-none", id: "message_textarea" %>
          
          <div class="flex items-center justify-between px-2 py-1.5 bg-gray-50 border-t border-gray-100">
            <div class="flex items-center gap-4 text-[10px] text-gray-400 font-bold">
              <label class="cursor-pointer"><%= radio_button_tag :visibility_range, :is_public, true %> 公開</label>
              <label class="cursor-pointer"><%= radio_button_tag :visibility_range, :is_team, false, disabled: my_current_profile.team_id.blank? %> チーム</label>
            </div>
            
            <div class="flex items-center gap-2">
              <%# 下書きトレイ %>
                <% my_drafts = Activity.where(actable_type: 'SocialPost', owner_profile: my_current_profile).draft.order(updated_at: :desc) %>
                <details class="relative group">
                <summary class="list-none cursor-pointer px-2 py-1 hover:bg-gray-200 rounded text-[10px] text-gray-600 font-bold flex items-center gap-1">
                    <span>下書きトレイ</span>
                    <span class="bg-gray-300 text-white px-1.5 rounded-full"><%= my_drafts.count %></span>
                </summary>
                <div class="absolute bottom-full right-0 mb-2 w-72 bg-white border border-gray-200 shadow-xl rounded-lg py-2 draft-dropdown">
                    <div class="px-3 py-1 border-b border-gray-50 text-[9px] font-bold text-gray-400 uppercase tracking-wider">保存済みの下書き</div>
                    <div class="max-h-60 overflow-y-auto slack-scrollbar">
                    <% if my_drafts.any? %>
                        <% my_drafts.each do |draft| %>
                        <div class="px-3 py-2 hover:bg-emerald-50 border-b border-gray-50 last:border-0 flex justify-between items-start gap-2 group/draft">
                            <div class="flex-1 min-w-0">
                            <p class="text-[12px] text-gray-600 truncate leading-tight"><%= draft.actable.content.presence || "(本文なし)" %></p>
                            <p class="text-[9px] text-gray-400 mt-0.5"><%= draft.updated_at.strftime("%m/%d %H:%M") %></p>
                            </div>
                            <div class="flex items-center gap-2 shrink-0">
                            <%# 再開ボタン %>
                            <button type="button" 
                                    onclick="setEditMode('<%= draft.actable_id %>', '<%= j draft.actable.content %>', '<%= draft.visibility_range %>')" 
                                    class="text-[10px] text-[#00a968] font-bold hover:underline">再開</button>
                            
                            <%# 削除（アーカイブ）ボタン：Activityを消す、またはstatusを更新する設計に合わせる %>
                            <%= link_to social_post_path(draft.actable), 
                                        data: { turbo_method: :delete, turbo_confirm: "この下書きを削除しますか？" }, 
                                        class: "text-gray-300 hover:text-red-500 transition-colors" do %>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            <% end %>
                            </div>
                        </div>
                        <% end %>
                    <% else %>
                        <div class="px-3 py-4 text-center text-xs text-gray-400 font-medium">下書きはありません</div>
                    <% end %>
                    </div>
                </div>
                </details>

              <button type="button" onclick="submitAsDraft()" class="text-[10px] text-gray-500 font-bold px-2 py-1 hover:bg-gray-200 rounded">下書き保存</button>
              <%= f.button type: :submit, class: "p-1.5 text-[#00a968] hover:bg-emerald-50 rounded-md" do %>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M12 19l9-2-9-18-9 18 9 2zm0 0v-8" /></svg>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </footer>
  </div>

  <div id="thread_panel" class="flex-shrink-0">
    <header class="h-16 px-6 border-b border-gray-200 flex justify-between items-center bg-gray-50 shrink-0">
      <h3 class="font-black text-gray-900">スレッド</h3>
      <button onclick="closeSocialThread()" class="text-gray-400 hover:text-gray-600 font-black">×</button>
    </header>
    <div id="thread_content" class="flex-1 overflow-y-auto p-4 bg-white"></div>
  </div>
</div>

<script>
  function adjustTextareaHeight(el) { if(el){ el.style.height='auto'; el.style.height=el.scrollHeight+'px'; } }

  // --- モード管理 ---
  function clearEditMode() {
    document.getElementById('editing_message_id').value = "";
    document.getElementById('edit_label').classList.add('hidden');
    document.getElementById('message_textarea').value = "";
  }
  function clearRepostMode() {
    document.getElementById('chat_form').action = "<%= social_posts_path(filter: params[:filter]) %>";
    document.getElementById('repost_source_id').value = "";
    document.getElementById('repost_preview').classList.add('hidden');
  }
  function clearReplyMode() {
    document.getElementById('chat_form').action = "<%= social_posts_path(filter: params[:filter]) %>";
    document.getElementById('reply_preview').classList.add('hidden');
  }

  function setEditMode(id, content, visibility) {
    clearRepostMode(); clearReplyMode();
    const textarea = document.getElementById('message_textarea');
    document.getElementById('editing_message_id').value = id;
    textarea.value = content;
    document.getElementById('edit_label').classList.remove('hidden');
    const radio = document.querySelector(`input[name="visibility_range"][value="${visibility}"]`);
    if(radio) radio.checked = true;
    textarea.focus(); adjustTextareaHeight(textarea);
  }

  function setRepostMode(id, text, userName) {
    clearEditMode(); clearReplyMode();
    const form = document.getElementById('chat_form');
    form.action = `/social_posts/${id}/repost`;
    document.getElementById('repost_source_id').value = id;
    document.getElementById('repost_user_name').innerText = userName;
    document.getElementById('repost_preview').classList.remove('hidden');
    document.getElementById('message_textarea').focus();
  }

  function setReplyMode(activityId, userName) {
    clearEditMode(); clearRepostMode();
    const form = document.getElementById('chat_form');
    form.action = `/activities/${activityId}/comments`;
    document.getElementById('reply_user_name').innerText = userName;
    document.getElementById('reply_preview').classList.remove('hidden');
    document.getElementById('message_textarea').focus();
  }

  function submitAsDraft() {
    document.getElementById('commit_type').value = "draft";
    document.getElementById('chat_form').requestSubmit();
  }

  // --- スレッド操作 ---
  async function openSocialThread(activityId, postId) {
    const panel = document.getElementById('thread_panel');
    const content = document.getElementById('thread_content');
    panel.classList.add('show');
    content.innerHTML = '<div class="text-center py-10 text-xs text-gray-400">Loading...</div>';
    try {
      const response = await fetch(`/social_posts/${postId}/thread`);
      content.innerHTML = await response.text();
      setReplyMode(activityId, "スレッド");
      const url = new URL(window.location);
      url.searchParams.set('thread_id', activityId);
      window.history.replaceState({}, '', url);
    } catch (e) { content.innerHTML = 'Error'; }
  }

  function closeSocialThread() {
    document.getElementById('thread_panel').classList.remove('show');
    clearReplyMode();
    const url = new URL(window.location);
    url.searchParams.delete('thread_id');
    window.history.replaceState({}, '', url);
  }

  // --- 初期化 (二重登録防止) ---
  function initSocial() {
    const form = document.getElementById('chat_form');
    const textarea = document.getElementById('message_textarea');
    if (!form || !textarea) return;

    // スレッド自動再開
    const container = document.getElementById('social_container');
    const openThreadId = container?.dataset.openThreadId;
    if (openThreadId) {
      const btn = document.querySelector(`button[onclick*="openSocialThread('${openThreadId}'"]`);
      if (btn) { btn.click(); container.dataset.openThreadId = ""; }
    }

    const newTextarea = textarea.cloneNode(true);
    textarea.parentNode.replaceChild(newTextarea, textarea);

    newTextarea.addEventListener('input', function() { adjustTextareaHeight(this); });
    newTextarea.addEventListener('keydown', function(e) {
      if (e.isComposing) return;
      if (e.key === 'Enter' && e.shiftKey) {
        e.preventDefault();
        const submitBtn = form.querySelector('button[type="submit"]');
        if(submitBtn) submitBtn.disabled = true;
        form.requestSubmit();
      }
      if (e.key === 'Escape') { clearEditMode(); clearRepostMode(); clearReplyMode(); closeSocialThread(); }
    });
  }

  document.addEventListener("turbo:load", initSocial);
  if (document.readyState !== "loading") initSocial();
</script>-e \n--- END OF FILE ---\n
app/views/social_posts/_thread.html.erb
--- START OF FILE ---
<!-- app/views/social_posts/_thread.html.erb -->

<%# --- 親ポストの表示 --- %>
<div class="border-b border-gray-100 pb-5 mb-5">
  <div class="flex items-start gap-3">
    <%= profile_avatar_tag(@parent_activity.owner_profile, class: "h-10 w-10 rounded shadow-sm", size: 40) %>
    <div class="flex-1 min-w-0">
      <div class="flex items-baseline gap-2">
        <span class="font-black text-gray-900 text-[15px]"><%= @parent_activity.owner_profile.name %></span>
        <span class="text-[11px] text-gray-400 font-medium"><%= @parent_activity.created_at.strftime("%H:%M") %></span>
      </div>
      <div class="text-gray-800 text-[15px] leading-relaxed mt-1.5">
        <%= simple_format(@parent_post.content) %>
      </div>
      
      <%# 親ポストへの「いいね」状態などもここに出すとSNSらしくなります %>
      <div class="mt-3">
        <% user_liked = @parent_activity.like_activities.exists?(owner_profile: current_profile) %>
        <span class="text-[11px] font-bold <%= user_liked ? 'text-pink-500' : 'text-gray-400' %>">
          ❤️ <%= @parent_activity.like_activities.count %>
        </span>
      </div>
    </div>
  </div>
</div>

<%# --- コメント（スレッド返信）一覧 --- %>
<div class="space-y-5">
  <div class="flex items-center gap-2 mb-4">
    <span class="text-[11px] font-bold text-gray-400 uppercase tracking-wider">返信 <%= @comments.count %> 件</span>
    <div class="h-px flex-1 bg-gray-50"></div>
  </div>

  <% if @comments.any? %>
    <% @comments.each do |c_act| %>
      <div class="flex items-start gap-3 group">
        <%= profile_avatar_tag(c_act.owner_profile, class: "h-8 w-8 rounded shadow-xs", size: 32) %>
        <div class="flex-1 min-w-0">
          <div class="flex items-baseline gap-2">
            <span class="font-bold text-gray-900 text-[13px]"><%= c_act.owner_profile.name %></span>
            <span class="text-[10px] text-gray-400"><%= c_act.created_at.strftime("%H:%M") %></span>
          </div>
          <div class="text-gray-700 text-[14px] leading-relaxed mt-0.5">
            <%= simple_format(c_act.actable.content) %>
          </div>
        </div>
      </div>
    <% end %>
  <% else %>
    <div class="py-12 text-center text-gray-400">
      <p class="text-xs">この投稿にまだ返信はありません</p>
    </div>
  <% end %>
</div>-e \n--- END OF FILE ---\n
app/views/social_posts/_sidebar.html.erb
--- START OF FILE ---
<!-- app/views/social_post/_sidebar.html.erb -->
<nav class="space-y-1">
  <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider px-3 mb-2">Social</p>
  
  <%# 全てのポスト %>
  <%= link_to social_posts_path, 
      class: "flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors #{params[:filter].blank? ? 'bg-emerald-100 text-emerald-900' : 'text-gray-700 hover:bg-gray-100'}" do %>
    <svg xmlns="http://www.w3.org/2000/svg" class="mr-3 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
    </svg>
    全てのポスト
  <% end %>

  <%# チームのポスト %>
  <%= link_to social_posts_path(filter: 'team'), 
      class: "flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors #{params[:filter] == 'team' ? 'bg-emerald-100 text-emerald-900' : 'text-gray-700 hover:bg-gray-100'}" do %>
    <svg xmlns="http://www.w3.org/2000/svg" class="mr-3 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
    </svg>
    チームのポスト
  <% end %>

  <%# 自分のポスト %>
  <%= link_to social_posts_path(filter: 'mine'), 
      class: "flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors #{params[:filter] == 'mine' ? 'bg-emerald-100 text-emerald-900' : 'text-gray-700 hover:bg-gray-100'}" do %>
    <svg xmlns="http://www.w3.org/2000/svg" class="mr-3 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
    </svg>
    自分のポスト
  <% end %>

  <%# 下書き %>
  <%= link_to social_posts_path(filter: 'draft'), 
      class: "flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors #{params[:filter] == 'draft' ? 'bg-emerald-100 text-emerald-900' : 'text-gray-700 hover:bg-gray-100'}" do %>
    <svg xmlns="http://www.w3.org/2000/svg" class="mr-3 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9l-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
    </svg>
    下書き
  <% end %>
</nav>-e \n--- END OF FILE ---\n
app/views/social_posts/_form.html.erb
--- START OF FILE ---
-e \n--- END OF FILE ---\n
app/views/layouts/action_text/contents/_content.html.erb
--- START OF FILE ---
<div class="trix-content">
  <%= yield -%>
</div>
-e \n--- END OF FILE ---\n
app/views/layouts/_header.html.erb
--- START OF FILE ---
<!-- app/views/layouts/_header.html.erb -->
<header class="bg-[#00a968] shadow-sm z-10 text-white">
  <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
    
    <%# 左側：ロゴ ＋ 中央：(アラート & モジュール) エリア %>
    <div class="flex items-center flex-1">
      <%# ロゴセクション %>
      <%= link_to authenticated_root_path, class: "flex items-center gap-4 hover:opacity-80 transition-opacity flex-shrink-0" do %>
        <h1 class="text-2xl font-bold tracking-tight">Forestly</h1>
        <span class="text-xs text-emerald-100 bg-emerald-700 px-2 py-0.5 rounded">β V.4</span>
      <% end %>

      <%# 中央：上下分割エリア (左詰め) %>
      <div class="ml-10 flex flex-col justify-center h-16 flex-1 overflow-hidden">
        <%# 上段：アラート・アナウンスエリア (固定高さを確保) %>
        <div class="h-6 flex items-center">
          <% if notice %>
            <p class="text-[11px] font-medium bg-white/20 px-2 py-0.5 rounded animate-pulse"><%= notice %></p>
          <% elsif alert %>
            <p class="text-[11px] font-medium bg-red-500/40 px-2 py-0.5 rounded"><%= alert %></p>
          <% end %>
        </div>

        <%# 下段：モジュールボタンエリア %>
        <div class="flex items-center gap-6 mt-1">
          <% if current_user.profiles.any? %>
            <%# Tasks/Schedule リンク (新規追加) %>
            <%= link_to tasks_path, class: "hover:text-emerald-100 flex items-center transition-colors group" do %>
              <span class="text-[11px] font-bold uppercase tracking-wider group-hover:underline">Tasks/Schedule</span>
            <% end %>

            <%# Works リンク %>
            <%= link_to works_path, class: "hover:text-emerald-100 flex items-center transition-colors group" do %>
              <span class="text-[11px] font-bold uppercase tracking-wider group-hover:underline">Works</span>
            <% end %>

            <%# Caht リンク %>
            <%= link_to chat_rooms_path, class: "hover:text-emerald-100 flex items-center transition-colors group" do %>
              <span class="text-[11px] font-bold uppercase tracking-wider group-hover:underline">Chat</span>
            <% end %>

            <%# Social リンク %>
            <%= link_to social_posts_path, class: "hover:text-emerald-100 flex items-center transition-colors group" do %>
              <span class="text-[11px] font-bold uppercase tracking-wider group-hover:underline">Social</span>
            <% end %>

            <%# Profiles リンク %>
            <%= link_to edit_profile_path(current_profile), class: "hover:text-emerald-100 flex items-center transition-colors group" do %>
              <span class="text-[11px] font-bold uppercase tracking-wider group-hover:underline">Profiles</span>
            <% end %>

            <%# Teams リンク %>
            <%= link_to members_team_path, class: "hover:text-emerald-100 flex items-center transition-colors group" do %>
              <span class="text-[11px] font-bold uppercase tracking-wider group-hover:underline">Teams</span>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
    
    <%# 右側：プロフィール切り替え ＋ ログアウト %>
    <div class="flex items-center gap-6 flex-shrink-0">
      <% if current_user.profiles.any? %>
        <details class="relative group">
          <summary class="list-none cursor-pointer flex items-center gap-3 border-r border-white/20 pr-6 outline-none">
            <div class="text-right hidden sm:block">
              <p class="text-[9px] text-emerald-200 uppercase tracking-tighter leading-none mb-1">
              <%= current_profile.team&.display_name || "所属チームなし" %></p>
              <p class="text-sm font-black leading-none uppercase tracking-wide"><%= current_profile.label %></p>
              <p class="text-emerald-100 text-[10px] mt-0.5"><%= current_profile.name %></p>
            </div>
            <div class="relative">
              <%= profile_avatar_tag(current_profile, size: 36) %>
              <div class="absolute -bottom-1 -right-1 bg-white rounded-full p-0.5 shadow">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-[#00a968]" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
              </div>
            </div>
          </summary>

          <div class="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl border border-gray-100 py-2 z-50 text-gray-800">
            <div class="px-4 py-2 border-b border-gray-100">
              <p class="text-xs font-semibold text-gray-500 uppercase">プロフィールを切り替える</p>
            </div>
            <div class="max-height-64 overflow-y-auto">
              <% current_user.profiles.select(&:persisted?).each do |profile| %>
                <%= button_to switch_profile_path(profile), method: :patch, data: { turbo: false }, class: "w-full text-left px-4 py-3 hover:bg-emerald-50 flex items-center gap-3 transition-colors #{'bg-emerald-50 border-l-4 border-[#00a968]' if profile == current_profile}" do %>
                  <%= profile_avatar_tag(profile, size: 32) %>
                  <div>
                    <p class="text-[9px] text-gray-400 uppercase"><%= profile.team&.display_name || "所属チームなし" %></p>
                    <p class="text-sm font-bold leading-tight"><%= profile.label %></p>
                    <p class="text-[10px] text-gray-500"><%= profile.name %></p>
                  </div>
                <% end %>
              <% end %>
            </div>
            <div class="border-t border-gray-100 mt-2 px-2 py-2">
              <%= link_to edit_profile_path(current_profile), class: "flex items-center gap-2 px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-md" do %>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                プロフィール設定
              <% end %>
            </div>
          </div>
        </details>
      <% end %>

      <%= link_to "ログアウト", destroy_user_session_path, data: { turbo_method: :delete }, class: "text-xs text-white border border-white/30 px-3 py-1.5 rounded-md hover:bg-white/10 transition-colors" %>
    </div>
  </div>
</header>-e \n--- END OF FILE ---\n
app/views/layouts/application.html.erb
--- START OF FILE ---
<!-- app/views/layouts/application.html.erb -->
<!DOCTYPE html>
<html class="h-full bg-gray-50">
  <head>
    <title><%= content_for(:title) || "Forestly V4" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_include_tag "application", "data-turbo-track": "reload", type: "module" %>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  </head>

  <%# bodyをh-fullかつoverflow-hiddenにすることで、ブラウザ全体のスクロールを止めます %>
  <body class="h-full overflow-hidden text-gray-900">
    <% if user_signed_in? %>
      <div class="h-full flex flex-col">
        <%# 1. ヘッダーセクション（固定） %>
        <header class="flex-shrink-0 z-40">
          <%= render 'layouts/header' %>
        </header>

        <%# 2. 下部セクション（サイドバーとメイン） %>
        <div class="flex flex-1 overflow-hidden">
          
          <%# サイドバー（独立してスクロール） %>
          <aside class="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col flex-shrink-0">
            <nav class="flex-1 overflow-y-auto px-4 py-6 space-y-1 custom-scrollbar">
              <%= yield :sidebar if content_for?(:sidebar) %>
            </nav>
          </aside>

          <%# メインコンテンツ（独立してスクロール） %>
          <main class="flex-1 overflow-y-auto bg-white focus:outline-none custom-scrollbar">
            <div class="py-6 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">
              <%= yield %>
            </div>
          </main>

        </div>
      </div>
    <% else %>
      <%# ログイン前は通常のスクロール %>
      <div class="min-h-full overflow-y-auto">
        <%= yield %>
      </div>
    <% end %>

    <style>
      /* スクロールバーの見た目を少し細くしてモダンにする（任意） */
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #e5e7eb;
        border-radius: 10px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #d1d5db;
      }
    </style>
  </body>
</html>
-e \n--- END OF FILE ---\n
app/views/layouts/mailer.html.erb
--- START OF FILE ---
<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <style>
      /* Email styles need to be inline */
    </style>
  </head>

  <body>
    <%= yield %>
  </body>
</html>
-e \n--- END OF FILE ---\n
app/views/layouts/mailer.text.erb
--- START OF FILE ---
<%= yield %>
-e \n--- END OF FILE ---\n
app/views/works/index.html.erb
--- START OF FILE ---
<%# app/views/works/index.html.erb %>
<% content_for :sidebar do %>
  <%= render 'works/sidebar' %>
<% end %>

<div class="flex flex-col h-full bg-white">
  <header class="bg-white border-b border-gray-100 px-8 py-4 flex justify-between items-center shrink-0">
    <h2 class="text-xl font-bold text-gray-900">Works</h2>
    <div class="flex gap-2">
      <%= link_to new_work_path, class: "bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-blue-700" do %>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"></path></svg>
        新規Note
      <% end %>
      <button class="px-4 py-2 rounded-lg text-sm font-bold bg-gray-100 text-gray-400 cursor-not-allowed" disabled>Table</button>
      <button class="px-4 py-2 rounded-lg text-sm font-bold bg-gray-100 text-gray-400 cursor-not-allowed" disabled>Book</button>
    </div>
  </header>

  <div class="flex-1 overflow-y-auto">
    <div class="w-full">
      <div class="grid grid-cols-12 px-8 py-3 bg-gray-50 border-b border-gray-100 text-[10px] font-bold text-gray-400 uppercase tracking-widest">
        <div class="col-span-1 flex justify-center">Format</div>
        <div class="col-span-5">Title</div>
        <div class="col-span-2 text-center">Visibility</div>
        <div class="col-span-2 text-center">Owner</div>
        <div class="col-span-2 text-center">Updated</div>
      </div>

      <div class="divide-y divide-gray-100">
        <% if @activities.any? %>
          <% @activities.each do |activity| %>
            <div class="grid grid-cols-12 px-8 py-4 items-center hover:bg-gray-50 transition-colors group text-sm">
              <div class="col-span-1 flex justify-center">
                <span class="px-2 py-0.5 rounded border border-blue-100 bg-blue-50 text-blue-600 text-[9px] font-black uppercase">Note</span>
              </div>
              <div class="col-span-5 pr-4">
                <%# 閲覧画面(show)へリンク %>
                <%= link_to work_path(activity.actable), class: "font-bold text-gray-900 hover:text-blue-600 transition-colors" do %>
                  <%= activity.title.presence || "無題のドキュメント" %>
                <% end %>
              </div>
              <div class="col-span-2 text-center">
                <span class="text-[10px] font-bold px-2 py-1 rounded-full bg-gray-100 text-gray-500">
                  <%= Activity.visibility_ranges_i18n[activity.visibility_range] %>
                </span>
              </div>
              <div class="col-span-2 flex justify-center items-center gap-2">
                <%= profile_avatar_tag(activity.owner_profile, size: 20) %>
                <span class="text-[11px] text-gray-500 truncate"><%= activity.owner_profile.name %></span>
              </div>
              <div class="col-span-2 text-center text-gray-400 text-[11px]">
                <%= activity.updated_at.strftime("%Y/%m/%d") %>
              </div>
            </div>
          <% end %>
        <% else %>
          <div class="py-20 text-center text-gray-300 font-medium">ワークスはありません</div>
        <% end %>
      </div>
    </div>
  </div>
</div>-e \n--- END OF FILE ---\n
app/views/works/_sidebar.html.erb
--- START OF FILE ---
<%# app/views/works/_sidebar.html.erb %>
<nav class="space-y-1">
  <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider px-3 mb-2">Works</p>
  
  <%# 全てのWorks %>
  <%= link_to works_path, 
      class: "flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors #{params[:filter].blank? && params[:type].blank? ? 'bg-emerald-100 text-emerald-900' : 'text-gray-700 hover:bg-gray-100'}" do %>
    <svg xmlns="http://www.w3.org/2000/svg" class="mr-3 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
    </svg>
    全てのWorks
  <% end %>

  <%# 自分のWorks %>
  <%= link_to works_path(filter: 'mine'), 
      class: "flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors #{params[:filter] == 'mine' ? 'bg-emerald-100 text-emerald-900' : 'text-gray-700 hover:bg-gray-100'}" do %>
    <svg xmlns="http://www.w3.org/2000/svg" class="mr-3 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
    </svg>
    自分のWorks
  <% end %>

  <%# 共有されたWorks %>
  <%= link_to works_path(filter: 'shared'), 
      class: "flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors #{params[:filter] == 'shared' ? 'bg-emerald-100 text-emerald-900' : 'text-gray-700 hover:bg-gray-100'}" do %>
    <svg xmlns="http://www.w3.org/2000/svg" class="mr-3 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
    </svg>
    共有されたWorks
  <% end %>

  <div class="pt-4">
    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider px-3 mb-2">Formats</p>
    
    <%# Note フィルタ %>
    <%= link_to works_path(type: 'note'), 
        class: "flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors #{params[:type] == 'note' ? 'bg-emerald-100 text-emerald-900' : 'text-gray-700 hover:bg-gray-100'}" do %>
      <svg xmlns="http://www.w3.org/2000/svg" class="mr-3 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
      </svg>
      Note
    <% end %>

    <%# 将来の拡張用（Teamの非アクティブに近いスタイルへ） %>
    <div class="flex items-center px-3 py-2 text-sm font-medium text-gray-300 cursor-not-allowed">
      <svg xmlns="http://www.w3.org/2000/svg" class="mr-3 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
      </svg>
      Table (Soon)
    </div>
  </div>
</nav>-e \n--- END OF FILE ---\n
app/views/works/edit.html.erb
--- START OF FILE ---
<!-- app/views/works/edit.html.erb -->
<% content_for :sidebar do %>
  <%= render 'works/sidebar' %>
<% end %>

<%= render 'form', work: @work %>-e \n--- END OF FILE ---\n
app/views/works/show.html.erb
--- START OF FILE ---
<%# app/views/works/show.html.erb %>
<% content_for :sidebar do %>
  <%= render 'works/sidebar' %>
<% end %>

<% my_current_profile = current_profile %>

<div class="flex h-full bg-white overflow-hidden relative">
  <%# --- メイン：ドキュメントエリア --- %>
  <div class="flex-1 overflow-y-auto slack-scrollbar relative">
    <div class="max-w-4xl mx-auto w-full px-8 py-12">
      <header class="mb-10">
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-3">
            <span class="px-2 py-0.5 rounded bg-gray-100 text-gray-500 text-[9px] font-black uppercase tracking-widest">
              <%= @activity.visibility_range_i18n %>
            </span>
            <div class="h-3 w-[1px] bg-gray-200"></div>
            <div class="flex items-center gap-2">
              <%= profile_avatar_tag(@activity.owner_profile, size: 20) %>
              <span class="text-[11px] font-bold text-gray-700"><%= @activity.owner_profile.name %></span>
            </div>
          </div>

          <div class="flex gap-2">
            <%# いいねボタン（クイックアクション） %>
            <%= button_to activity_likes_path(@activity), method: :post, class: "flex items-center gap-1.5 px-3 py-1.5 rounded-lg border #{ @activity.like_activities.exists?(owner_profile: my_current_profile) ? 'bg-pink-50 border-pink-100 text-pink-500' : 'border-gray-100 text-gray-400 hover:bg-gray-50' } transition-all" do %>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 <%= 'fill-current' if @activity.like_activities.exists?(owner_profile: my_current_profile) %>" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
              <span class="text-[11px] font-bold"><%= @activity.likes_count if @activity.likes_count > 0 %></span>
            <% end %>

            <%# コメント開閉ボタン %>
            <button onclick="toggleCommentSidebar()" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg border border-gray-100 text-gray-500 hover:bg-gray-50 transition-all">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
              <span class="text-[11px] font-bold"><%= @activity.comment_activities.count %></span>
            </button>
          </div>
        </div>

        <h1 class="text-4xl font-black text-gray-900 leading-tight"><%= @activity.title %></h1>
      </header>

      <article class="prose prose-slate prose-lg max-w-none prose-headings:font-black border-t border-gray-50 pt-10">
        <%= @note.content %>
      </article>
    </div>
  </div>

  <%# --- 右側：コメントサイドパネル --- %>
  <aside id="comment_sidebar" class="hidden w-96 border-l border-gray-100 bg-white flex flex-col transition-all duration-300 shadow-2xl z-20">
    <header class="h-16 px-6 border-b border-gray-100 flex items-center justify-between shrink-0">
      <h3 class="font-black text-gray-900 text-sm">Discussions</h3>
      <button onclick="toggleCommentSidebar()" class="text-gray-400 hover:text-gray-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
      </button>
    </header>

    <%# コメント一覧：Socialのリスト表示部分をこの中に入れる %>
    <div class="flex-1 overflow-y-auto slack-scrollbar p-4 space-y-4" id="messages_area">
      <% if @activity.comment_activities.any? %>
        <% @activity.comment_activities.where(actable: Comment.where(parent_id: nil)).each do |c_act| %>
          <div class="flex flex-col gap-1 group">
            <div class="flex items-center gap-2">
              <%= profile_avatar_tag(c_act.owner_profile, size: 24) %>
              <span class="font-bold text-[13px] text-gray-900"><%= c_act.owner_profile.name %></span>
              <span class="text-[10px] text-gray-400"><%= c_act.created_at.strftime("%H:%M") %></span>
            </div>
            <div class="ml-8 text-[14px] text-gray-700 leading-relaxed">
              <%= simple_format(c_act.actable.content) %>
              
              <div class="flex items-center gap-3 mt-1">
                <button onclick="setReplyMode('<%= @activity.id %>', '<%= j c_act.actable.content.truncate(20) %>', '<%= c_act.owner_profile.name %>', '<%= c_act.actable_id %>')" class="text-[10px] text-blue-500 font-bold hover:underline">返信</button>
              </div>

              <%# 2階層目の返信 %>
              <% if c_act.actable.replies.any? %>
                <div class="mt-3 space-y-3 border-l-2 border-gray-50 pl-3">
                  <% c_act.actable.replies.each do |reply| %>
                    <div class="text-[12px]">
                      <span class="font-bold text-gray-900"><%= reply.activity.owner_profile.name %></span>
                      <span class="text-gray-600 ml-1"><%= reply.content %></span>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      <% else %>
        <div class="h-full flex flex-col items-center justify-center text-gray-300 py-10">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-2 opacity-20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
          <p class="text-xs font-bold">まだディスカッションはありません</p>
        </div>
      <% end %>
    </div>

    <%# 入力エリア：SocialPostのフォームをベースに構築 %>
    <footer class="p-4 border-t border-gray-100">
      <%= form_with(model: Comment.new, url: activity_comments_path(@activity), id: "chat_form") do |f| %>
        <input type="hidden" name="comment[parent_id]" id="comment_parent_id" value="">
        <input type="hidden" name="social_post[content]" id="hidden_content">

        <div id="reply_preview" class="hidden flex items-center justify-between mb-2 p-2 bg-blue-50 border border-blue-100 rounded text-[10px] text-blue-700">
          <span class="truncate">💬 <span id="reply_user_name"></span> に返信中</span>
          <button type="button" onclick="clearReplyMode()" class="text-blue-500 font-bold">×</button>
        </div>

        <div class="relative">
          <textarea id="message_textarea" 
                    placeholder="Shift + Enter で送信"
                    onkeydown="handleKeydown(event)"
                    class="w-full border-2 border-gray-100 focus:border-blue-500 focus:ring-0 rounded-lg p-3 text-sm resize-none slack-scrollbar" 
                    rows="3"></textarea>
          <button type="submit" onclick="syncContent()" class="absolute bottom-2 right-2 p-1.5 text-blue-500 hover:bg-blue-50 rounded-md transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9-2-9-18-9 18 9 2zm0 0v-8" /></svg>
          </button>
        </div>
      <% end %>
    </footer>
  </aside>
</div>

<script>
  function toggleCommentSidebar() {
    const sidebar = document.getElementById('comment_sidebar');
    if (!sidebar) return;
    
    sidebar.classList.toggle('hidden');
    
    if (!sidebar.classList.contains('hidden')) {
        const area = document.getElementById('messages_area');
        if (area) area.scrollTop = area.scrollHeight;
    }
    }

  // フォーム送信時にtextareaの内容をhidden field（social_post[content]）に同期
  // ※Controllerがparams[:social_post][:content]を期待しているため
  function syncContent() {
    document.getElementById('hidden_content').value = document.getElementById('message_textarea').value;
  }

  // SocialPostで使用しているJS関数をここでも定義、または共通JSファイルに移動
  function clearReplyMode() {
    const preview = document.getElementById('reply_preview');
    const textarea = document.getElementById('message_textarea');
    const parentIdInput = document.getElementById('comment_parent_id');
    if (preview) preview.classList.add('hidden');
    if (textarea) textarea.value = "";
    if (parentIdInput) parentIdInput.value = "";
  }

  function setReplyMode(activityId, text, userName, parentCommentId = null) {
    const sidebar = document.getElementById('comment_sidebar');
    if (sidebar.classList.contains('hidden')) toggleCommentSidebar();
    
    const preview = document.getElementById('reply_preview');
    const parentIdInput = document.getElementById('comment_parent_id');
    const textarea = document.getElementById('message_textarea');
    
    document.getElementById('reply_user_name').innerText = userName;
    parentIdInput.value = parentCommentId || "";
    preview.classList.remove('hidden');
    textarea.focus();
  }

  // 修正ポイント2: ページ読み込み時にURLを確認してパネルを開く
  document.addEventListener("DOMContentLoaded", () => {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('comment_open') === 'true') {
      toggleCommentSidebar(false); // アニメーションなしで開く
    }
  });

  // 修正ポイント3: Shift + Enter の判定
  function handleKeydown(e) {
    if (e.key === 'Enter' && e.shiftKey) {
      e.preventDefault(); // 改行を防ぐ
      syncContent();      // hidden fieldに同期
      document.getElementById('chat_form').submit(); // 送信
    }
  }

  function syncContent() {
    document.getElementById('hidden_content').value = document.getElementById('message_textarea').value;
  }
</script>-e \n--- END OF FILE ---\n
app/views/works/_form.html.erb
--- START OF FILE ---
<!-- app/views/works/_form.html.erb -->
<div class="flex flex-col h-full bg-white overflow-y-auto px-4 sm:px-0">
  <div class="max-w-4xl mx-auto w-full pt-8 pb-12">
    <%= form_with(model: work) do |f| %>
      <%= f.fields_for :activity do |af| %>
        <%# タイトル：サイズを落とし、上下の余白をタイトに %>
        <div class="mb-4">
          <%= af.text_field :title, placeholder: "無題のドキュメント", 
              class: "w-full border-none focus:ring-0 text-3xl font-bold placeholder-gray-200 p-0 bg-transparent" %>
        </div>

        <%# メタ設定：高さを抑えたコンパクトな 1 行レイアウト %>
        <div class="flex flex-wrap items-center gap-4 py-2 px-3 mb-8 bg-gray-50/50 border border-gray-100 rounded-lg">
          
          <%# 公開範囲（x-dataは既存のものを維持） %>
          <div x-data="{ scope: '<%= af.object.visibility_range || 'is_private' %>' }" class="flex items-center gap-2">
            <span class="text-[9px] font-black text-gray-400 uppercase tracking-tighter">公開</span>
            <% 
              options = { "is_private" => "プライベート" }
              options["is_team"] = "チーム" if @current_profile.team.present?
              options["is_chat_room"] = "ルーム"
              options["is_public"] = "パブリック"
            %>
            <%= af.select :visibility_range, options.invert, {}, 
                { "x-model": "scope", class: "bg-transparent border-none text-[11px] font-bold text-gray-600 focus:ring-0 p-0 pr-6 cursor-pointer" } %>

            <%# ルーム選択（scopeがルームの時だけ表示） %>
            <template x-if="scope === 'is_chat_room'">
              <%= af.collection_select :chat_room_id, @current_profile.chat_rooms, :id, :display_name, 
                  { prompt: "選択..." }, 
                  { class: "bg-white border-gray-200 rounded text-[10px] py-0.5 px-2 focus:ring-emerald-500" } %>
            </template>
          </div>

          <div class="h-4 w-[1px] bg-gray-200"></div>

          <%# 権限詳細：ラジオボタンをセレクトボックス化して省スペースに %>
          <div class="flex items-center gap-2">
            <span class="text-[9px] font-black text-gray-400 uppercase tracking-tighter">権限</span>
            <%= af.select :permission_type, [["閲覧のみ", "read_only"], ["編集可", "edit_only"]], {}, 
                class: "bg-transparent border-none text-[11px] font-bold text-gray-600 focus:ring-0 p-0 pr-6 cursor-pointer" %>
          </div>

          <div class="h-4 w-[1px] bg-gray-200 ml-auto"></div>

          <%# チェックボックス：さらに小さく %>
          <div class="flex gap-3">
            <label class="flex items-center gap-1 cursor-pointer group">
              <%= af.check_box :allow_comment, class: "w-3 h-3 rounded text-blue-600 border-gray-300 focus:ring-0" %>
              <span class="text-[10px] text-gray-500 group-hover:text-gray-700">コメント</span>
            </label>
            <label class="flex items-center gap-1 cursor-pointer group">
              <%= af.check_box :allow_reaction, class: "w-3 h-3 rounded text-blue-600 border-gray-300 focus:ring-0" %>
              <span class="text-[10px] text-gray-500 group-hover:text-gray-700">反応</span>
            </label>
          </div>
        </div>
      <% end %>

      <%# Note 本文：境界線を目立たせず、すぐに書き始められる印象に %>
      <div class="prose prose-slate max-w-none min-h-[60vh]">
        <%= fields_for :note, @note do |nf| %>
          <%= nf.rich_text_area :content, placeholder: "ここから書き始める...", class: "focus:outline-none" %>
        <% end %>
      </div>

      <%# 下部アクションバー %>
      <div class="sticky bottom-6 flex justify-end gap-3 mt-12 bg-white/80 backdrop-blur py-4 border-t border-gray-50">
        <%= link_to 'キャンセル', works_path, class: "text-gray-400 px-4 py-2 text-xs font-bold hover:text-gray-600" %>
        <%= f.submit (work.persisted? ? "更新する" : "ドキュメントを保存"), 
            class: "bg-blue-600 text-white px-8 py-2 rounded-lg text-xs font-bold shadow-lg shadow-blue-100 hover:bg-blue-700 transition-all cursor-pointer" %>
      </div>
    <% end %>
  </div>
</div>-e \n--- END OF FILE ---\n
app/views/works/new.html.erb
--- START OF FILE ---
<!-- app/views/works/new.html.erb -->
<% content_for :sidebar do %>
  <%= render 'works/sidebar' %>
<% end %>

<%= render 'form', work: @work %>-e \n--- END OF FILE ---\n
app/views/pwa/manifest.json.erb
--- START OF FILE ---
{
  "name": "ForestlyV4",
  "icons": [
    {
      "src": "/icon.png",
      "type": "image/png",
      "sizes": "512x512"
    },
    {
      "src": "/icon.png",
      "type": "image/png",
      "sizes": "512x512",
      "purpose": "maskable"
    }
  ],
  "start_url": "/",
  "display": "standalone",
  "scope": "/",
  "description": "ForestlyV4.",
  "theme_color": "red",
  "background_color": "red"
}
-e \n--- END OF FILE ---\n
app/views/teams/_sidebar.html.erb
--- START OF FILE ---
<!-- app/views/teams/_sidebar.html.erb -->
<nav class="space-y-1">
  <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider px-3 mb-2">Team</p>
  
  <%# メンバー一覧 (ホーム) %>
  <%= link_to members_team_path, 
      class: "flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors #{controller_name == 'teams' && action_name == 'members' ? 'bg-emerald-100 text-emerald-900' : 'text-gray-700 hover:bg-gray-100'}" do %>
    <svg xmlns="http://www.w3.org/2000/svg" class="mr-3 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
    </svg>
    メンバー一覧
  <% end %>

  <%# チーム編集 %>
  <%= link_to edit_team_path, 
      class: "flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors #{controller_name == 'teams' && action_name == 'edit' ? 'bg-emerald-100 text-emerald-900' : 'text-gray-700 hover:bg-gray-100'}" do %>
    <svg xmlns="http://www.w3.org/2000/svg" class="mr-3 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
    </svg>
    チーム編集
  <% end %>

  <%# 新規チーム作成 %>
  <%= link_to new_team_path, 
      class: "flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors #{controller_name == 'teams' && action_name == 'new' ? 'bg-emerald-100 text-emerald-900' : 'text-gray-700 hover:bg-gray-100'}" do %>
    <svg xmlns="http://www.w3.org/2000/svg" class="mr-3 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    新規チーム作成
  <% end %>
</nav>-e \n--- END OF FILE ---\n
app/views/teams/members.html.erb
--- START OF FILE ---
<!-- app/views/teams/members.html.erb -->
<% content_for :sidebar do %>
  <%= render 'sidebar' %>
<% end %>

<div class="max-w-4xl mx-auto px-4 sm:px-6">
  <% if @team %>
    <%# チームヘッダーセクション %>
    <div class="md:flex md:items-center md:justify-between pb-5 border-b border-gray-200 mb-8">
      <div class="flex-1 min-w-0 flex items-center gap-4">
        <%# チームアイコン（ApplicationHelperのメソッドを想定） %>
        <%= team_avatar_tag(@team, class: "h-12 w-12 rounded-xl object-cover shadow-sm") %>
        <div>
          <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
            <%= @team.display_name %>
          </h2>
          <p class="text-sm text-gray-500 font-medium">メンバー一覧</p>
        </div>
      </div>
    </div>

    <%# メンバーリスト %>
    <div class="bg-white shadow overflow-hidden sm:rounded-md border border-gray-100">
      <ul role="list" class="divide-y divide-gray-200">
        <% @members.each do |member| %>
          <li>
            <div class="px-4 py-4 flex items-center sm:px-6 hover:bg-gray-50 transition-colors">
              <div class="min-w-0 flex-1 flex items-center">
                <div class="flex-shrink-0">
                  <%# プロフィールアイコン %>
                  <%= profile_avatar_tag(member, class: "h-10 w-10 border border-gray-100", size: 40) %>
                </div>
                <div class="min-w-0 flex-1 px-4 md:grid md:grid-cols-2 md:gap-4">
                  <div>
                    <p class="text-sm font-bold text-[#00a968] truncate"><%= member.name %></p>
                  </div>
                  <div class="hidden md:block">
                    <div>
                      <% if member.admin? %>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800 border border-amber-200">
                          <svg class="-ml-0.5 mr-1.5 h-2 w-2 text-amber-400" fill="currentColor" viewBox="0 0 8 8">
                            <circle cx="4" cy="4" r="3" />
                          </svg>
                          管理者 (Admin)
                        </span>
                      <% else %>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border border-blue-200">
                          メンバー (Member)
                        </span>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
              
              <%# Adminのみが表示できるアクション（将来用） %>
              <% if current_profile.admin? && member != current_profile %>
                <div>
                  <button class="text-gray-400 hover:text-red-500 transition-colors">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                  </button>
                </div>
              <% end %>
            </div>
          </li>
        <% end %>
      </ul>
    </div>

  <% else %>
    <%# 未所属時の表示 %>
    <div class="text-center py-20 bg-gray-50 rounded-2xl border-2 border-dashed border-gray-200 max-w-lg mx-auto mt-10">
      <div class="flex justify-center mb-4">
        <div class="p-3 bg-white rounded-full shadow-sm">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656-.126-1.283-.356-1.857m0 0a5 5 0 1110 0af5 5 0 01-10 0z" />
          </svg>
        </div>
      </div>
      <h3 class="text-lg font-bold text-gray-900 mb-1">チームに未所属です</h3>
      <p class="text-gray-500 mb-6 px-10 text-sm italic">
        チームを作成してメンバーを招待するか、他の管理者に profile_id (<%= current_profile.profile_id %>) を伝えて招待してもらいましょう。
      </p>
      <%= link_to new_team_path, class: "inline-flex items-center px-6 py-3 border border-transparent text-sm font-bold rounded-xl shadow-sm text-white bg-[#00a968] hover:bg-[#008f58] transition-all" do %>
        <svg xmlns="http://www.w3.org/2000/svg" class="-ml-1 mr-2 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        新規チーム作成
      <% end %>
    </div>
  <% end %>

  <!-- メンバー招待セクション -->
  <div class="mt-12 pt-8 border-t border-gray-200">
        <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden shadow-sm">
            <div class="p-6">
            <h4 class="text-lg font-bold text-gray-900 mb-1">メンバーを招待</h4>
            <p class="text-sm text-gray-500 mb-6">プロフィールIDを入力して、新しいメンバーをチームに招待します。</p>

            <%= form_with url: team_invitations_path, method: :post, class: "flex flex-col gap-4" do |f| %>
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-grow">
                    <%= f.text_field :profile_id, 
                        placeholder: "例: ajnz6dem", 
                        class: "block w-full pl-8 border-gray-300 rounded-xl shadow-sm focus:ring-[#00a968] focus:border-[#00a968] py-3 text-sm font-mono uppercase" %>
                    </div>
                    
                    <%# --- ここにRole選択を追加 --- %>
                    <div class="flex items-center gap-4 px-2">
                        <label class="inline-flex items-center cursor-pointer">
                            <%= f.radio_button :role, "member", checked: true, class: "text-[#00a968] focus:ring-[#00a968]" %>
                            <span class="ml-2 text-sm text-gray-600">一般メンバー</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <%= f.radio_button :role, "admin", class: "text-[#00a968] focus:ring-[#00a968]" %>
                            <span class="ml-2 text-sm text-gray-600">管理者</span>
                        </label>
                    </div>

                    <%= f.submit "招待を送信", class: "px-6 py-3 bg-[#00a968] text-white font-bold rounded-xl hover:bg-[#008f58] transition-colors cursor-pointer" %>
                </div>
            <% end %>
            </div>
            
            <div class="bg-gray-50 px-6 py-3">
            <p class="text-[11px] text-gray-400">
                ※相手が招待を承認すると、正式にメンバーとして追加されます。
            </p>
            </div>
        </div>
    </div>

    <!-- 招待履歴セクション -->
    <div class="mt-8">
    <div class="flex items-center justify-between mb-3 ml-1">
      <h4 class="text-sm font-bold text-gray-700">招待履歴</h4>
      <span class="text-[10px] text-gray-400 font-medium">直近のステータスを表示</span>
    </div>
    
    <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden shadow-sm">
      <%# 3.5行分の高さを維持し、中身が多い場合はスクロール可能にする %>
      <div class="overflow-y-auto" style="height: 224px;">
        <% if @invitation_history.present? %>
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50 sticky top-0 z-10">
              <tr>
                <th scope="col" class="px-6 py-2 text-left text-[10px] font-bold text-gray-500 uppercase tracking-wider">プロフィール</th>
                <th scope="col" class="px-6 py-2 text-left text-[10px] font-bold text-gray-500 uppercase tracking-wider">権限</th>
                <th scope="col" class="px-6 py-2 text-left text-[10px] font-bold text-gray-500 uppercase tracking-wider">状態</th>
                <th scope="col" class="px-6 py-2 text-left text-[10px] font-bold text-gray-500 uppercase tracking-wider">送信日</th>
                <th scope="col" class="px-6 py-2 text-right text-[10px] font-bold text-gray-500 uppercase tracking-wider">操作</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-100">
              <% @invitation_history.each do |request| %>
                <tr class="hover:bg-gray-50 transition-colors">
                  <td class="px-6 py-3 whitespace-nowrap">
                    <div class="flex items-center gap-3">
                      <%= profile_avatar_tag(request.profile, class: "h-7 w-7 rounded-lg border border-gray-100", size: 28) %>
                      <div class="text-xs font-bold text-gray-900"><%= request.profile.name %></div>
                    </div>
                  </td>
                  <td class="px-6 py-3 whitespace-nowrap">
                    <span class="text-[10px] font-medium text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded">
                      <%= request.role_i18n %>
                    </span>
                  </td>
                  <td class="px-6 py-3 whitespace-nowrap text-xs">
                    <% case request.status %>
                    <% when 'pending' %>
                      <span class="inline-flex items-center text-amber-600 font-bold">
                        <span class="w-1.5 h-1.5 rounded-full bg-amber-400 mr-2 animate-pulse"></span>承認待ち
                      </span>
                    <% when 'accepted' %>
                      <span class="inline-flex items-center text-green-600 font-bold">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-400 mr-2"></span>承認済
                      </span>
                    <% when 'rejected' %>
                      <span class="inline-flex items-center text-red-500 font-bold">
                        <span class="w-1.5 h-1.5 rounded-full bg-red-400 mr-2"></span>拒否
                      </span>
                    <% when 'canceled' %>
                      <span class="inline-flex items-center text-gray-400 font-bold">
                        <span class="w-1.5 h-1.5 rounded-full bg-gray-300 mr-2"></span>撤回
                      </span>
                    <% end %>
                  </td>
                  <td class="px-6 py-3 whitespace-nowrap text-[10px] text-gray-400 font-mono">
                    <%= request.created_at.strftime("%Y/%m/%d %H:%M") %>
                  </td>
                  <td class="px-6 py-3 whitespace-nowrap text-right text-xs">
                        <% if request.pending? %>
                        <%= button_to cancel_team_invitation_path(request), 
                                        method: :patch, 
                                        data: { confirm: "#{request.profile.name} さんへの招待を取り消しますか？" },
                                        class: "text-red-500 hover:text-red-700 font-bold transition-colors inline-flex items-center gap-1" do %>
                            <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                            取り消す
                        <% end %>
                        <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% else %>
          <div class="flex flex-col items-center justify-center h-full text-gray-400">
            <svg class="w-8 h-8 mb-2 opacity-20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <p class="text-xs italic">招待履歴はありません</p>
          </div>
        <% end %>
      </div>
    </div>

</div>-e \n--- END OF FILE ---\n
app/views/teams/edit.html.erb
--- START OF FILE ---
<!-- app/views/teams/edit.html.erb -->
<% content_for :sidebar do %>
  <%= render 'sidebar' %>
<% end %>

<div class="max-w-2xl mx-auto px-4">
  <div class="pb-5 border-b border-gray-200 mb-6">
    <h3 class="text-xl leading-6 font-bold text-gray-900">チーム設定</h3>
  </div>

  <% if @team %>
    <%= form_with(model: @team, url: team_path, method: :patch, class: "space-y-6") do |f| %>
      
      <%# アイコン編集セクション %>
      <div class="flex flex-col items-center py-8 bg-gray-50 rounded-2xl border-2 border-dashed border-gray-200">
        <div id="avatar-preview-container" 
             onclick="document.getElementById('team-avatar-input').click();" 
             class="relative cursor-pointer group">
          
          <div id="avatar-current-display">
            <%= team_avatar_tag(@team, class: "w-[120px] h-[120px] rounded-2xl shadow-md object-cover") %>
          </div>
          
          <img id="image-preview" src="#" alt="Preview" 
               style="display: none; width: 120px; height: 120px; border-radius: 1rem; object-fit: cover;">
          
          <div class="absolute inset-0 flex items-center justify-center bg-black/40 rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity">
            <span class="text-xs text-white font-bold bg-black/20 px-3 py-1.5 rounded-full backdrop-blur-sm">変更する</span>
          </div>
        </div>
        <%= f.file_field :avatar, id: "team-avatar-input", accept: 'image/*', onchange: "previewImage(this);", class: "hidden" %>
        <p class="text-xs text-gray-500 mt-4">クリックしてチームアイコンをアップロード</p>
      </div>

      <%# チーム名編集 %>
      <div>
        <%= f.label :display_name, "チーム名称", class: "block text-sm font-bold text-gray-700 mb-1" %>
        <%= f.text_field :display_name, class: "block w-full border-gray-300 rounded-xl shadow-sm focus:ring-[#00a968] focus:border-[#00a968] py-3" %>
      </div>

      <%# 保存ボタン %>
      <div class="flex justify-end gap-3 pt-6">
        <%= link_to "キャンセル", members_team_path, class: "px-6 py-2.5 text-sm font-bold text-gray-700 bg-white border border-gray-300 rounded-xl hover:bg-gray-50 transition-colors" %>
        <%= f.submit "変更を保存する", class: "px-6 py-2.5 text-sm font-bold text-white bg-[#00a968] rounded-xl hover:bg-[#008f58] shadow-sm transition-colors cursor-pointer" %>
      </div>
    <% end %>

  <% else %>
    <%# 未所属時の表示 %>
    <div class="text-center py-20 bg-gray-50 rounded-2xl border-2 border-dashed border-gray-200">
      <div class="flex justify-center mb-4 text-gray-300">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
      </div>
      <p class="text-gray-600 font-bold mb-4">現在、チームに所属していません。</p>
      <%= link_to "新規チーム作成へ", new_team_path, class: "text-[#00a968] font-bold hover:underline" %>
    </div>
  <% end %>
</div>

<script>
  function previewImage(input) {
    const preview = document.getElementById('image-preview');
    const currentDisplay = document.getElementById('avatar-current-display');
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
        currentDisplay.style.display = 'none';
      }
      reader.readAsDataURL(input.files[0]);
    }
  }
</script>-e \n--- END OF FILE ---\n
app/views/teams/new.html.erb
--- START OF FILE ---
<!-- app/views/teams/new.html.erb -->
<% content_for :sidebar do %>
  <%= render 'sidebar' %>
<% end %>

<div class="max-w-2xl mx-auto">
  <div class="pb-5 border-b border-gray-200 mb-6">
    <h3 class="text-lg leading-6 font-medium text-gray-900">新規チーム作成</h3>
  </div>

  <% if @team %>
    <%# 既に所属している場合の「案A」表示 %>
    <div class="bg-amber-50 border-l-4 border-amber-400 p-6 rounded-r-xl">
      <div class="flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-amber-400 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <p class="text-sm text-amber-700 font-bold">
          既にチーム「<%= @team.display_name %>」に所属しています。
        </p>
      </div>
      <p class="text-xs text-amber-600 mt-2 ml-9">
        新しいチームを作成するには、現在のチームを解散するか離脱する必要があります。
      </p>
      <div class="mt-4 ml-9">
        <%= link_to "メンバー一覧に戻る", members_team_path, class: "text-xs bg-white border border-amber-300 px-3 py-1.5 rounded hover:bg-amber-100 transition-colors" %>
      </div>
    </div>

  <% else %>
    <%# チーム作成フォーム %>
    <%= form_with(model: @team_new, url: team_path, class: "space-y-6") do |f| %>
      <div class="flex flex-col items-center py-6 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
        <div id="avatar-preview-container" 
             onclick="document.getElementById('team-avatar-input').click();" 
             class="relative cursor-pointer group">
          <div id="avatar-initial-display">
            <div class="w-[120px] h-[120px] bg-emerald-100 rounded-xl flex items-center justify-center text-emerald-600">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
              </svg>
            </div>
          </div>
          <img id="image-preview" src="#" alt="Preview" 
               style="display: none; width: 120px; height: 120px; border-radius: 0.75rem; object-fit: cover;">
          <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
            <span class="text-xs text-white bg-black/50 px-2 py-1 rounded">設定</span>
          </div>
        </div>
        <%= f.file_field :avatar, id: "team-avatar-input", accept: 'image/*', onchange: "previewImage(this);", class: "hidden" %>
        <p class="text-xs text-gray-500 mt-3">チームアイコンを設定（クリックしてアップロード）</p>
      </div>

      <div>
        <%= f.label :display_name, "チーム名", class: "block text-sm font-medium text-gray-700" %>
        <%= f.text_field :display_name, placeholder: "例: Forestly開発チーム", class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-[#00a968] focus:border-[#00a968]" %>
      </div>

      <div class="flex justify-end gap-3 pt-4">
        <%= link_to "キャンセル", members_team_path, class: "px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50" %>
        <%= f.submit "チームを作成する", class: "px-4 py-2 text-sm font-medium text-white bg-[#00a968] rounded-md hover:bg-[#008f58] transition-colors cursor-pointer" %>
      </div>
    <% end %>
  <% end %>
</div>

<script>
  function previewImage(input) {
    const preview = document.getElementById('image-preview');
    const initialDisplay = document.getElementById('avatar-initial-display');
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
        initialDisplay.style.display = 'none';
      }
      reader.readAsDataURL(input.files[0]);
    }
  }
</script>-e \n--- END OF FILE ---\n
app/views/profiles/_sidebar.html.erb
--- START OF FILE ---
<!-- app/views/profiles/_sidebar.html.erb -->
<nav class="space-y-1">
  <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider px-3 mb-2">Profile</p>
  
  <%# プロフィール編集 %>
  <%# ※ @profile が存在することを想定していますが、安全のために current_user.profiles.first を維持しています %>
  <% target_profile = @profile || current_user.profiles.first %>
  <%= link_to edit_profile_path(target_profile), 
      class: "flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors #{controller_name == 'profiles' && action_name == 'edit' ? 'bg-emerald-100 text-emerald-900' : 'text-gray-700 hover:bg-gray-100'}" do %>
    <svg xmlns="http://www.w3.org/2000/svg" class="mr-3 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
    </svg>
    プロフィール編集
  <% end %>

  <%# 新規プロフィール作成 %>
  <%= link_to new_profile_path, 
      class: "flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors #{controller_name == 'profiles' && action_name == 'new' ? 'bg-emerald-100 text-emerald-900' : 'text-gray-700 hover:bg-gray-100'}" do %>
    <svg xmlns="http://www.w3.org/2000/svg" class="mr-3 h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    新規プロフィール作成
  <% end %>
</nav>-e \n--- END OF FILE ---\n
app/views/profiles/edit.html.erb
--- START OF FILE ---
<!-- app/views/profiles/edit.html.erb -->
<% content_for :sidebar do %>
  <%= render 'sidebar' %>
<% end %>

<div class="max-w-2xl mx-auto">
  <div class="pb-5 border-b border-gray-200 mb-6">
    <h3 class="text-lg leading-6 font-medium text-gray-900">プロフィールの編集</h3>
  </div>

  <%= form_with(model: @profile, class: "space-y-6") do |f| %>
    <div class="flex flex-col gap-1">
      <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">プロフィールID</span>
      <div class="flex items-center gap-2">
        <code class="px-3 py-2 bg-gray-100 border border-gray-200 rounded-lg text-sm text-gray-600 font-mono select-all">
          <%= @profile.profile_id %>
        </code>
        <span class="text-[10px] text-gray-400 italic">※IDは変更できません</span>
      </div>
    </div>

    <div class="flex flex-col items-center py-4 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
      <div id="avatar-preview-container" 
           onclick="document.getElementById('profile-avatar-input').click();" 
           class="relative cursor-pointer group">
        <div id="avatar-initial-display">
          <%= profile_avatar_tag(@profile, size: 120) %>
        </div>
        <img id="image-preview" src="#" alt="Preview" 
             style="display: none; width: 120px; height: 120px; border-radius: 0.75rem; object-fit: cover;">
        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
          <span class="text-xs text-white bg-black/50 px-2 py-1 rounded">変更</span>
        </div>
      </div>
      <%= f.file_field :avatar, id: "profile-avatar-input", accept: 'image/*', onchange: "previewImage(this);", class: "hidden" %>
      <p class="text-xs text-gray-500 mt-2">クリックして画像をアップロード</p>
    </div>

    <div>
      <%= f.label :name, "表示名", class: "block text-sm font-medium text-gray-700" %>
      <%= f.text_field :name, class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-[#00a968] focus:border-[#00a968]" %>
    </div>

    <div>
      <%= f.label :label, "ラベル", class: "block text-sm font-medium text-gray-700" %>
      <%= f.text_field :label, class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-[#00a968] focus:border-[#00a968]" %>
    </div>

    <div class="flex justify-end gap-3">
      <%= link_to "キャンセル", profiles_path, class: "px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50" %>
      <%= f.submit "保存する", class: "px-4 py-2 text-sm font-medium text-white bg-[#00a968] rounded-md hover:bg-[#008f58] transition-colors" %>
    </div>

    <div>
        <% if current_user.profiles.count > 1 %>
            <%= link_to "プロフィールを削除", profile_path(@profile), 
                data: { turbo_method: :delete, turbo_confirm: "本当にこのプロフィールを削除しますか？" }, 
                class: "text-sm text-red-600 hover:text-red-800 transition-colors" %>
        <% end %>
    </div>
  <% end %>

  <!-- 招待承認セクション -->
  <div class="mt-12 pt-8 border-t border-gray-200">
    <h3 class="text-lg font-bold text-gray-900 mb-4">チームへの招待</h3>
    <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden shadow-sm">
      <%# 3.5行分の高さを維持しスクロール可能にする %>
      <div class="overflow-y-auto" style="height: 224px;">
        <%# ログイン中のプロフィール宛の「保留中」招待を取得 %>
        <% invitations = TeamMembershipRequest.where(profile: @profile, status: :pending).order(created_at: :desc) %>
        
        <% if invitations.present? %>
          <ul class="divide-y divide-gray-100">
            <% invitations.each do |invite| %>
              <li class="p-4 hover:bg-gray-50 transition-colors">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                  <div class="flex items-start gap-3">
                    <%# 招待元のチームアイコン %>
                    <%= team_avatar_tag(invite.team, class: "h-10 w-10 rounded-lg shadow-sm") %>
                    <div>
                      <div class="flex items-center gap-2">
                        <p class="text-sm font-bold text-gray-900"><%= invite.team.display_name %></p>
                        <span class="text-[10px] px-2 py-0.5 rounded-full bg-gray-100 text-gray-600 font-medium">
                          <%= invite.role_i18n %>として招待
                        </span>
                      </div>
                      <p class="text-[11px] text-gray-500 mt-1">
                        招待者: <%= invite.team.profiles.find_by(team_role: :admin)&.name || "管理者" %> 
                        <span class="mx-1">•</span> 
                        <%= invite.created_at.strftime("%Y/%m/%d %H:%M") %>
                      </p>
                    </div>
                  </div>

                  <div class="flex items-center gap-2">
                    <% if current_profile.team.present? %>
                      <div class="group relative">
                        <button class="px-4 py-2 bg-gray-100 text-gray-400 text-xs font-bold rounded-lg cursor-not-allowed" disabled>
                          承認不可
                        </button>
                        <span class="absolute bottom-full mb-2 hidden group-hover:block w-48 bg-gray-800 text-white text-[10px] p-2 rounded shadow-lg">
                          既に他のチームに所属しているため、この招待を承認するには現在のチームを抜ける必要があります。
                        </span>
                      </div>
                    <% else %>
                      <%= button_to "承認する", accept_team_invitation_path(invite), method: :patch, 
                          class: "px-4 py-2 bg-[#00a968] text-white text-xs font-bold rounded-lg hover:bg-[#008f58] transition-colors" %>
                    <% end %>

                    <%= button_to "辞退", reject_team_invitation_path(invite), method: :patch, 
                        data: { confirm: "この招待を辞退しますか？" },
                        class: "px-4 py-2 border border-gray-200 text-gray-600 text-xs font-bold rounded-lg hover:bg-gray-50 transition-colors" %>
                  </div>
                </div>
              </li>
            <% end %>
          </ul>
        <% else %>
          <div class="flex flex-col items-center justify-center h-full text-gray-400 py-10">
            <svg class="w-8 h-8 mb-2 opacity-20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
            </svg>
            <p class="text-xs italic">現在、チームからの招待は届いていません。</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>

</div>

<%# サインアップ画面と同じプレビューJSが必要な場合は、ここに追加するか共通JS化します %>
<script>
  function previewImage(input) {
    const preview = document.getElementById('image-preview');
    const initialDisplay = document.getElementById('avatar-initial-display');
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
        initialDisplay.style.display = 'none';
      }
      reader.readAsDataURL(input.files[0]);
    }
  }
</script>-e \n--- END OF FILE ---\n
app/views/profiles/new.html.erb
--- START OF FILE ---
<!-- app/views/profiles/new.html.erb -->
<% content_for :sidebar do %>
  <%= render 'sidebar' %>
<% end %>

<div class="max-w-2xl mx-auto">
  <div class="pb-5 border-b border-gray-200 mb-6">
    <h3 class="text-lg leading-6 font-medium text-gray-900">新規プロフィールの作成</h3>
  </div>

  <%= form_with(model: @profile, class: "space-y-6") do |f| %>
    <%# アイコン選択・プレビューセクション %>
    <div class="flex flex-col items-center py-4 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
      <div id="avatar-preview-container" 
           onclick="document.getElementById('profile-avatar-input').click();" 
           class="relative cursor-pointer group">
        <div id="avatar-initial-display">
          <%# 新規作成なのでデフォルトの「?」表示 %>
          <%= profile_avatar_tag(@profile, size: 120) %>
        </div>
        <img id="image-preview" src="#" alt="Preview" 
             style="display: none; width: 120px; height: 120px; border-radius: 0.75rem; object-fit: cover;">
        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
          <span class="text-xs text-white bg-black/50 px-2 py-1 rounded">画像を選択</span>
        </div>
      </div>
      <%= f.file_field :avatar, id: "profile-avatar-input", accept: 'image/*', onchange: "previewImage(this);", class: "hidden" %>
      <p class="text-xs text-gray-500 mt-2">クリックして画像をアップロード</p>
    </div>

    <div>
      <%= f.label :name, "表示名", class: "block text-sm font-medium text-gray-700" %>
      <%= f.text_field :name, placeholder: "例: 山田 太郎", class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-[#00a968] focus:border-[#00a968]" %>
    </div>

    <div>
      <%= f.label :label, "ラベル", class: "block text-sm font-medium text-gray-700" %>
      <%= f.text_field :label, placeholder: "例: 仕事用、プライベート", class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-[#00a968] focus:border-[#00a968]" %>
    </div>

    <div class="flex justify-end gap-3">
      <%= link_to "キャンセル", profiles_path, class: "px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50" %>
      <%= f.submit "プロフィールを作成", class: "px-4 py-2 text-sm font-medium text-white bg-[#00a968] rounded-md hover:bg-[#008f58] transition-colors" %>
    </div>
  <% end %>
</div>

<script>
  function previewImage(input) {
    const preview = document.getElementById('image-preview');
    const initialDisplay = document.getElementById('avatar-initial-display');
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
        initialDisplay.style.display = 'none';
      }
      reader.readAsDataURL(input.files[0]);
    }
  }
</script>-e \n--- END OF FILE ---\n
app/views/chat_rooms/index.html.erb
--- START OF FILE ---
<!-- app/views/chat_rooms/index.html.erb -->
<% content_for :sidebar do %>
  <%= render 'sidebar' %>
<% end %>

<div class="flex flex-col items-center justify-center h-[calc(100vh-12rem)] text-gray-400">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-4 opacity-20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
  </svg>
  <p class="text-sm italic">サイドバーからチャットルームを選択するか、新規作成してください。</p>
</div>-e \n--- END OF FILE ---\n
app/views/chat_rooms/_sidebar.html.erb
--- START OF FILE ---
<!-- app/views/chat_rooms/_sidebar.html.erb -->
<div class="space-y-4">
  <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider px-3 mb-2">Chat</p>
  <%# 新規ルーム作成ボタン %>
  <div class="px-2">
    <%= link_to new_chat_room_path, class: "flex items-center justify-center w-full py-2 px-4 bg-[#00a968] text-white text-xs font-bold rounded-xl hover:bg-[#008f58] transition-all shadow-sm" do %>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      新規ルーム作成
    <% end %>
  </div>

  <%# ルーム一覧 %>
  <div class="mt-4">
    <div class="space-y-1">
      <%# current_profile が参加しているルームを取得 %>
      <%# ※ ChatMembership モデルを介して取得する想定 %>
      <% chat_rooms = ChatRoom.joins(:room_memberships).where(room_memberships: { profile_id: current_profile.id }).order(updated_at: :desc) %>
      
      <% if chat_rooms.any? %>
      <% chat_rooms.each do |room| %>
        <%= link_to chat_room_path(room), 
            class: "flex items-center p-2 rounded-lg hover:bg-gray-100 #{'bg-gray-100' if current_page?(chat_room_path(room))}" do %>
          <%# アイコン表示 (avatar_tag など自作していればそれを使う) %>
          <div class="w-10 h-10 bg-gray-200 rounded-lg flex-shrink-0 mr-3">
            <% if room.avatar.attached? %>
              <%= image_tag room.avatar, class: "w-full h-full object-cover rounded-lg" %>
            <% end %>
          </div>
          <span class="text-sm font-medium text-gray-700 truncate"><%= room.display_name %></span>
        <% end %>
      <% end %>
      <% else %>
        <p class="px-3 py-4 text-xs italic text-gray-400">参加中のルームはありません</p>
      <% end %>
    </div>
  </div>
</div>-e \n--- END OF FILE ---\n
app/views/chat_rooms/edit.html.erb
--- START OF FILE ---
<!-- app/views/chat_rooms/edit.html.erb -->
<%# 通知メッセージの表示（alertも追加） %>
<div class="space-y-4 mb-4">
  <% if flash[:notice] %>
    <div class="p-4 bg-green-50 border border-green-200 text-green-700 rounded-lg">
      <%= flash[:notice] %>
    </div>
  <% end %>
  <% if flash[:alert] %>
    <div class="p-4 bg-red-50 border border-red-200 text-red-700 rounded-lg">
      <%= flash[:alert] %>
    </div>
  <% end %>
</div>

<% content_for :sidebar do %>
  <%= render 'sidebar' %>
<% end %>

<div class="max-w-2xl mx-auto">
  <div class="pb-5 border-b border-gray-200 mb-6 flex justify-between items-end">
    <h3 class="text-lg leading-6 font-medium text-gray-900">ルーム設定とメンバー管理</h3>
    <%= link_to "ルームへ戻る", chat_room_path(@chat_room), class: "text-sm text-[#00a968] hover:underline" %>
  </div>

  <%# ルーム基本設定の編集（ここはそのまま） %>
    <section class="mb-10 bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
    <h4 class="text-sm font-bold text-gray-400 mb-4 uppercase tracking-wider">基本設定</h4>
    <%= form_with(model: @chat_room, class: "space-y-6") do |f| %>
        
        <%# アイコン変更エリア %>
        <div class="flex flex-col items-center py-4 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
        <div id="icon-preview-container" 
            onclick="document.getElementById('chat-room-avatar-input').click();" 
            class="relative cursor-pointer group">
            
            <%# 現在のアイコンまたはプレースホルダーを表示 %>
            <div id="icon-current-display">
            <% if @chat_room.avatar.attached? %>
                <%= image_tag @chat_room.avatar, id: "current-image", class: "w-[120px] h-[120px] rounded-xl object-cover shadow-sm" %>
            <% else %>
                <div class="w-[120px] h-[120px] bg-gray-200 rounded-xl flex items-center justify-center text-gray-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                </svg>
                </div>
            <% end %>
            </div>

            <%# プレビュー用の隠しimgタグ %>
            <img id="image-preview" src="#" alt="Preview" 
                style="display: none; width: 120px; height: 120px; border-radius: 0.75rem; object-fit: cover;">
            
            <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
            <span class="text-xs text-white bg-black/50 px-2 py-1 rounded">画像を変更</span>
            </div>
        </div>
        
        <%= f.file_field :avatar, id: "chat-room-avatar-input", accept: 'image/*', onchange: "previewImage(this);", class: "hidden" %>
        <p class="text-[10px] text-gray-500 mt-2">クリックしてルームアイコンを変更</p>
        </div>

        <div>
        <%= f.label :display_name, "ルーム名", class: "block text-sm font-medium text-gray-700" %>
        <%= f.text_field :display_name, class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-[#00a968] focus:border-[#00a968]" %>
        </div>

        <div class="flex justify-end">
        <%= f.submit "変更を保存", class: "px-4 py-2 text-sm font-medium text-white bg-[#00a968] rounded-md hover:bg-[#008f58] transition-colors" %>
        </div>
    <% end %>
    </section>

  <%# メンバー追加セクション（チーム機能を参考に上書き） %>
  <div class="mb-10 pt-8 border-t border-gray-200">
    <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden shadow-sm">
      <div class="p-6">
        <h4 class="text-lg font-bold text-gray-900 mb-1">メンバーを直接追加</h4>
        <p class="text-sm text-gray-500 mb-6">プロフィールIDを入力して、即座にメンバーとして追加します。</p>

        <%= form_with url: chat_room_room_memberships_path(@chat_room), method: :post, class: "flex flex-col gap-4" do |f| %>
          <div class="flex flex-col sm:flex-row gap-4">
            <div class="flex-grow">
              <%= f.text_field :profile_id, 
                  placeholder: "例: ajnz6dem", 
                  class: "block w-full border-gray-300 rounded-xl shadow-sm focus:ring-[#00a968] focus:border-[#00a968] py-3 text-sm font-mono uppercase" %>
            </div>
            
            <div class="flex items-center gap-4 px-2">
              <label class="inline-flex items-center cursor-pointer">
                <%= f.radio_button :role, "member", checked: true, class: "text-[#00a968] focus:ring-[#00a968]" %>
                <span class="ml-2 text-sm text-gray-600">一般</span>
              </label>
              <label class="inline-flex items-center cursor-pointer">
                <%= f.radio_button :role, "admin", class: "text-[#00a968] focus:ring-[#00a968]" %>
                <span class="ml-2 text-sm text-gray-600">管理者</span>
              </label>
            </div>

            <%= f.submit "追加を実行", class: "px-6 py-3 bg-[#00a968] text-white font-bold rounded-xl hover:bg-[#008f58] transition-colors cursor-pointer" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <%# 参加メンバーリスト（上書き） %>
  <section class="bg-white shadow overflow-hidden rounded-2xl border border-gray-200">
    <div class="px-4 py-3 border-b border-gray-200 bg-gray-50">
      <h4 class="text-sm font-bold text-gray-700">現在の参加メンバー</h4>
    </div>
    <ul role="list" class="divide-y divide-gray-200">
      <% @chat_room.room_memberships.includes(:profile).each do |membership| %>
        <li class="px-4 py-4 flex items-center hover:bg-gray-50 transition-colors">
          <div class="min-w-0 flex-1 flex items-center">
            <div class="flex-shrink-0">
              <%# 既存のヘルパー profile_avatar_tag を利用 %>
              <%= profile_avatar_tag(membership.profile, class: "h-10 w-10 border border-gray-100", size: 40) %>
            </div>
            <div class="min-w-0 flex-1 px-4 flex items-center justify-between">
              <div>
                <p class="text-sm font-bold text-[#00a968] truncate"><%= membership.profile.name %></p>
                <p class="text-[10px] text-gray-400 font-mono italic">ID: <%= membership.profile.profile_id %></p>
              </div>
              <div>
                <% if membership.admin? %>
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800 border border-amber-200">管理者</span>
                <% else %>
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border border-blue-200">一般</span>
                <% end %>
              </div>
            </div>
          </div>
          
          <%# 自分自身は解除できないように制御 %>
          <% if membership.profile != current_profile %>
            <div class="ml-4">
              <%= button_to chat_room_room_membership_path(@chat_room, membership), 
                            method: :delete, 
                            data: { confirm: "#{membership.profile.name}さんをルームから解除しますか？" },
                            class: "text-gray-400 hover:text-red-500 transition-colors" do %>
                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              <% end %>
            </div>
          <% end %>
        </li>
      <% end %>
    </ul>
  </section>
</div>

<script>
  function previewImage(input) {
    const preview = document.getElementById('image-preview');
    const currentDisplay = document.getElementById('icon-current-display');
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
        currentDisplay.style.display = 'none';
      }
      reader.readAsDataURL(input.files[0]);
    }
  }
</script>-e \n--- END OF FILE ---\n
app/views/chat_rooms/show.html.erb
--- START OF FILE ---
<!-- app/views/chat_rooms/shw.html.erb -->
<% content_for :sidebar do %>
  <%= render 'sidebar' %>
<% end %>

<% my_current_profile = current_profile %>

<style>
  main { overflow: hidden !important; height: 100% !important; }
  main > div { padding: 0 !important; max-width: none !important; height: 100% !important; }
  
  .slack-scrollbar::-webkit-scrollbar { width: 8px; }
  .slack-scrollbar::-webkit-scrollbar-track { background: transparent; }
  .slack-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 4px; }
  
  .chat-layout-container { display: flex; width: 100%; height: 100%; overflow: hidden; }
  .main-chat-area { flex: 1; display: flex; flex-direction: column; min-width: 0; transition: all 0.2s ease-in-out; }

  #thread_panel {
    width: 0; background: white; display: none; flex-direction: column; border-left: 1px solid #e5e7eb; transition: width 0.2s ease-in-out;
  }
  #thread_panel.show { width: 400px; display: flex; }
  .draft-dropdown { z-index: 100; }
</style>

<div class="chat-layout-container" id="chat_container" data-open-thread-id="<%= params[:thread_id] %>">
  <div class="main-chat-area">
    <header class="flex-shrink-0 h-16 px-6 border-b border-gray-200 flex justify-between items-center bg-white z-10">
      <div class="flex items-center gap-3">
        <%= profile_avatar_tag(@chat_room, class: "h-8 w-8 rounded-lg object-cover", size: 32) %>
        <h2 class="font-black text-gray-900 text-lg truncate"><%= @chat_room.display_name %></h2>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-xs text-gray-400 mr-2 font-medium"><%= @chat_room.profiles.count %> 人のメンバー</span>
        <%= link_to edit_chat_room_path(@chat_room), class: "p-2 hover:bg-gray-100 rounded-full text-gray-500" do %>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
        <% end %>
      </div>
    </header>

    <div class="flex-1 overflow-y-auto bg-white slack-scrollbar" id="messages_area">
      <div class="py-6">
        <% @chat_room.activities.room_messages.active.includes(:owner_profile, :actable).order(created_at: :asc).each do |activity| %>
          <% if activity.actable_type == 'RoomMessage' %>
            <% message = activity.actable %>
            <div class="flex items-start px-6 py-2 hover:bg-gray-50 transition-colors group relative">
              <div class="flex-shrink-0 mr-4 mt-1">
                <%= profile_avatar_tag(activity.owner_profile, class: "h-10 w-10 rounded shadow-sm", size: 40) %>
              </div>
              <div class="flex-1 min-w-0">
                <div class="flex items-baseline gap-2 mb-0.5">
                  <span class="font-black text-gray-900 text-[15px]"><%= activity.owner_profile.name %></span>
                  <span class="text-[11px] text-gray-400 font-medium"><%= activity.created_at.strftime("%H:%M") %></span>
                </div>
                <div class="text-gray-800 text-[15px] leading-relaxed break-words">
                  <%= simple_format(message.content, {}, wrapper_tag: "span") %>
                </div>

                <div class="flex items-center gap-3 mt-2">
                  <% user_liked = activity.like_activities.exists?(owner_profile: my_current_profile) %>
                  <%= button_to activity_likes_path(activity), method: :post, 
                      class: "flex items-center gap-1.5 px-2 py-0.5 rounded-full border transition-all #{user_liked ? 'bg-pink-50 border-pink-200 text-pink-500' : 'bg-gray-50 border-gray-100 text-gray-400 hover:border-gray-300'}" do %>
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 <%= 'fill-current' if user_liked %>" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" /></svg>
                      <% if (count = activity.like_activities.count) > 0 %><span class="text-[11px] font-bold"><%= count %></span><% end %>
                  <% end %>

                  <button onclick="openThread('<%= activity.id %>', '<%= message.id %>')" class="flex items-center gap-1 group/reply text-gray-400 hover:text-blue-500 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" /></svg>
                    <span class="text-[11px] font-bold"><%= (c = activity.comment_activities.count) > 0 ? "#{c} 件の返信を表示" : "返信" %></span>
                  </button>
                </div>
              </div>
              
              <%# 編集用ホバーアクション（Socialと同じ仕様で追加） %>
              <% if activity.owner_profile == my_current_profile %>
                <div class="absolute right-6 top-2 opacity-0 group-hover:opacity-100 transition-opacity">
                  <button type="button" onclick="setEditMode('<%= message.id %>', '<%= j message.content %>')" class="p-1.5 bg-white border border-gray-200 rounded shadow-sm text-gray-400 hover:text-gray-600 hover:bg-gray-50 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                  </button>
                </div>
              <% end %>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>

    <footer class="flex-shrink-0 px-6 py-4 border-t border-gray-100 bg-white">
      <%= form_with(model: [@chat_room, RoomMessage.new], id: "chat_form") do |f| %>
        <input type="hidden" name="message_id" id="editing_message_id" value="">
        <input type="hidden" name="commit_type" id="commit_type" value="publish">
        <input type="hidden" name="parent_activity_id" id="parent_activity_id" value="">
        
        <div id="edit_label" class="hidden text-[11px] font-bold text-[#00a968] mb-1 px-1 text-xs">編集/下書き再開中 (Escで解除)</div>
        <div id="reply_preview" class="hidden flex items-center justify-between mb-2 p-2 bg-blue-50 border border-blue-100 rounded text-[11px] text-blue-700">
          <span class="truncate">💬 <span id="reply_user_name"></span> へのスレッドに返信中</span>
          <button type="button" onclick="clearReplyMode()" class="text-blue-500 font-bold hover:text-blue-700">×</button>
        </div>

        <div class="border-2 border-gray-200 rounded-lg focus-within:border-[#00a968] transition-all bg-white shadow-sm">
          <%= f.text_area :content, placeholder: "メッセージを入力...", rows: 1, id: "message_textarea", class: "block w-full border-none focus:ring-0 py-3 px-4 text-[15px] resize-none min-h-[44px]" %>
          <div class="flex items-center justify-between px-2 py-1.5 bg-gray-50 border-t border-gray-100 text-[10px] text-gray-400">
            <span class="px-2"><strong>Shift + Enter</strong> で送信 / <strong>Esc</strong> で解除</span>
            
            <div class="flex items-center gap-2">
              <%# 下書きトレイ（Socialから移植） %>
              <% my_drafts = Activity.where(actable_type: 'RoomMessage', owner_profile: my_current_profile).draft.order(updated_at: :desc) %>
              <details class="relative group">
                <summary class="list-none cursor-pointer px-2 py-1 hover:bg-gray-200 rounded text-[10px] text-gray-600 font-bold flex items-center gap-1">
                  <span>下書き</span>
                  <span class="bg-gray-300 text-white px-1.5 rounded-full"><%= my_drafts.count %></span>
                </summary>
                <div class="absolute bottom-full right-0 mb-2 w-72 bg-white border border-gray-200 shadow-xl rounded-lg py-2 draft-dropdown">
                  <div class="px-3 py-1 border-b border-gray-50 text-[9px] font-bold text-gray-400 uppercase tracking-wider">保存済みの下書き</div>
                  <div class="max-h-60 overflow-y-auto slack-scrollbar">
                    <% if my_drafts.any? %>
                      <% my_drafts.each do |draft| %>
                        <div class="px-3 py-2 hover:bg-emerald-50 border-b border-gray-50 last:border-0 flex justify-between items-start gap-2">
                          <div class="flex-1 min-w-0 text-left">
                            <p class="text-[12px] text-gray-600 truncate leading-tight font-medium"><%= draft.actable.content.presence || "(本文なし)" %></p>
                            <p class="text-[9px] text-gray-400 mt-0.5"><%= draft.updated_at.strftime("%m/%d %H:%M") %></p>
                          </div>
                          <div class="flex items-center gap-2 shrink-0">
                            <button type="button" onclick="setEditMode('<%= draft.actable_id %>', '<%= j draft.actable.content %>')" class="text-[10px] text-[#00a968] font-bold hover:underline">再開</button>
                            <%= link_to chat_room_room_message_path(@chat_room, draft.actable), data: { turbo_method: :delete, turbo_confirm: "下書きを削除しますか？" }, class: "text-gray-300 hover:text-red-500 transition-colors" do %>
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            <% end %>
                          </div>
                        </div>
                      <% end %>
                    <% else %>
                      <div class="px-3 py-4 text-center text-xs text-gray-400 font-medium">下書きなし</div>
                    <% end %>
                  </div>
                </div>
              </details>

              <button type="button" onclick="submitAsDraft()" class="text-[10px] text-gray-500 font-bold px-2 py-1 hover:bg-gray-200 rounded transition-colors">下書き保存</button>
              <button type="submit" class="p-1.5 text-[#00a968] hover:bg-emerald-50 rounded-md transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9-2-9-18-9 18 9 2zm0 0v-8" /></svg>
              </button>
            </div>
          </div>
        </div>
      <% end %>
    </footer>
  </div>

  <div id="thread_panel" class="flex-shrink-0">
    <header class="h-16 px-6 border-b border-gray-200 flex justify-between items-center bg-gray-50 shrink-0">
      <h3 class="font-black text-gray-900">スレッド</h3>
      <button onclick="closeThread()" class="p-2 hover:bg-gray-200 rounded-full text-gray-500 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
    </header>
    <div id="thread_content" class="flex-1 overflow-y-auto p-6 slack-scrollbar bg-white"></div>
  </div>
</div>

<script>
  function adjustChatTextareaHeight(el) { if (!el) return; el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }

  function clearEditMode() {
    document.getElementById('editing_message_id').value = "";
    document.getElementById('edit_label').classList.add('hidden');
    const textarea = document.getElementById('message_textarea');
    textarea.value = "";
    adjustChatTextareaHeight(textarea);
  }

  function setEditMode(id, content) {
    clearReplyMode();
    const textarea = document.getElementById('message_textarea');
    document.getElementById('editing_message_id').value = id;
    textarea.value = content;
    document.getElementById('edit_label').classList.remove('hidden');
    textarea.focus();
    adjustChatTextareaHeight(textarea);
  }

  function submitAsDraft() {
    document.getElementById('commit_type').value = "draft";
    document.getElementById('chat_form').requestSubmit();
  }

  function initChat() {
    const textarea = document.getElementById('message_textarea');
    const form = document.getElementById('chat_form');
    const messagesArea = document.getElementById('messages_area');
    const container = document.getElementById('chat_container');

    if (!textarea || !form) return;

    const newTextarea = textarea.cloneNode(true);
    textarea.parentNode.replaceChild(newTextarea, textarea);
    const finalForm = document.getElementById('chat_form');

    if (messagesArea) messagesArea.scrollTop = messagesArea.scrollHeight;

    const openThreadId = container.dataset.openThreadId;
    if (openThreadId && openThreadId !== "") {
      const threadButton = document.querySelector(`button[onclick*="openThread('${openThreadId}'"]`);
      if (threadButton) { threadButton.click(); container.dataset.openThreadId = ""; }
    }

    newTextarea.addEventListener('input', function() { adjustChatTextareaHeight(this); });
    newTextarea.addEventListener('keydown', function(e) {
      if (e.isComposing) return;
      if (e.key === 'Enter' && e.shiftKey) {
        e.preventDefault();
        if (this.value.trim() !== "") {
          const submitBtn = finalForm.querySelector('button[type="submit"]');
          if (submitBtn) submitBtn.disabled = true;
          document.getElementById('commit_type').value = "publish";
          finalForm.requestSubmit();
        }
      }
      if (e.key === 'Escape') { clearEditMode(); clearReplyMode(); closeThread(); }
    });
  }

  async function openThread(activityId, messageId) {
    const panel = document.getElementById('thread_panel');
    const content = document.getElementById('thread_content');
    const container = document.getElementById('chat_container');
    panel.classList.add('show');
    content.innerHTML = '<div class="flex justify-center py-10"><div class="animate-spin h-5 w-5 border-2 border-emerald-500 border-t-transparent rounded-full"></div></div>';
    try {
      const response = await fetch(`/chat_rooms/<%= @chat_room.id %>/room_messages/${messageId}/thread`);
      content.innerHTML = await response.text();
      setReplyMode(activityId, "スレッド");
      const url = new URL(window.location);
      url.searchParams.set('thread_id', activityId);
      window.history.replaceState({}, '', url);
    } catch (e) { content.innerHTML = '<div class="p-6 text-red-500 text-sm font-bold">Error</div>'; }
  }

  function closeThread() {
    const panel = document.getElementById('thread_panel');
    if (panel) panel.classList.remove('show');
    clearReplyMode();
    const url = new URL(window.location);
    url.searchParams.delete('thread_id');
    window.history.replaceState({}, '', url);
  }

  function setReplyMode(activityId, userName) {
    clearEditMode();
    const parentInput = document.getElementById('parent_activity_id');
    const label = document.getElementById('reply_user_name');
    const preview = document.getElementById('reply_preview');
    const textarea = document.getElementById('message_textarea');
    if (parentInput) parentInput.value = activityId;
    if (label) label.innerText = userName;
    if (preview) preview.classList.remove('hidden');
    if (textarea) textarea.focus();
  }

  function clearReplyMode() {
    const parentInput = document.getElementById('parent_activity_id');
    const preview = document.getElementById('reply_preview');
    if (parentInput) parentInput.value = "";
    if (preview) preview.classList.add('hidden');
  }

  document.addEventListener("turbo:load", initChat);
  if (document.readyState !== "loading") initChat();
</script>-e \n--- END OF FILE ---\n
app/views/chat_rooms/new.html.erb
--- START OF FILE ---
<!-- app/views/chat_rooms/new.html.erb -->
<% content_for :sidebar do %>
  <%= render 'sidebar' %>
<% end %>

<div class="max-w-2xl mx-auto">
  <div class="pb-5 border-b border-gray-200 mb-6">
    <h3 class="text-lg leading-6 font-medium text-gray-900">新規チャットルームの作成</h3>
  </div>

  <%= form_with(model: @chat_room, class: "space-y-6") do |f| %>
    <%# ルームアイコン選択・プレビューセクション %>
    <div class="flex flex-col items-center py-4 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
      <div id="icon-preview-container" 
           onclick="document.getElementById('chat-room-icon-input').click();" 
           class="relative cursor-pointer group">
        <div id="icon-initial-display">
          <%# デフォルトはプレースホルダー画像などを表示（後ほどヘルパー等で調整可能） %>
          <div class="w-[120px] h-[120px] bg-gray-200 rounded-xl flex items-center justify-center text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
          </div>
        </div>
        <img id="image-preview" src="#" alt="Preview" 
             style="display: none; width: 120px; height: 120px; border-radius: 0.75rem; object-fit: cover;">
        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
          <span class="text-xs text-white bg-black/50 px-2 py-1 rounded">画像を選択</span>
        </div>
      </div>
      <%= f.file_field :avatar, id: "chat-room-icon-input", accept: 'image/*', onchange: "previewImage(this);", class: "hidden" %>
      <p class="text-xs text-gray-500 mt-2">ルームアイコンをアップロード</p>
    </div>

    <div>
      <%= f.label :name, "ルーム名", class: "block text-sm font-medium text-gray-700" %>
      <%= f.text_field :display_name, placeholder: "例: プロジェクトA 連絡用", class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-[#00a968] focus:border-[#00a968]" %>
    </div>

    <div class="flex justify-end gap-3 pt-4">
      <%= link_to "キャンセル", chat_rooms_path, class: "px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50" %>
      <%= f.submit "ルームを作成", class: "px-4 py-2 text-sm font-medium text-white bg-[#00a968] rounded-md hover:bg-[#008f58] transition-colors" %>
    </div>
  <% end %>
</div>

<script>
  function previewImage(input) {
    const preview = document.getElementById('image-preview');
    const initialDisplay = document.getElementById('icon-initial-display');
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
        initialDisplay.style.display = 'none';
      }
      reader.readAsDataURL(input.files[0]);
    }
  }
</script>-e \n--- END OF FILE ---\n
app/helpers/tasks_helper.rb
--- START OF FILE ---
module TasksHelper
end
-e \n--- END OF FILE ---\n
app/helpers/application_helper.rb
--- START OF FILE ---
# app/helpers/application_helper.rb
module ApplicationHelper
  def profile_avatar_tag(profile, options = {})
    # デフォルトのサイズを設定
    size = options.delete(:size) || 100
    # ビューから渡された class とデフォルトの角丸スタイルを結合
    img_class = "rounded-xl object-cover #{options[:class]}"

    if profile.avatar.attached?
      image_tag profile.avatar.variant(resize_to_fill: [ size, size ]),
                options.merge(class: img_class, style: "width: #{size}px; height: #{size}px; #{options[:style]}")
    else
      initial = profile.name.to_s[0]&.upcase || "?"
      content_tag :div, initial,
                  options.merge(
                    class: "#{img_class} bg-gray-400 flex items-center justify-center text-white font-bold",
                    style: "width: #{size}px; height: #{size}px; font-size: #{size / 2}px; #{options[:style]}"
                  )
    end
  end

  def team_avatar_tag(team, options = {})
    size = options.delete(:size) || 48 # デフォルト48px
    img_class = "rounded-xl object-cover #{options[:class]}"

    if team&.avatar&.attached?
      image_tag team.avatar.variant(resize_to_fill: [ size * 2, size * 2 ]),
                options.merge(class: img_class, style: "width: #{size}px; height: #{size}px; #{options[:style]}")
    else
      initial = team&.display_name&.first&.upcase || "T"
      content_tag :div, initial,
                  options.merge(
                    class: "#{img_class} bg-emerald-100 flex items-center justify-center text-emerald-600 font-bold",
                    style: "width: #{size}px; height: #{size}px; font-size: #{size / 2}px; #{options[:style]}"
                  )
    end
  end

  def status_color_class(status)
    case status.to_s
    when "todo", "0"
      "bg-amber-50 text-amber-600 border-amber-200"
    when "in_progress", "1"
      "bg-blue-50 text-blue-600 border-blue-200"
    when "done", "2"
      "bg-emerald-50 text-emerald-600 border-emerald-200"
    else
      "bg-gray-50 text-gray-600 border-gray-200"
    end
  end
end
-e \n--- END OF FILE ---\n
app/channels/application_cable/connection.rb
--- START OF FILE ---
module ApplicationCable
  class Connection < ActionCable::Connection::Base
  end
end
-e \n--- END OF FILE ---\n
app/channels/application_cable/channel.rb
--- START OF FILE ---
module ApplicationCable
  class Channel < ActionCable::Channel::Base
  end
end
-e \n--- END OF FILE ---\n
config/locales/en.yml
--- START OF FILE ---
# Files in the config/locales directory are used for internationalization and
# are automatically loaded by Rails. If you want to use locales other than
# English, add the necessary files in this directory.
#
# To use the locales, use `I18n.t`:
#
#     I18n.t "hello"
#
# In views, this is aliased to just `t`:
#
#     <%= t("hello") %>
#
# To use a different locale, set it with `I18n.locale`:
#
#     I18n.locale = :es
#
# This would use the information in config/locales/es.yml.
#
# To learn more about the API, please read the Rails Internationalization guide
# at https://guides.rubyonrails.org/i18n.html.
#
# Be aware that YAML interprets the following case-insensitive strings as
# booleans: `true`, `false`, `on`, `off`, `yes`, `no`. Therefore, these strings
# must be quoted to be interpreted as strings. For example:
#
#     en:
#       "yes": yup
#       enabled: "ON"

en:
  hello: "Hello world"
-e \n--- END OF FILE ---\n
config/locales/ja.yml
--- START OF FILE ---
# config/locales/ja.yml
ja:
  activerecord:
    models:
      task: "タスク"
      schedule: "予定"
    attributes:
      task:
        task_status: "ステータス"
      schedule:
        schedule_status: "予定状態"
      schedule_invitation:
        invitation_status: "招待状況"
        join_status: "回答"
    enums:
      task:
        task_status:
          todo: "未着手"
          "0": "未着手"
          in_progress: "進行中"
          "1": "進行中"
          done: "完了"
          "2": "完了"
          backlog: "保留"
          "3": "保留"
      schedule:
        schedule_status:
          confirmed: "確定"
          suggestion: "打診"
          canceled: "中止"
      schedule_invitation:
        invitation_status:
          pending: "保留"
          suggestion: "打診中"
          confirmed: "確定"
          canceled: "取消"
        join_status:
          pending: "未回答"
          approved: "参加"
          rejected: "不参加"-e \n--- END OF FILE ---\n
config/locales/devise.en.yml
--- START OF FILE ---
# Additional translations at https://github.com/heartcombo/devise/wiki/I18n

en:
  devise:
    confirmations:
      confirmed: "Your email address has been successfully confirmed."
      send_instructions: "You will receive an email with instructions for how to confirm your email address in a few minutes."
      send_paranoid_instructions: "If your email address exists in our database, you will receive an email with instructions for how to confirm your email address in a few minutes."
    failure:
      already_authenticated: "You are already signed in."
      inactive: "Your account is not activated yet."
      invalid: "Invalid %{authentication_keys} or password."
      locked: "Your account is locked."
      last_attempt: "You have one more attempt before your account is locked."
      not_found_in_database: "Invalid %{authentication_keys} or password."
      timeout: "Your session expired. Please sign in again to continue."
      unauthenticated: "You need to sign in or sign up before continuing."
      unconfirmed: "You have to confirm your email address before continuing."
    mailer:
      confirmation_instructions:
        subject: "Confirmation instructions"
      reset_password_instructions:
        subject: "Reset password instructions"
      unlock_instructions:
        subject: "Unlock instructions"
      email_changed:
        subject: "Email Changed"
      password_change:
        subject: "Password Changed"
    omniauth_callbacks:
      failure: "Could not authenticate you from %{kind} because \"%{reason}\"."
      success: "Successfully authenticated from %{kind} account."
    passwords:
      no_token: "You can't access this page without coming from a password reset email. If you do come from a password reset email, please make sure you used the full URL provided."
      send_instructions: "You will receive an email with instructions on how to reset your password in a few minutes."
      send_paranoid_instructions: "If your email address exists in our database, you will receive a password recovery link at your email address in a few minutes."
      updated: "Your password has been changed successfully. You are now signed in."
      updated_not_active: "Your password has been changed successfully."
    registrations:
      destroyed: "Bye! Your account has been successfully cancelled. We hope to see you again soon."
      signed_up: "Welcome! You have signed up successfully."
      signed_up_but_inactive: "You have signed up successfully. However, we could not sign you in because your account is not yet activated."
      signed_up_but_locked: "You have signed up successfully. However, we could not sign you in because your account is locked."
      signed_up_but_unconfirmed: "A message with a confirmation link has been sent to your email address. Please follow the link to activate your account."
      update_needs_confirmation: "You updated your account successfully, but we need to verify your new email address. Please check your email and follow the confirmation link to confirm your new email address."
      updated: "Your account has been updated successfully."
      updated_but_not_signed_in: "Your account has been updated successfully, but since your password was changed, you need to sign in again."
    sessions:
      signed_in: "Signed in successfully."
      signed_out: "Signed out successfully."
      already_signed_out: "Signed out successfully."
    unlocks:
      send_instructions: "You will receive an email with instructions for how to unlock your account in a few minutes."
      send_paranoid_instructions: "If your account exists, you will receive an email with instructions for how to unlock it in a few minutes."
      unlocked: "Your account has been unlocked successfully. Please sign in to continue."
  errors:
    messages:
      already_confirmed: "was already confirmed, please try signing in"
      confirmation_period_expired: "needs to be confirmed within %{period}, please request a new one"
      expired: "has expired, please request a new one"
      not_found: "not found"
      not_locked: "was not locked"
      not_saved:
        one: "1 error prohibited this %{resource} from being saved:"
        other: "%{count} errors prohibited this %{resource} from being saved:"
-e \n--- END OF FILE ---\n
config/routes.rb
--- START OF FILE ---
# config/routes.rb
Rails.application.routes.draw do
  # controllers オプションを追加
  devise_for :users, controllers: {
    registrations: "users/registrations",
    sessions: "users/sessions"
  }

  authenticated :user do
    root "tasks#index", as: :authenticated_root
    resources :tasks, only: [ :index, :create, :update, :edit ]
    resources :schedules, only: [ :edit, :update, :create ]
    resources :works, only: [ :index, :new, :create, :edit, :update, :destroy, :show ]
  end

  root to: redirect("/users/sign_in")

  # Activities用のルーティング
  resources :activities, only: [ :destroy ] do
    resources :comments, only: [ :create, :destroy ]
    resources :likes, only: [ :create, :destroy ]
  end

  # Chat_room用のルーティング
  resources :chat_rooms do
    resources :room_memberships, only: [ :create, :destroy ]
    # room_messagesに member ブロックを追加
    resources :room_messages, only: [ :create, :update, :destroy ] do
      member do
        get :thread
      end
    end
  end

  # SocialPost用のルーティング
  resources :social_posts, only: [ :index, :create, :update, :destroy ] do
    member do
      post :repost
      get :thread
    end
  end

  # Profile用のルーティング
  resources :profiles do
    member do
      patch :switch # /profiles/:id/switch
    end
  end

  # Team用のルーティング
  resource :team, only: [ :new, :create, :edit, :update ] do
    get :members
    resources :invitations, only: [ :create ], controller: "team_invitations" do
      collection do
        get :search
      end
      member do
        patch :cancel
        patch :accept
        patch :reject
      end
    end
  end

  # Schedule用のルーティング
  resources :schedule_invitations, only: [ :update ]

  # ゲストログイン用のルーティング
  devise_scope :user do
    post 'guest_sign_in', to: 'users/sessions#guest_sign_in'
  end
end
-e \n--- END OF FILE ---\n
