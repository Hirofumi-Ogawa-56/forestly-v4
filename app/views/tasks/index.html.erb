<!-- app/views/tasks/index.html.erb -->
<% content_for :sidebar do %>
  <%= render 'sidebar' %>
<% end %>

<div class="flex flex-col h-full bg-white" x-data="{ open_form: null }">
  <%# --- Header: 左右の余白を適切に維持 --- %>
  <header class="bg-white border-b border-gray-100 px-8 py-4 flex justify-between items-center shrink-0">
    <h2 class="text-xl font-bold text-gray-900">
      <%= case params[:filter]
          when 'today' then '今日の予定'
          when 'week'  then '今週の予定'
          when 'todo'  then '未完了タスク'
          else '全てのタスク & スケジュール'
          end %>
    </h2>

    <div class="flex gap-2">
      <button type="button" @click="open_form = (open_form === 'task' ? null : 'task')" 
              :class="open_form === 'task' ? 'bg-emerald-100 text-emerald-700' : 'bg-emerald-600 text-white'"
              class="px-4 py-2 rounded-lg text-sm font-bold transition-all">新規タスク</button>
      <button type="button" @click="open_form = (open_form === 'schedule' ? null : 'schedule')" 
              :class="open_form === 'schedule' ? 'bg-blue-100 text-blue-700' : 'bg-blue-600 text-white'"
              class="px-4 py-2 rounded-lg text-sm font-bold transition-all">新規スケジュール</button>
    </div>
  </header>

  <div class="flex-1 overflow-y-auto">
    <%# --- Form Area: フォーム時のみ内側に少し余白 --- %>
    <div class="w-full">
      <div x-show="open_form === 'task'" x-cloak x-transition class="border-b-2 border-emerald-500 bg-emerald-50/30 p-8">
        <div class="max-w-4xl mx-auto">
          <h3 class="text-sm font-bold text-emerald-600 mb-4 uppercase tracking-widest">Create New Task</h3>
          <%= render 'components/task_form', task: @task %>
        </div>
      </div>

      <div x-show="open_form === 'schedule'" x-cloak x-transition class="border-b-2 border-blue-500 bg-blue-50/30 p-8">
        <div class="max-w-4xl mx-auto">
          <h3 class="text-sm font-bold text-blue-600 mb-4 uppercase tracking-widest">Create New Schedule</h3>
          <%= render 'components/schedule_form', schedule: @schedule %>
        </div>
      </div>

      <%# --- List Area: 枠を排除し、横幅いっぱいに展開 --- %>
      <div class="w-full">
        <%# --- Table Header --- %>
        <div class="grid grid-cols-12 gap-0 px-8 py-3 bg-gray-50 border-b border-gray-100 text-[10px] font-bold text-gray-400 uppercase tracking-widest">
          <div class="col-span-1 flex justify-center">Type</div>
          <div class="col-span-3">Title</div>
          <div class="col-span-1 text-center">Status</div>
          <div class="col-span-2 text-center">Date & Time</div>
          <div class="col-span-2 text-center">Assignnes / Invitees</div>
          <div class="col-span-2 text-center">Owner</div>
          <div class="col-span-1 flex justify-center text-rose-300">Del</div>
        </div>

        <%# --- Table Body --- %>
        <div class="divide-y divide-gray-100">
          <% if @activities.any? %>
            <% @activities.each do |activity| %>
              <% item = activity.actable %>
              <turbo-frame id="<%= dom_id(activity) %>">
                <div class="grid grid-cols-12 gap-0 px-8 py-4 items-center hover:bg-gray-50 transition-colors group text-sm">
                
                <%# 1. Type %>
                <div class="col-span-1 flex justify-center">
                  <% if item.is_a?(Task) %>
                    <span class="text-[9px] font-black px-1.5 py-0.5 rounded border border-emerald-200 bg-emerald-50 text-emerald-600 tracking-tighter">Task</span>
                  <% else %>
                    <span class="text-[9px] font-black px-1.5 py-0.5 rounded border border-blue-200 bg-blue-50 text-blue-600 tracking-tighter">Sched</span>
                  <% end %>
                </div>

                <%# 2. Title %>
                <div class="col-span-3 pr-4">
                  <% if activity.editable_by?(@current_profile) %>
                    <%# edit_task_path または edit_schedule_path へのリンク %>
                    <%= link_to edit_polymorphic_path(item), data: { turbo_frame: dom_id(activity) } do %>
                      <p class="font-bold text-gray-900 truncate hover:text-blue-600"><%= activity.title %></p>
                    <% end %>
                  <% else %>
                    <p class="font-bold text-gray-900 truncate"><%= activity.title %></p>
                  <% end %>
                  <p class="text-[11px] text-gray-400 truncate mt-0.5"><%= item.describe %></p>
                </div>

                <%# 3. Status (col-span-1) %>
                <div class="col-span-1 flex justify-center text-center">
                  <% if item.is_a?(Task) %>
                    <%# --- Task ステータス --- %>
                    <%= form_with model: item, local: true do |f| %>
                      <%= f.select :task_status, 
                                  Task.task_statuses.keys.map { |s| [Task.task_statuses_i18n[s], s] }, 
                                  {}, 
                                  { onchange: "this.form.requestSubmit()", 
                                    class: "text-[10px] font-bold border-0 bg-transparent focus:ring-0 cursor-pointer p-0 #{status_color_class(item.task_status)}" } %>
                    <% end %>
                  <% else %>
                    <%# --- Schedule 招待状況 --- %>
                    <% my_invitation = item.schedule_invitations.find { |inv| inv.profile_id == @current_profile.id } %>
                    <% if my_invitation %>
                      <%= form_with model: my_invitation, local: true do |f| %>
                        <div class="flex flex-col items-center leading-tight">
                          <span class="text-[9px] font-black text-blue-600 uppercase mb-0.5">
                            <%= Schedule.schedule_statuses_i18n[item.schedule_status] %>
                          </span>
                          <%= f.select :join_status, 
                                      ScheduleInvitation.join_statuses.keys.map { |s| [ScheduleInvitation.join_statuses_i18n[s], s] }, 
                                      {}, 
                                      { onchange: "this.form.requestSubmit()", 
                                        class: "text-[10px] font-bold border-0 bg-transparent focus:ring-0 cursor-pointer p-0 #{my_invitation.join_status_approved? ? 'text-emerald-500' : 'text-amber-500'}" } %>
                        </div>
                      <% end %>
                    <% end %>
                  <% end %>
                </div>

                <%# 4. Date & Time (col-span-2) %>
                <div class="col-span-2 text-center">
                  <% if item.is_a?(Task) %>
                    <span class="text-[12px] font-medium text-gray-600"><%= item.deadline&.strftime("%m/%d %H:%M") %></span>
                  <% else %>
                    <span class="text-[12px] font-bold text-blue-600"><%= item.start_at&.strftime("%m/%d %H:%M") %></span>
                  <% end %>
                </div>

                <%# 5. Members (col-span-2) %>
                <div class="col-span-2 flex justify-center -space-x-1.5 overflow-hidden">
                  <% (item.is_a?(Task) ? item.assignees : item.invitees).first(4).each do |profile| %>
                    <%= profile_avatar_tag(profile, size: 24, class: "ring-2 ring-white") %>
                  <% end %>
                </div>

                <%# 6. Owner (col-span-2) %>
                <div class="col-span-2 flex justify-center">
                  <div class="flex items-center gap-2 max-w-full">
                    <%= profile_avatar_tag(activity.owner_profile, size: 20) %>
                    <span class="text-[11px] text-gray-500 truncate"><%= activity.owner_profile.name %></span>
                  </div>
                </div>

                <%# 7. Action (col-span-1) %>
                <div class="col-span-1 flex justify-center">
                  <% if activity.owner_profile == @current_profile %>
                    <%= button_to activity_path(activity), 
                                  method: :delete, 
                                  data: { turbo_confirm: '本当に削除しますか？' }, 
                                  class: "text-[10px] font-bold text-gray-400 hover:text-rose-600 transition-colors py-1 px-2 rounded-md hover:bg-rose-50" do %>
                      削除
                    <% end %>
                  <% end %>
                </div>

              </div>
            <% end %>
          <% else %>
            <div class="py-20 text-center text-gray-300 font-medium">データはありません</div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>