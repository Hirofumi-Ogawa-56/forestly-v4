<!-- app/views/profiles/edit.html.erb -->
<% content_for :sidebar do %>
  <%= render 'sidebar' %>
<% end %>

<div class="max-w-2xl mx-auto">
  <div class="pb-5 border-b border-gray-200 mb-6">
    <h3 class="text-lg leading-6 font-medium text-gray-900">プロフィールの編集</h3>
  </div>

  <%= form_with(model: @profile, class: "space-y-6") do |f| %>
    <div class="flex flex-col gap-1">
      <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">プロフィールID</span>
      <div class="flex items-center gap-2">
        <code class="px-3 py-2 bg-gray-100 border border-gray-200 rounded-lg text-sm text-gray-600 font-mono select-all">
          <%= @profile.profile_id %>
        </code>
        <span class="text-[10px] text-gray-400 italic">※IDは変更できません</span>
      </div>
    </div>

    <div class="flex flex-col items-center py-4 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
      <div id="avatar-preview-container" 
           onclick="document.getElementById('profile-avatar-input').click();" 
           class="relative cursor-pointer group">
        <div id="avatar-initial-display">
          <%= profile_avatar_tag(@profile, size: 120) %>
        </div>
        <img id="image-preview" src="#" alt="Preview" 
             style="display: none; width: 120px; height: 120px; border-radius: 0.75rem; object-fit: cover;">
        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
          <span class="text-xs text-white bg-black/50 px-2 py-1 rounded">変更</span>
        </div>
      </div>
      <%= f.file_field :avatar, id: "profile-avatar-input", accept: 'image/*', onchange: "previewImage(this);", class: "hidden" %>
      <p class="text-xs text-gray-500 mt-2">クリックして画像をアップロード</p>
    </div>

    <div>
      <%= f.label :name, "表示名", class: "block text-sm font-medium text-gray-700" %>
      <%= f.text_field :name, class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-[#00a968] focus:border-[#00a968]" %>
    </div>

    <div>
      <%= f.label :label, "ラベル", class: "block text-sm font-medium text-gray-700" %>
      <%= f.text_field :label, class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-[#00a968] focus:border-[#00a968]" %>
    </div>

    <div class="flex justify-end gap-3">
      <%= link_to "キャンセル", profiles_path, class: "px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50" %>
      <%= f.submit "保存する", class: "px-4 py-2 text-sm font-medium text-white bg-[#00a968] rounded-md hover:bg-[#008f58] transition-colors" %>
    </div>

    <div>
        <% if current_user.profiles.count > 1 %>
            <%= link_to "プロフィールを削除", profile_path(@profile), 
                data: { turbo_method: :delete, turbo_confirm: "本当にこのプロフィールを削除しますか？" }, 
                class: "text-sm text-red-600 hover:text-red-800 transition-colors" %>
        <% end %>
    </div>
  <% end %>

  <!-- 招待承認セクション -->
  <div class="mt-12 pt-8 border-t border-gray-200">
    <h3 class="text-lg font-bold text-gray-900 mb-4">チームへの招待</h3>
    <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden shadow-sm">
      <%# 3.5行分の高さを維持しスクロール可能にする %>
      <div class="overflow-y-auto" style="height: 224px;">
        <%# ログイン中のプロフィール宛の「保留中」招待を取得 %>
        <% invitations = TeamMembershipRequest.where(profile: @profile, status: :pending).order(created_at: :desc) %>
        
        <% if invitations.present? %>
          <ul class="divide-y divide-gray-100">
            <% invitations.each do |invite| %>
              <li class="p-4 hover:bg-gray-50 transition-colors">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                  <div class="flex items-start gap-3">
                    <%# 招待元のチームアイコン %>
                    <%= team_avatar_tag(invite.team, class: "h-10 w-10 rounded-lg shadow-sm") %>
                    <div>
                      <div class="flex items-center gap-2">
                        <p class="text-sm font-bold text-gray-900"><%= invite.team.display_name %></p>
                        <span class="text-[10px] px-2 py-0.5 rounded-full bg-gray-100 text-gray-600 font-medium">
                          <%= invite.role_i18n %>として招待
                        </span>
                      </div>
                      <p class="text-[11px] text-gray-500 mt-1">
                        招待者: <%= invite.team.profiles.find_by(team_role: :admin)&.name || "管理者" %> 
                        <span class="mx-1">•</span> 
                        <%= invite.created_at.strftime("%Y/%m/%d %H:%M") %>
                      </p>
                    </div>
                  </div>

                  <div class="flex items-center gap-2">
                    <% if current_profile.team.present? %>
                      <div class="group relative">
                        <button class="px-4 py-2 bg-gray-100 text-gray-400 text-xs font-bold rounded-lg cursor-not-allowed" disabled>
                          承認不可
                        </button>
                        <span class="absolute bottom-full mb-2 hidden group-hover:block w-48 bg-gray-800 text-white text-[10px] p-2 rounded shadow-lg">
                          既に他のチームに所属しているため、この招待を承認するには現在のチームを抜ける必要があります。
                        </span>
                      </div>
                    <% else %>
                      <%= button_to "承認する", accept_team_invitation_path(invite), method: :patch, 
                          class: "px-4 py-2 bg-[#00a968] text-white text-xs font-bold rounded-lg hover:bg-[#008f58] transition-colors" %>
                    <% end %>

                    <%= button_to "辞退", reject_team_invitation_path(invite), method: :patch, 
                        data: { confirm: "この招待を辞退しますか？" },
                        class: "px-4 py-2 border border-gray-200 text-gray-600 text-xs font-bold rounded-lg hover:bg-gray-50 transition-colors" %>
                  </div>
                </div>
              </li>
            <% end %>
          </ul>
        <% else %>
          <div class="flex flex-col items-center justify-center h-full text-gray-400 py-10">
            <svg class="w-8 h-8 mb-2 opacity-20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
            </svg>
            <p class="text-xs italic">現在、チームからの招待は届いていません。</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>

</div>

<%# サインアップ画面と同じプレビューJSが必要な場合は、ここに追加するか共通JS化します %>
<script>
  function previewImage(input) {
    const preview = document.getElementById('image-preview');
    const initialDisplay = document.getElementById('avatar-initial-display');
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
        initialDisplay.style.display = 'none';
      }
      reader.readAsDataURL(input.files[0]);
    }
  }
</script>